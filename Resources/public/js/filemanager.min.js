"use_strict";"use strict";var FileTree=function(a){var b={debug:!1};this.options=$.extend(!0,b,a),this.init(this.options)};FileTree.prototype={_debug:!1,_root:{children:{}},_currentPath:"",_currentFiles:[],_currentContentSort:null,_reverse:!1,_walk_itteration:0,_eventHandler:null,init:function(a){return null!==a&&"object"==typeof a&&(this._debug=a.debug,this._eventHandler=a.eventHandler,this._registerEvents()),this._currentContentSort=this._naturalFilemanagerSort,this.debug("Initializing"),this.debug(a),this},addFiles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];this._setFile(e)}this.debug("Tree structure after updating"),this.debug(this._root),1==b&&this._updateViews(!0,!1,!1)},setContents:function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.path=this._formatPath(e.path,!0),e.directory=this._formatPath(e.directory),b.push(e)}this._currentFiles=b},_setFile:function(a){0==a.hasOwnProperty("path")&&(a.path=this._formatPath(a.directory)+a.name),a.path=this._formatPath(a.path,!0),a.directory=this._formatPath(a.directory),0==a.hasOwnProperty("children")&&(a.children={});var b=this._findNode(a.directory);"undefined"==typeof b.children[a.name]?b.children[a.name]=a:b.children[a.name]=$.extend(!0,b.children[a.name],a)},_findNode:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];"undefined"==typeof c.children[f]&&(c.children[f]=this._generateNode(f,b)),c=c.children[f]}return"undefined"==typeof c.children&&(c.children={}),c},_generateNode:function(a,b){var c={};c.name=a;for(var d="",e=0;e<b.length&&(d+=b[e]+"/",b[e+1]!=a);e++);return c.directory=d,c.path=d+a,c.children={},c},_extractPathNodes:function(a){"string"!=typeof a&&(a="");for(var b=a.split("/"),c=[],d=0,e=b.length;e>d;d++)""!==b[d]&&c.push(b[d]);return c},addChanges:function(a,b){if("undefined"!=typeof a||!a)for(var c=0,d=a.length;d>c;c++)this._executeChange(a[c]);this.debug("Tree structure after updating"),this.debug(this._root),this.debug("Updating the current files"),this.openPath(this._currentPath,!1),this.debug(this._currentFiles),b&&this._updateViews(!0,!0,!0)},_executeChange:function(a){switch(a.type){case"delete":this._deleteNode(a.file);break;case"create":this._setFile(a.file);break;case"update":case"rename":case"move":this._updateNode(a.file,a.updatedfile)}},_updateNode:function(a,b){var c=this._findNodeIfExists(a.directory);if(c!==!1||"undefined"!=typeof c.children[a.name]){var d=c.children[a.name],e=this._formatPath(d.path);b.path=b.directory+b.name;var f=$.extend(!0,d,b),g=this._formatPath(b.path);e!=g&&(f=this._updateChildPaths(f),this._deleteNode(a)),this._setFile(f)}},_updateChildPaths:function(a){if("undefined"!=typeof a.children){var b=[];for(var c in a.children)b.push(c);for(var d=0,e=b.length;e>d;d++)if("undefined"!=typeof a.children[b[d]]){var f=a.children[b[d]];f.directory=this._formatPath(a.path),f.path=this._formatPath(a.path)+f.name,a.children[b[d]]=this._updateChildPaths(f)}}return a},_formatPath:function(a,b){return"undefined"==typeof a&&(a=""),0!==a.length&&"/"==a.substr(0,1)&&(a=a.substr(1,a.length-1)),b!==!0&&0!==a.length&&"/"!=a.substr(a,a.length-1)&&(a+="/"),a=a.replace(/\/\/+/g,"/")},_deleteNode:function(a){var b=this._findNodeIfExists(a.directory);b!==!1&&delete b.children[a.name]},_findNodeIfExists:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];if("undefined"==typeof c.children[f]){c=!1;break}c=c.children[f]}return c},flattenTree:function(a){var b=this.toJstreeData(this._root.children,a);return this._walk_itteration=0,this.debug("JsTree data updated"),this.debug(b),b},toJstreeData:function(a,b){"undefined"==typeof a&&(a=this._root.children);var c=[];for(var d in a){var e=a[d];if(!b||b===!0&&("undefined"==typeof e.type||"dir"===e.type)){this._walk_itteration++;var f={text:e.name};if(f.li_attr={id:"js_tree_file_"+this._walk_itteration,"data-path":e.path,"data-synchronized":"undefined"==typeof e._generated},f.state={opened:this._isOpenedDirectory(e),selected:!1,disabled:"undefined"!=typeof e.disabled&&1==e.disabled},"object"==typeof e.children&&null!==e.children){var g=[];for(var h in e.children)g.push(h);g.length>0&&(f.children=this.toJstreeData(e.children,b))}c.push(f)}}return c},openPath:function(a,b){this._currentPath=a;var c=this._findNodeIfExists(a);if(c===!1)this._currentPath=a,this._currentFiles=[];else if(""!==a&&c==this._root)this._currentFiles=[];else{var d=[];for(var e in c.children)d.push(c.children[e]);this.setContents(d)}b&&this._updateViews(!0,!0,!0)},_isOpenedDirectory:function(a){for(var b=this._extractPathNodes(this._currentPath),c=this._extractPathNodes(this._formatPath(a.path)),d=!1,e=0,f=c.length;f>e;e++)d=b[e]===c[e];return d},_naturalFilemanagerSort:function(a,b){var c=a.type,d=b.type;return"dir"==c&&"dir"!=d?-1:"dir"!=c&&"dir"==d?1:String(a.name).toLowerCase()<String(b.name).toLowerCase()?-1:String(a.name).toLowerCase()>String(b.name).toLowerCase()?1:0},sortContent:function(a){"function"!=typeof a&&(a=this._naturalFilemanagerSort),String(this._currentContentSort)==String(a)?this._reverse=!this._reverse:this._reverse=!1,this._currentContentSort=a,this._updateViews(!1,!0,!1)},resetSort:function(){this.sortContent(this._naturalFilemanagerSort)},_updateViews:function(a,b,c){1==a&&this._eventHandler.trigger("filemanager:model:directories_changed",this.flattenTree(!0)),1==b&&(this._currentFiles.sort(this._currentContentSort),this._reverse&&this._currentFiles.reverse(),this._eventHandler.trigger("filemanager:model:content_changed",this._currentFiles)),1==c&&this._eventHandler.trigger("filemanager:model:path_changed",this._currentPath)},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},debug:function(a){"string"==typeof a&&(a="FileTree: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:add_data",function(b){a.addFiles(b.contents),a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:api:update_data",function(b){a.addChanges(b.contents,!0),1==b.selected&&a._eventHandler.trigger("filemanager:model:select",{file:b.contents[0].file})}),this._eventHandler.register("filemanager:api:search_data",function(b){a.setContents(b.contents),a._updateViews(!1,!0,!1)}),this._eventHandler.register("filemanager:view:directory_up",function(b){a.moveUpDirectory()}),this._eventHandler.register("filemanager:view:sort",function(b){void 0!==b&&"function"==typeof b.sortfunction?a.sortContent(b.sortfunction):a.sortContent()}),this._eventHandler.register("filemanager:view:open",function(b){b.isSynchronized&&a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:view:refresh",function(b){a.refresh()}),this._eventHandler.register("filemanager:api:refresh",function(b){a.refresh()})},refresh:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._currentPath,isSynchronized:!1})},moveUpDirectory:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._getHigherDirectory(a._currentPath),isSynchronized:!1})},search:function(a){var b=this;this._eventHandler.trigger("filemanager:view:search",{directory:b._currentPath,query:a})},getCurrentPath:function(){return this._currentPath}};var FileTreeView=function(a,b){var c={debug:!1,i18n:{rename:"Rename",cut:"Cut",paste:"Paste",download:"Download","delete":"Delete"}};this.options=$.extend(!0,c,a),this.init(this.options,b)};FileTreeView.prototype={_debug:!1,_eventHandler:!1,_container:!1,_directoryElement:!1,_contentElement:!1,_uploadLink:!1,_uploadFunctionalityReference:null,_viewFormat:"list",_keepFocusOnDirectories:!1,_keepFocusOnContent:!1,_currentDirectory:"",_currentContent:[],_searching:!1,_searchQuery:"",_apiCalled:!1,_isMultiple:!1,_selectedFiles:[],_editContext:{mode:"none",selector:!1,file:!1},_i18n:{},init:function(a,b){this._debug=a.debug,this._container=$(b),this._directoryElement=$("[data-fm-value=directories]"),this._eventHandler=a.eventHandler,"function"==typeof a.filerowFormat&&(this._formatFilerow=a.filerowFormat),"function"==typeof a.fileCellFormat&&(this._formatFilecell=a.fileCellFormat),"function"==typeof a.renamerowFormat&&(this._formatRenamerow=a.renamerowFormat),"function"==typeof a.renamecellFormat&&(this._formatRenamecell=a.renamecellFormat),"function"==typeof a.uploadFormat&&(this._formatUpload=a.uploadFormat),"object"==typeof a.i18n&&(this._i18n=a.i18n),this._setOverviewLayout("list"),this._addFunctionality(),this._registerEvents()},_formatFilerow:function(a){return'<p class="filemanagerrow"><span>'+a.path+"</span></p>"},_formatFilecell:function(a){return'<p class="filemanagercell"><span>'+a.path+"</span></p>"},_formatRenamerow:function(a){return'<p class="filemanagerrow"><span>'+a.name+"</span></p>"},_formatRenamecell:function(a){return'<p class="filemanagercell"><span>'+a.name+"</span></p>"},refreshTitlebar:function(a){this.debug("Refreshing directory string to "+a),this._currentDirectory=a,$("[data-fm-value=current_directory]").text("/"+a),this._addUploadFunctionality()},refreshDirectories:function(a){var b=this;this._directoryElement.length>0&&"function"==typeof this._directoryElement.jstree&&this._directoryElement.jstree("destroy").jstree({core:{data:a,multiple:!1},plugins:[]}).on("dblclick.jstree",function(a){b._jstreeOpenEvent(a)}).on("keyup.jstree",function(a){13==a.keyCode&&b._jstreeOpenEvent(a)})},_createDirectory:function(a){var b,c='<input type="text" name="directory_name"/>',d={name:c,type:"dir",date_modified:"",size:"",children:{}};"list"==this._viewFormat?b=$(this._formatRenamerow(d)):"grid"==this._viewFormat&&(b=$(this._formatRenamecell(d)));var e=this,f=b.find("input[name=directory_name]");f.on("keydown",{directory:a},function(a){13==a.keyCode&&(""!=a.target.value&&e._eventHandler.trigger("filemanager:view:create",{directory:a.data.directory,name:a.target.value}),e._contentElement.children().eq(0).remove())}).on("blur",function(a){e._contentElement.children().eq(0).remove()}),this._contentElement.prepend(b),f.focus()},refreshContent:function(a){var b=this;if(void 0!==a&&(this._currentContent=a),this._contentElement.length>0){this._contentElement.empty(),$.contextMenu("destroy");for(var c=0,d=b._currentContent.length;d>c;c++){var e=$.extend({},b._currentContent[c]),f=$.extend({},b._currentContent[c]);1==b._searching&&(f.name=f.name.replace(this._searchQuery,'<span class="searchquery">'+this._searchQuery+"</span>")),f.size=this._filesizeFormat(f.size);var g="";g="list"==b._viewFormat?this._formatFilerow(f):this._formatFilecell(f);for(var h=this._generateFileSelector(e),i=$(g).attr("data-fm-functionality","file-"+e.directory+e.name).appendTo(this._contentElement).on("click",{file:e,selector:h},function(a){$(window).width()<=768?b._openContentEvent(a):b._toggleSelection(a)}).on("keyup",{file:e,selector:h},function(a){13==a.keyCode&&(b._keepFocusOnContent=!0,b._openContentEvent(a))}).on("keydown",{file:e,selector:h},function(a){a.ctrlKey&&88==a.keyCode?b._setCutMode(a.data.selector,a.data.file):a.ctrlKey&&86==a.keyCode&&"none"!==b._editContext.mode&&b._pasteMode(a.data.selector,a.data.file)}).on("dblclick",{file:e,selector:h},function(a){b._openContentEvent(a)}),j=0,k=this._selectedFiles.length;k>j;j++)this._selectedFiles[j].selector==h&&i.addClass("selected");b._addContextmenuToElement(h,e),0==c&&1==b._keepFocusOnContent&&(i.focus(),b._keepFocusOnContent=!1)}}this._setEditStyling(),this._updateVisibility(),b._addContextmenuToElement("[data-fm-functionality=directory_up]",{type:"dir",name:"",directory:b._currentDirectory},!0),b._eventHandler.trigger("filemanager:view:rendered")},_addContextmenuToElement:function(a,b,c){var d=this;$.contextMenu({selector:a,build:function(){var a={rename:{name:d._i18n.rename,icon:"rename"},cut:{name:d._i18n.cut,icon:"cut"},paste:{name:d._i18n.paste,icon:"paste"}};return"dir"!==b.type&&(a.download={name:d._i18n.download,icon:"download"}),a.seperator="---------",a["delete"]={name:d._i18n["delete"],icon:"delete"},c===!0?(a={},"none"!==d._editContext.mode&&(a.paste={name:d._i18n.paste,icon:"paste"})):"none"!==d._editContext.mode?a.paste.disabled=!1:a.paste.disabled=!0,{file:b,callback:function(a,b){switch(a){case"rename":d.createRenamerow(b.selector,b.file);break;case"cut":d._setCutMode(b.selector,b.file);break;case"paste":d._pasteMode(b.selector,b.file);break;case"delete":d._eventHandler.trigger("filemanager:view:delete",{file:b.file});break;case"download":d._eventHandler.trigger("filemanager:view:download",{file:b.file})}},items:a}}})},_generateFileSelector:function(a){var b="file-"+a.directory+a.name;return'[data-fm-functionality="'+b+'"]'},createRenamerow:function(a,b){var c=this._contentElement.find(a),d=this,e=$.extend({},b);e.name='<input type="text" name="file_name" value="'+b.name+'"/>';var f;"list"==this._viewFormat?f=$(d._formatRenamerow(e)):"grid"==this._viewFormat&&(f=$(d._formatRenamecell(e)));var g=f.find("input");g.on("keydown",{file:b},function(a){13==a.keyCode&&(""!=a.target.value&&d._renameEvent(a),d._contentElement.find(f).remove(),d._contentElement.find(c).show())}).on("blur",function(a){d._contentElement.find(f).remove(),d._contentElement.find(c).show()}),d._contentElement.find(c).hide().after(f);var h=g.val();g.val("").focus().val(h)},_openContentEvent:function(a){var b=(a.data.file.directory,a.data.file.path);if(0==b&&(b=a.data.file.directory+a.data.file.name),"undefined"==typeof a.data.file.type||"dir"==a.data.file.type){var c=!1;this._eventHandler.trigger("filemanager:view:open",{directory:b,isSynchronized:c})}else this._toggleSelection(a)},_toggleSelection:function(a){this._isFileSelected(a.data.file)?this._deselectEvent(a):this._selectEvent(a)},_selectEvent:function(a){0==this._isMultiple&&this._clearSelection(),this._selectedFiles.push({selector:a.data.selector,file:a.data.file}),$(a.data.selector).addClass("selected"),this._eventHandler.trigger("filemanager:view:select",{path:a.data.file.path,file:a.data.file})},_isFileSelected:function(a){for(var b=0,c=this._selectedFiles.length;c>b;b++)if(a==this._selectedFiles[b].file)return!0;return!1},_deselectEvent:function(a){for(var b=[],c=0,d=this._selectedFiles.length;d>c;c++)a.data.file==this._selectedFiles[c].file?$(a.data.selector).removeClass("selected"):b=this._selectedFiles[c];this._selectedFiles=b,this._eventHandler.trigger("filemanager:view:deselect",{path:a.data.file.path,file:a.data.file})},_clearSelection:function(){for(var a=0,b=this._selectedFiles.length;b>a;a++)$(this._selectedFiles[a].selector).removeClass("selected");this._selectedFiles=[]},_jstreeOpenEvent:function(a){var b=$(a.target).closest("li");if(b.length>0){var c=b.attr("data-path"),d="false"!=b.attr("data-synchronized");"undefined"!=typeof c&&this._eventHandler.trigger("filemanager:view:open",{directory:c,isSynchronized:!d})}},_searchEvent:function(a){var b=a.target.value;""!=b?(this._eventHandler.trigger("filemanager:view:search",{directory:this._currentDirectory,query:b}),$("[data-fm-value=search_query]").text(b)):this._eventHandler.trigger("filemanager:view:open",{directory:this._currentDirectory,isSynchronized:!1})},_renameEvent:function(a){var b=a.target.value;""!=b&&this._eventHandler.trigger("filemanager:view:rename",{file:a.data.file,newname:b})},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},_filesizeFormat:function(a){var b=1024,c=1024*b,d=1024*c,e="";return 0==isNaN(a)&&(a=parseInt(a),e=b>a?a+" B":c>a?(a/b).toFixed(1)+" KB":d>a?(a/c).toFixed(1)+" MB":(a/d).toFixed(1)+" GB"),e},_setOverviewLayout:function(a){"list"==a||"grid"==a?(this._viewFormat=a,"list"==this._viewFormat?($("[data-fm-functionality=set_list]").addClass("selected"),$("[data-fm-functionality=set_grid]").removeClass("selected"),this._contentElement=$("[data-fm-value=list_content]")):"grid"==this._viewFormat&&($("[data-fm-functionality=set_grid]").addClass("selected"),$("[data-fm-functionality=set_list]").removeClass("selected"),this._contentElement=$("[data-fm-value=grid_content]")),this._updateVisibility()):this.errorLog("Overview layout can only be a list or a grid")},_resetEditStyles:function(){this._editMode="none",this._editContext.selector!==!1&&($(this._editContext.selector).removeClass("mode-cut").removeClass("mode-copy"),this._editContext.selector=!1),this._editContext.file=!1},_setEditStyling:function(){var a=this._editContext;if(a.file!==!1&&a.selector!==!1)switch(a.mode){case"cut":$(a.selector).addClass("mode-cut");break;case"copy":$(a.selector).addClass("mode-copy");break;case"none":this._resetEditStyles()}},_setCutMode:function(a,b){this._resetEditStyles(),this._editContext={mode:"cut",selector:a,file:b},this._setEditStyling()},_setCopyMode:function(a,b){this._resetEditStyles(),this._editContext=this._editContext={mode:"copy",selector:a,file:b},this._setEditStyling()},_pasteMode:function(a,b){if("none"!==this._editContext.mode&&this._editContext.file!==!1){var c=b.directory;"dir"==b.type&&(c+=b.name),this._eventHandler.trigger("filemanager:view:move",{file:this._editContext.file,newlocation:c})}this._resetEditStyles()},_updateVisibility:function(){var a=function(a){return"[data-fm-show="+a+"]"};"list"==this._viewFormat?($(a("list_view")).show(),$(a("grid_view")).hide()):"grid"==this._viewFormat&&($(a("list_view")).hide(),$(a("grid_view")).show()),$(a("no_content")).hide(),$(a("no_search_results")).hide(),0==this._currentContent.length?0==this._searching?this._apiCalled&&$(a("no_content")).show():$(a("no_search_results")).show():1==this._searching&&$(a("search_results")).show(),""!==this._currentDirectory?$(a("no_root")).show():$(a("no_root")).hide()},_addFunctionality:function(){var a=this,b=function(a){13==a.keyCode&&(a.preventDefault(),$(a.target).addClass("active").trigger("mousedown"))},c=function(a){13==a.keyCode&&$(a.currentTarget).removeClass("active").trigger("click")};$("[data-fm-functionality=directory_up]").on("click",function(b){a._eventHandler.trigger("filemanager:view:directory_up",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=refresh]").on("click",function(){a._eventHandler.trigger("filemanager:view:refresh",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=create_directory]").on("click",function(b){a._createDirectory(a._currentDirectory)}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_list]").on("click",function(b){a._setOverviewLayout("list"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_grid]").on("click",function(b){a._setOverviewLayout("grid"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality^='sort_']").on("click",function(b){var c=$(b.currentTarget).attr("data-fm-functionality"),d=c.substring(5);"filename"===d?a._eventHandler.trigger("filemanager:view:sort"):a._eventHandler.trigger("filemanager:view:sort",{sortfunction:function(a,b){return a[d]>b[d]?-1:a[d]<b[d]?1:0}})}).on("keydown",b).on("keyup",c),$("input[data-fm-functionality=search]").on("search",{directory:a._currentDirectory},function(b){a._searchEvent(b)}).on("keydown",function(a){13==a.keyCode&&a.preventDefault()}).on("keyup",{directory:a._currentDirectory},function(b){13==b.keyCode&&a._searchEvent(b)}),a._addUploadFunctionality()},_addUploadFunctionality:function(){var a=this;null!==this._uploadFunctionalityReference&&this._uploadFunctionalityReference.destroy();var b=$("[data-fm-functionality=upload_progress]"),c=new ss.SimpleUpload({url:"/admin/fileapi/create",name:"filemanager_upload",method:"POST",hoverClass:"focus",focusClass:"active",multipart:!0,data:{filemanager_directory:a._currentDirectory},responseType:"json",dropzone:"filemanager_view",debug:a._debug,startXHR:function(){b.length>0&&(b.css("width","0%"),this.setProgressBar(b)),a._eventHandler.trigger("filemanager:api:uploading")},onComplete:function(b,c){a._eventHandler.trigger("filemanager:api:upload_done"),a._eventHandler.trigger("filemanager:view:ajax_upload",{response:c,directory:a._currentDirectory})},onAbort:function(){a._eventHandler.trigger("filemanager:api:upload_done")},onError:function(b,c,d,e,f){a._eventHandler.trigger("filemanager:api:upload_done"),f=JSON.parse(f),0!=f&&a._eventHandler.trigger("filemanager:api:error",{message:f.data.message,status:e,statuscode:d})}});if(c.setAbortBtn($("[data-fm-functionality=abort_upload]")),null===this._uploadFunctionalityReference){var d=$("[data-fm-functionality=upload_button]");0!==d.length&&d.on("click",function(){$("input[name=filemanager_upload]").trigger("click")}).on("keydown",function(a){13==a.keyCode&&(d.addClass("active"),a.preventDefault())}).on("keyup",function(a){13==a.keyCode&&(d.removeClass("active"),$("input[name=filemanager_upload]").trigger("click"))})}this._uploadFunctionalityReference=c},debug:function(a){"string"==typeof a&&(a="FileTreeView: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:error",function(b){a._apiCalled=!0,alert(b.message)}),this._eventHandler.register("filemanager:model:directories_changed",function(b){a._apiCalled=!0,a._searching=!1,a._searchQuery="",a.refreshDirectories(b)}),this._eventHandler.register("filemanager:view:search",function(b){a._apiCalled=!0,a._searching=!0,a._searchQuery=b.query}),this._eventHandler.register("filemanager:model:content_changed",function(b){a._apiCalled=!0,a.refreshContent(b)}),this._eventHandler.register("filemanager:model:path_changed",function(b){a._apiCalled=!0,a.refreshTitlebar(b)}),this._eventHandler.register("filemanager:model:select",function(b){var c={data:{file:b.file,selector:a._generateFileSelector(b.file)}};a._selectEvent(c)})}};var FilemanagerAPI=function(a){var b={debug:!1,api:{url:window.location.href,paths:{create:"/create",read:"",search:"/search",move:"/move",rename:"/rename","delete":"/delete",download:"/download"}}};this.options=$.extend(!0,b,a),this.init(this.options)};FilemanagerAPI.prototype={_debug:!1,_url:"",_path_create:"",_path_move:"",_path_rename:"",_path_read_directory:"",_path_delete:"",_path_search:"",_path_download:"",_eventHandler:!1,_disableRequests:!1,init:function(a){return null!==a&&"object"==typeof a&&(this._eventHandler=a.eventHandler,"undefined"!=typeof a.debug&&(this._debug=a.debug),null!==a.api&&"object"==typeof a.api&&("undefined"!=typeof a.api.url&&""!=a.api.url?this._url=a.api.url:(this._disableRequests=!0,console.error("NO APILINK FOUND !!!")),null!==a.api.paths&&"object"==typeof a.api.paths&&("undefined"!=typeof a.api.paths.move&&(this._path_move=a.api.paths.move),"undefined"!=typeof a.api.paths.rename&&(this._path_rename=a.api.paths.rename),"undefined"!=typeof a.api.paths.create&&(this._path_create=a.api.paths.create),"undefined"!=typeof a.api.paths["delete"]&&(this._path_delete=a.api.paths["delete"]),"undefined"!=typeof a.api.paths.read&&(this._path_read_directory=a.api.paths.read),"undefined"!=typeof a.api.paths.search&&(this._path_search=a.api.paths.search),"undefined"!=typeof a.api.paths.download&&(this._path_download=a.api.paths.download))),"string"==typeof a.api.startingDirectory&&this.read(a.api.startingDirectory)),this._registerEvents(),this.debug("Initializing"),this.debug(a),this},_sendRequest:function(a,b,c){"undefined"==typeof b&&(b="GET"),"object"!=typeof c&&(c={});var d=this;this._eventHandler.trigger("filemanager:api:loading");var e="",f=new RegExp("^(?:[a-z]+:)?//","i");if(f.test(a))e=a;else{var g="";g=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),e=g+a}return $.ajax({url:e,data:c,dataType:"json",method:b,self:d,beforeSend:function(a){d.debug("Sending "+this.method+" request to "+this.url+"...")}}).done(function(a){d._eventHandler.trigger("filemanager:api:done"),d.debug(a)}).fail(function(a,b,c){d._eventHandler.trigger("filemanager:api:done"),d.errorLog({statuscode:a.status,statustext:a.statusText,response:a.responseText})})},read:function(a){var b=this,c=this._url+this._path_read_directory;this._sendRequest(c,"GET",{directory:a}).done(function(c,d,e){b._eventHandler.trigger("filemanager:api:add_data",{contents:c.data.contents,directory:a})}).fail(function(a){b._handleApiError(a)})},search:function(a,b){var c=this,d=this._url+this._path_search;this._sendRequest(d,"GET",{directory:a,q:b}).done(function(d,e,f){c._eventHandler.trigger("filemanager:api:search_data",{contents:d.data.contents,directory:a,query:b})}).fail(function(a){c._handleApiError(a)})},move:function(a,b,c){var d=this,e=this._url+this._path_move,f=a+b;this._sendRequest(e,"POST",{filemanager_filepath:f,filemanager_newdirectory:c}).done(function(b,e,f){var g=[];if("object"==typeof b.data.changes)for(var h in b.data.changes)g.push(b.data.changes[h]);else g=b.data.changes;a!==c&&d._eventHandler.trigger("filemanager:api:refresh"),d._eventHandler.trigger("filemanager:api:update_data",{contents:g,directory:c})}).fail(function(a){d._handleApiError(a)})},rename:function(a,b,c){var d=this,e=this._url+this._path_rename;this._sendRequest(e,"POST",{filemanager_directory:a,filemanager_filename:b,filemanager_newfilename:c}).done(function(b,c,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;d._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){d._handleApiError(a)})},createDirectory:function(a,b){var c=this,d=this._url+this._path_create;this._sendRequest(d,"POST",{type:"directory",filemanager_directory:a,directory_name:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},"delete":function(a,b){var c=this,d=this._url+this._path_delete;this._sendRequest(d,"POST",{filemanager_directory:a,filemanager_filename:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},download:function(a){var b=this._url+this._path_download,c="?";b.indexOf(c)>-1&&(c="&"),window.location=b+c+"filemanager_path="+encodeURI(a)},uploadResponse:function(a,b){this._eventHandler.trigger("filemanager:api:done"),this._eventHandler.trigger("filemanager:api:update_data",{contents:b.data.changes,directory:a,selected:!0})},_handleApiError:function(a){var b=this,c=JSON.parse(a.responseText);b._eventHandler.trigger("filemanager:api:error",{message:c.data.message,status:c.status,statuscode:a.status})},debug:function(a){"string"==typeof a&&(a="FilemanagerAPI: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:view:open",function(b){0==b.isSynchronized&&a.read(b.directory)}),this._eventHandler.register("filemanager:view:search",function(b){a.search(b.directory,b.query)}),this._eventHandler.register("filemanager:view:create",function(b){a.createDirectory(b.directory,b.name)}),this._eventHandler.register("filemanager:view:rename",function(b){a.rename(b.file.directory,b.file.name,b.newname)}),this._eventHandler.register("filemanager:view:move",function(b){a.move(b.file.directory,b.file.name,b.newlocation)}),this._eventHandler.register("filemanager:view:delete",function(b){a["delete"](b.file.directory,b.file.name)}),this._eventHandler.register("filemanager:view:ajax_upload",function(b){a.uploadResponse(b.directory,b.response)}),this._eventHandler.register("filemanager:view:download",function(b){a.download(b.file.path)})}};var FilemanagerEventHandler=function(a){var b={debug:!1};a=$.extend(!0,b,a),this.init(a)};FilemanagerEventHandler.prototype={_events:{},_debug:!1,init:function(a){null!==a&&"object"==typeof a&&"undefined"!=typeof a.debug&&(this._debug=a.debug)},hasEvent:function(a,b){if(this._events.hasOwnProperty(a))return!0;if(b)throw'No event registered for "'+a+'"';return!1},register:function(a,b){this.debug("Registering "+a),this._create(a),this._events[a].push(b)},unRegister:function(a){this.hasEvent(a,!0)&&delete this._events[a]},_create:function(a){this.hasEvent(a,!1)||(this._events[a]=[])},trigger:function(a){if(this.debug("Triggering "+a),this.hasEvent(a,!1)){var b=Array.prototype.slice.call(arguments,1);$.each(this._events[a],function(a,c){c.apply(c,b)}.bind(this))}},debug:function(a){this._debug&&console.log(a)}},function(){$.fn.filemanager=function(a){if("undefined"==typeof a&&(a={}),a.eventHandler=new FilemanagerEventHandler(a),null!==a.api&&"object"==typeof a.api)if("undefined"!=typeof a.api.url&&""!=a.api.url){this.data("event",a.eventHandler),this.data("view",new FileTreeView(a)),this.data("api",new FilemanagerAPI(a)),this.data("tree",new FileTree(a));var b=this,c={refresh:function(){return b.data("tree").refresh(),b},moveUpDirectory:function(){b.data("tree").moveUpDirectory()},createDirectory:function(){var a=b.data("tree").getCurrentPath();return b.data("view")._createDirectory(a),b},search:function(a){return b.data("tree").search(a),b},on:function(a,c){return b.data("event").register(a,c),b}};this.data("filemanager",c)}else console.error("Filemanager: NO APILINK FOUND - Aborting creation");else console.error("Filemanager: NO APILINK FOUND - Aborting creation");return this}}(jQuery);var FileTree=function(a){var b={debug:!1};this.options=$.extend(!0,b,a),this.init(this.options)};FileTree.prototype={_debug:!1,_root:{children:{}},_currentPath:"",_currentFiles:[],_currentContentSort:null,_reverse:!1,_walk_itteration:0,_eventHandler:null,init:function(a){return null!==a&&"object"==typeof a&&(this._debug=a.debug,this._eventHandler=a.eventHandler,this._registerEvents()),this._currentContentSort=this._naturalFilemanagerSort,this.debug("Initializing"),this.debug(a),this},addFiles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];this._setFile(e)}this.debug("Tree structure after updating"),this.debug(this._root),1==b&&this._updateViews(!0,!1,!1)},setContents:function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.path=this._formatPath(e.path,!0),e.directory=this._formatPath(e.directory),b.push(e)}this._currentFiles=b},_setFile:function(a){0==a.hasOwnProperty("path")&&(a.path=this._formatPath(a.directory)+a.name),a.path=this._formatPath(a.path,!0),a.directory=this._formatPath(a.directory),0==a.hasOwnProperty("children")&&(a.children={});var b=this._findNode(a.directory);"undefined"==typeof b.children[a.name]?b.children[a.name]=a:b.children[a.name]=$.extend(!0,b.children[a.name],a)},_findNode:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];"undefined"==typeof c.children[f]&&(c.children[f]=this._generateNode(f,b)),c=c.children[f]}return"undefined"==typeof c.children&&(c.children={}),c},_generateNode:function(a,b){var c={};c.name=a;for(var d="",e=0;e<b.length&&(d+=b[e]+"/",b[e+1]!=a);e++);return c.directory=d,c.path=d+a,c.children={},c},_extractPathNodes:function(a){"string"!=typeof a&&(a="");for(var b=a.split("/"),c=[],d=0,e=b.length;e>d;d++)""!==b[d]&&c.push(b[d]);return c},addChanges:function(a,b){if("undefined"!=typeof a||!a)for(var c=0,d=a.length;d>c;c++)this._executeChange(a[c]);this.debug("Tree structure after updating"),this.debug(this._root),this.debug("Updating the current files"),this.openPath(this._currentPath,!1),this.debug(this._currentFiles),b&&this._updateViews(!0,!0,!0)},_executeChange:function(a){switch(a.type){case"delete":this._deleteNode(a.file);break;case"create":this._setFile(a.file);break;case"update":case"rename":case"move":this._updateNode(a.file,a.updatedfile)}},_updateNode:function(a,b){
var c=this._findNodeIfExists(a.directory);if(c!==!1||"undefined"!=typeof c.children[a.name]){var d=c.children[a.name],e=this._formatPath(d.path);b.path=b.directory+b.name;var f=$.extend(!0,d,b),g=this._formatPath(b.path);e!=g&&(f=this._updateChildPaths(f),this._deleteNode(a)),this._setFile(f)}},_updateChildPaths:function(a){if("undefined"!=typeof a.children){var b=[];for(var c in a.children)b.push(c);for(var d=0,e=b.length;e>d;d++)if("undefined"!=typeof a.children[b[d]]){var f=a.children[b[d]];f.directory=this._formatPath(a.path),f.path=this._formatPath(a.path)+f.name,a.children[b[d]]=this._updateChildPaths(f)}}return a},_formatPath:function(a,b){return"undefined"==typeof a&&(a=""),0!==a.length&&"/"==a.substr(0,1)&&(a=a.substr(1,a.length-1)),b!==!0&&0!==a.length&&"/"!=a.substr(a,a.length-1)&&(a+="/"),a=a.replace(/\/\/+/g,"/")},_deleteNode:function(a){var b=this._findNodeIfExists(a.directory);b!==!1&&delete b.children[a.name]},_findNodeIfExists:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];if("undefined"==typeof c.children[f]){c=!1;break}c=c.children[f]}return c},flattenTree:function(a){var b=this.toJstreeData(this._root.children,a);return this._walk_itteration=0,this.debug("JsTree data updated"),this.debug(b),b},toJstreeData:function(a,b){"undefined"==typeof a&&(a=this._root.children);var c=[];for(var d in a){var e=a[d];if(!b||b===!0&&("undefined"==typeof e.type||"dir"===e.type)){this._walk_itteration++;var f={text:e.name};if(f.li_attr={id:"js_tree_file_"+this._walk_itteration,"data-path":e.path,"data-synchronized":"undefined"==typeof e._generated},f.state={opened:this._isOpenedDirectory(e),selected:!1,disabled:"undefined"!=typeof e.disabled&&1==e.disabled},"object"==typeof e.children&&null!==e.children){var g=[];for(var h in e.children)g.push(h);g.length>0&&(f.children=this.toJstreeData(e.children,b))}c.push(f)}}return c},openPath:function(a,b){this._currentPath=a;var c=this._findNodeIfExists(a);if(c===!1)this._currentPath=a,this._currentFiles=[];else if(""!==a&&c==this._root)this._currentFiles=[];else{var d=[];for(var e in c.children)d.push(c.children[e]);this.setContents(d)}b&&this._updateViews(!0,!0,!0)},_isOpenedDirectory:function(a){for(var b=this._extractPathNodes(this._currentPath),c=this._extractPathNodes(this._formatPath(a.path)),d=!1,e=0,f=c.length;f>e;e++)d=b[e]===c[e];return d},_naturalFilemanagerSort:function(a,b){var c=a.type,d=b.type;return"dir"==c&&"dir"!=d?-1:"dir"!=c&&"dir"==d?1:String(a.name).toLowerCase()<String(b.name).toLowerCase()?-1:String(a.name).toLowerCase()>String(b.name).toLowerCase()?1:0},sortContent:function(a){"function"!=typeof a&&(a=this._naturalFilemanagerSort),String(this._currentContentSort)==String(a)?this._reverse=!this._reverse:this._reverse=!1,this._currentContentSort=a,this._updateViews(!1,!0,!1)},resetSort:function(){this.sortContent(this._naturalFilemanagerSort)},_updateViews:function(a,b,c){1==a&&this._eventHandler.trigger("filemanager:model:directories_changed",this.flattenTree(!0)),1==b&&(this._currentFiles.sort(this._currentContentSort),this._reverse&&this._currentFiles.reverse(),this._eventHandler.trigger("filemanager:model:content_changed",this._currentFiles)),1==c&&this._eventHandler.trigger("filemanager:model:path_changed",this._currentPath)},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},debug:function(a){"string"==typeof a&&(a="FileTree: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:add_data",function(b){a.addFiles(b.contents),a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:api:update_data",function(b){a.addChanges(b.contents,!0),1==b.selected&&a._eventHandler.trigger("filemanager:model:select",{file:b.contents[0].file})}),this._eventHandler.register("filemanager:api:search_data",function(b){a.setContents(b.contents),a._updateViews(!1,!0,!1)}),this._eventHandler.register("filemanager:view:directory_up",function(b){a.moveUpDirectory()}),this._eventHandler.register("filemanager:view:sort",function(b){void 0!==b&&"function"==typeof b.sortfunction?a.sortContent(b.sortfunction):a.sortContent()}),this._eventHandler.register("filemanager:view:open",function(b){b.isSynchronized&&a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:view:refresh",function(b){a.refresh()}),this._eventHandler.register("filemanager:api:refresh",function(b){a.refresh()})},refresh:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._currentPath,isSynchronized:!1})},moveUpDirectory:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._getHigherDirectory(a._currentPath),isSynchronized:!1})},search:function(a){var b=this;this._eventHandler.trigger("filemanager:view:search",{directory:b._currentPath,query:a})},getCurrentPath:function(){return this._currentPath}};var FileTreeView=function(a,b){var c={debug:!1,i18n:{rename:"Rename",cut:"Cut",paste:"Paste",download:"Download","delete":"Delete"}};this.options=$.extend(!0,c,a),this.init(this.options,b)};FileTreeView.prototype={_debug:!1,_eventHandler:!1,_container:!1,_directoryElement:!1,_contentElement:!1,_uploadLink:!1,_uploadFunctionalityReference:null,_viewFormat:"list",_keepFocusOnDirectories:!1,_keepFocusOnContent:!1,_currentDirectory:"",_currentContent:[],_searching:!1,_searchQuery:"",_apiCalled:!1,_isMultiple:!1,_selectedFiles:[],_editContext:{mode:"none",selector:!1,file:!1},_i18n:{},init:function(a,b){this._debug=a.debug,this._container=$(b),this._directoryElement=$("[data-fm-value=directories]"),this._eventHandler=a.eventHandler,"function"==typeof a.filerowFormat&&(this._formatFilerow=a.filerowFormat),"function"==typeof a.fileCellFormat&&(this._formatFilecell=a.fileCellFormat),"function"==typeof a.renamerowFormat&&(this._formatRenamerow=a.renamerowFormat),"function"==typeof a.renamecellFormat&&(this._formatRenamecell=a.renamecellFormat),"function"==typeof a.uploadFormat&&(this._formatUpload=a.uploadFormat),"object"==typeof a.i18n&&(this._i18n=a.i18n),this._setOverviewLayout("list"),this._addFunctionality(),this._registerEvents()},_formatFilerow:function(a){return'<p class="filemanagerrow"><span>'+a.path+"</span></p>"},_formatFilecell:function(a){return'<p class="filemanagercell"><span>'+a.path+"</span></p>"},_formatRenamerow:function(a){return'<p class="filemanagerrow"><span>'+a.name+"</span></p>"},_formatRenamecell:function(a){return'<p class="filemanagercell"><span>'+a.name+"</span></p>"},refreshTitlebar:function(a){this.debug("Refreshing directory string to "+a),this._currentDirectory=a,$("[data-fm-value=current_directory]").text("/"+a),this._addUploadFunctionality()},refreshDirectories:function(a){var b=this;this._directoryElement.length>0&&"function"==typeof this._directoryElement.jstree&&this._directoryElement.jstree("destroy").jstree({core:{data:a,multiple:!1},plugins:[]}).on("dblclick.jstree",function(a){b._jstreeOpenEvent(a)}).on("keyup.jstree",function(a){13==a.keyCode&&b._jstreeOpenEvent(a)})},_createDirectory:function(a){var b,c='<input type="text" name="directory_name"/>',d={name:c,type:"dir",date_modified:"",size:"",children:{}};"list"==this._viewFormat?b=$(this._formatRenamerow(d)):"grid"==this._viewFormat&&(b=$(this._formatRenamecell(d)));var e=this,f=b.find("input[name=directory_name]");f.on("keydown",{directory:a},function(a){13==a.keyCode&&(""!=a.target.value&&e._eventHandler.trigger("filemanager:view:create",{directory:a.data.directory,name:a.target.value}),e._contentElement.children().eq(0).remove())}).on("blur",function(a){e._contentElement.children().eq(0).remove()}),this._contentElement.prepend(b),f.focus()},refreshContent:function(a){var b=this;if(void 0!==a&&(this._currentContent=a),this._contentElement.length>0){this._contentElement.empty(),$.contextMenu("destroy");for(var c=0,d=b._currentContent.length;d>c;c++){var e=$.extend({},b._currentContent[c]),f=$.extend({},b._currentContent[c]);1==b._searching&&(f.name=f.name.replace(this._searchQuery,'<span class="searchquery">'+this._searchQuery+"</span>")),f.size=this._filesizeFormat(f.size);var g="";g="list"==b._viewFormat?this._formatFilerow(f):this._formatFilecell(f);for(var h=this._generateFileSelector(e),i=$(g).attr("data-fm-functionality","file-"+e.directory+e.name).appendTo(this._contentElement).on("click",{file:e,selector:h},function(a){$(window).width()<=768?b._openContentEvent(a):b._toggleSelection(a)}).on("keyup",{file:e,selector:h},function(a){13==a.keyCode&&(b._keepFocusOnContent=!0,b._openContentEvent(a))}).on("keydown",{file:e,selector:h},function(a){a.ctrlKey&&88==a.keyCode?b._setCutMode(a.data.selector,a.data.file):a.ctrlKey&&86==a.keyCode&&"none"!==b._editContext.mode&&b._pasteMode(a.data.selector,a.data.file)}).on("dblclick",{file:e,selector:h},function(a){b._openContentEvent(a)}),j=0,k=this._selectedFiles.length;k>j;j++)this._selectedFiles[j].selector==h&&i.addClass("selected");b._addContextmenuToElement(h,e),0==c&&1==b._keepFocusOnContent&&(i.focus(),b._keepFocusOnContent=!1)}}this._setEditStyling(),this._updateVisibility(),b._addContextmenuToElement("[data-fm-functionality=directory_up]",{type:"dir",name:"",directory:b._currentDirectory},!0),b._eventHandler.trigger("filemanager:view:rendered")},_addContextmenuToElement:function(a,b,c){var d=this;$.contextMenu({selector:a,build:function(){var a={rename:{name:d._i18n.rename,icon:"rename"},cut:{name:d._i18n.cut,icon:"cut"},paste:{name:d._i18n.paste,icon:"paste"}};return"dir"!==b.type&&(a.download={name:d._i18n.download,icon:"download"}),a.seperator="---------",a["delete"]={name:d._i18n["delete"],icon:"delete"},c===!0?(a={},"none"!==d._editContext.mode&&(a.paste={name:d._i18n.paste,icon:"paste"})):"none"!==d._editContext.mode?a.paste.disabled=!1:a.paste.disabled=!0,{file:b,callback:function(a,b){switch(a){case"rename":d.createRenamerow(b.selector,b.file);break;case"cut":d._setCutMode(b.selector,b.file);break;case"paste":d._pasteMode(b.selector,b.file);break;case"delete":d._eventHandler.trigger("filemanager:view:delete",{file:b.file});break;case"download":d._eventHandler.trigger("filemanager:view:download",{file:b.file})}},items:a}}})},_generateFileSelector:function(a){var b="file-"+a.directory+a.name;return'[data-fm-functionality="'+b+'"]'},createRenamerow:function(a,b){var c=this._contentElement.find(a),d=this,e=$.extend({},b);e.name='<input type="text" name="file_name" value="'+b.name+'"/>';var f;"list"==this._viewFormat?f=$(d._formatRenamerow(e)):"grid"==this._viewFormat&&(f=$(d._formatRenamecell(e)));var g=f.find("input");g.on("keydown",{file:b},function(a){13==a.keyCode&&(""!=a.target.value&&d._renameEvent(a),d._contentElement.find(f).remove(),d._contentElement.find(c).show())}).on("blur",function(a){d._contentElement.find(f).remove(),d._contentElement.find(c).show()}),d._contentElement.find(c).hide().after(f);var h=g.val();g.val("").focus().val(h)},_openContentEvent:function(a){var b=(a.data.file.directory,a.data.file.path);if(0==b&&(b=a.data.file.directory+a.data.file.name),"undefined"==typeof a.data.file.type||"dir"==a.data.file.type){var c=!1;this._eventHandler.trigger("filemanager:view:open",{directory:b,isSynchronized:c})}else this._toggleSelection(a)},_toggleSelection:function(a){this._isFileSelected(a.data.file)?this._deselectEvent(a):this._selectEvent(a)},_selectEvent:function(a){0==this._isMultiple&&this._clearSelection(),this._selectedFiles.push({selector:a.data.selector,file:a.data.file}),$(a.data.selector).addClass("selected"),this._eventHandler.trigger("filemanager:view:select",{path:a.data.file.path,file:a.data.file})},_isFileSelected:function(a){for(var b=0,c=this._selectedFiles.length;c>b;b++)if(a==this._selectedFiles[b].file)return!0;return!1},_deselectEvent:function(a){for(var b=[],c=0,d=this._selectedFiles.length;d>c;c++)a.data.file==this._selectedFiles[c].file?$(a.data.selector).removeClass("selected"):b=this._selectedFiles[c];this._selectedFiles=b,this._eventHandler.trigger("filemanager:view:deselect",{path:a.data.file.path,file:a.data.file})},_clearSelection:function(){for(var a=0,b=this._selectedFiles.length;b>a;a++)$(this._selectedFiles[a].selector).removeClass("selected");this._selectedFiles=[]},_jstreeOpenEvent:function(a){var b=$(a.target).closest("li");if(b.length>0){var c=b.attr("data-path"),d="false"!=b.attr("data-synchronized");"undefined"!=typeof c&&this._eventHandler.trigger("filemanager:view:open",{directory:c,isSynchronized:!d})}},_searchEvent:function(a){var b=a.target.value;""!=b?(this._eventHandler.trigger("filemanager:view:search",{directory:this._currentDirectory,query:b}),$("[data-fm-value=search_query]").text(b)):this._eventHandler.trigger("filemanager:view:open",{directory:this._currentDirectory,isSynchronized:!1})},_renameEvent:function(a){var b=a.target.value;""!=b&&this._eventHandler.trigger("filemanager:view:rename",{file:a.data.file,newname:b})},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},_filesizeFormat:function(a){var b=1024,c=1024*b,d=1024*c,e="";return 0==isNaN(a)&&(a=parseInt(a),e=b>a?a+" B":c>a?(a/b).toFixed(1)+" KB":d>a?(a/c).toFixed(1)+" MB":(a/d).toFixed(1)+" GB"),e},_setOverviewLayout:function(a){"list"==a||"grid"==a?(this._viewFormat=a,"list"==this._viewFormat?($("[data-fm-functionality=set_list]").addClass("selected"),$("[data-fm-functionality=set_grid]").removeClass("selected"),this._contentElement=$("[data-fm-value=list_content]")):"grid"==this._viewFormat&&($("[data-fm-functionality=set_grid]").addClass("selected"),$("[data-fm-functionality=set_list]").removeClass("selected"),this._contentElement=$("[data-fm-value=grid_content]")),this._updateVisibility()):this.errorLog("Overview layout can only be a list or a grid")},_resetEditStyles:function(){this._editMode="none",this._editContext.selector!==!1&&($(this._editContext.selector).removeClass("mode-cut").removeClass("mode-copy"),this._editContext.selector=!1),this._editContext.file=!1},_setEditStyling:function(){var a=this._editContext;if(a.file!==!1&&a.selector!==!1)switch(a.mode){case"cut":$(a.selector).addClass("mode-cut");break;case"copy":$(a.selector).addClass("mode-copy");break;case"none":this._resetEditStyles()}},_setCutMode:function(a,b){this._resetEditStyles(),this._editContext={mode:"cut",selector:a,file:b},this._setEditStyling()},_setCopyMode:function(a,b){this._resetEditStyles(),this._editContext=this._editContext={mode:"copy",selector:a,file:b},this._setEditStyling()},_pasteMode:function(a,b){if("none"!==this._editContext.mode&&this._editContext.file!==!1){var c=b.directory;"dir"==b.type&&(c+=b.name),this._eventHandler.trigger("filemanager:view:move",{file:this._editContext.file,newlocation:c})}this._resetEditStyles()},_updateVisibility:function(){var a=function(a){return"[data-fm-show="+a+"]"};"list"==this._viewFormat?($(a("list_view")).show(),$(a("grid_view")).hide()):"grid"==this._viewFormat&&($(a("list_view")).hide(),$(a("grid_view")).show()),$(a("no_content")).hide(),$(a("no_search_results")).hide(),0==this._currentContent.length?0==this._searching?this._apiCalled&&$(a("no_content")).show():$(a("no_search_results")).show():1==this._searching&&$(a("search_results")).show(),""!==this._currentDirectory?$(a("no_root")).show():$(a("no_root")).hide()},_addFunctionality:function(){var a=this,b=function(a){13==a.keyCode&&(a.preventDefault(),$(a.target).addClass("active").trigger("mousedown"))},c=function(a){13==a.keyCode&&$(a.currentTarget).removeClass("active").trigger("click")};$("[data-fm-functionality=directory_up]").on("click",function(b){a._eventHandler.trigger("filemanager:view:directory_up",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=refresh]").on("click",function(){a._eventHandler.trigger("filemanager:view:refresh",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=create_directory]").on("click",function(b){a._createDirectory(a._currentDirectory)}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_list]").on("click",function(b){a._setOverviewLayout("list"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_grid]").on("click",function(b){a._setOverviewLayout("grid"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality^='sort_']").on("click",function(b){var c=$(b.currentTarget).attr("data-fm-functionality"),d=c.substring(5);"filename"===d?a._eventHandler.trigger("filemanager:view:sort"):a._eventHandler.trigger("filemanager:view:sort",{sortfunction:function(a,b){return a[d]>b[d]?-1:a[d]<b[d]?1:0}})}).on("keydown",b).on("keyup",c),$("input[data-fm-functionality=search]").on("search",{directory:a._currentDirectory},function(b){a._searchEvent(b)}).on("keydown",function(a){13==a.keyCode&&a.preventDefault()}).on("keyup",{directory:a._currentDirectory},function(b){13==b.keyCode&&a._searchEvent(b)}),a._addUploadFunctionality()},_addUploadFunctionality:function(){var a=this;null!==this._uploadFunctionalityReference&&this._uploadFunctionalityReference.destroy();var b=$("[data-fm-functionality=upload_progress]"),c=new ss.SimpleUpload({url:"/admin/fileapi/create",name:"filemanager_upload",method:"POST",hoverClass:"focus",focusClass:"active",multipart:!0,data:{filemanager_directory:a._currentDirectory},responseType:"json",dropzone:"filemanager_view",debug:a._debug,startXHR:function(){b.length>0&&(b.css("width","0%"),this.setProgressBar(b)),a._eventHandler.trigger("filemanager:api:uploading")},onComplete:function(b,c){a._eventHandler.trigger("filemanager:api:upload_done"),a._eventHandler.trigger("filemanager:view:ajax_upload",{response:c,directory:a._currentDirectory})},onAbort:function(){a._eventHandler.trigger("filemanager:api:upload_done")},onError:function(b,c,d,e,f){a._eventHandler.trigger("filemanager:api:upload_done"),f=JSON.parse(f),0!=f&&a._eventHandler.trigger("filemanager:api:error",{message:f.data.message,status:e,statuscode:d})}});if(c.setAbortBtn($("[data-fm-functionality=abort_upload]")),null===this._uploadFunctionalityReference){var d=$("[data-fm-functionality=upload_button]");0!==d.length&&d.on("click",function(){$("input[name=filemanager_upload]").trigger("click")}).on("keydown",function(a){13==a.keyCode&&(d.addClass("active"),a.preventDefault())}).on("keyup",function(a){13==a.keyCode&&(d.removeClass("active"),$("input[name=filemanager_upload]").trigger("click"))})}this._uploadFunctionalityReference=c},debug:function(a){"string"==typeof a&&(a="FileTreeView: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:error",function(b){a._apiCalled=!0,alert(b.message)}),this._eventHandler.register("filemanager:model:directories_changed",function(b){a._apiCalled=!0,a._searching=!1,a._searchQuery="",a.refreshDirectories(b)}),this._eventHandler.register("filemanager:view:search",function(b){a._apiCalled=!0,a._searching=!0,a._searchQuery=b.query}),this._eventHandler.register("filemanager:model:content_changed",function(b){a._apiCalled=!0,a.refreshContent(b)}),this._eventHandler.register("filemanager:model:path_changed",function(b){a._apiCalled=!0,a.refreshTitlebar(b)}),this._eventHandler.register("filemanager:model:select",function(b){var c={data:{file:b.file,selector:a._generateFileSelector(b.file)}};a._selectEvent(c)})}};var FilemanagerAPI=function(a){var b={debug:!1,api:{url:window.location.href,paths:{create:"/create",read:"",search:"/search",move:"/move",rename:"/rename","delete":"/delete",download:"/download"}}};this.options=$.extend(!0,b,a),this.init(this.options)};FilemanagerAPI.prototype={_debug:!1,_url:"",_path_create:"",_path_move:"",_path_rename:"",_path_read_directory:"",_path_delete:"",_path_search:"",_path_download:"",_eventHandler:!1,_disableRequests:!1,init:function(a){return null!==a&&"object"==typeof a&&(this._eventHandler=a.eventHandler,"undefined"!=typeof a.debug&&(this._debug=a.debug),null!==a.api&&"object"==typeof a.api&&("undefined"!=typeof a.api.url&&""!=a.api.url?this._url=a.api.url:(this._disableRequests=!0,console.error("NO APILINK FOUND !!!")),null!==a.api.paths&&"object"==typeof a.api.paths&&("undefined"!=typeof a.api.paths.move&&(this._path_move=a.api.paths.move),"undefined"!=typeof a.api.paths.rename&&(this._path_rename=a.api.paths.rename),"undefined"!=typeof a.api.paths.create&&(this._path_create=a.api.paths.create),"undefined"!=typeof a.api.paths["delete"]&&(this._path_delete=a.api.paths["delete"]),"undefined"!=typeof a.api.paths.read&&(this._path_read_directory=a.api.paths.read),"undefined"!=typeof a.api.paths.search&&(this._path_search=a.api.paths.search),"undefined"!=typeof a.api.paths.download&&(this._path_download=a.api.paths.download))),"string"==typeof a.api.startingDirectory&&this.read(a.api.startingDirectory)),this._registerEvents(),this.debug("Initializing"),this.debug(a),this},_sendRequest:function(a,b,c){"undefined"==typeof b&&(b="GET"),"object"!=typeof c&&(c={});var d=this;this._eventHandler.trigger("filemanager:api:loading");var e="",f=new RegExp("^(?:[a-z]+:)?//","i");if(f.test(a))e=a;else{var g="";g=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),e=g+a}return $.ajax({url:e,data:c,dataType:"json",method:b,self:d,beforeSend:function(a){d.debug("Sending "+this.method+" request to "+this.url+"...")}}).done(function(a){d._eventHandler.trigger("filemanager:api:done"),d.debug(a)}).fail(function(a,b,c){d._eventHandler.trigger("filemanager:api:done"),d.errorLog({statuscode:a.status,statustext:a.statusText,response:a.responseText})})},read:function(a){var b=this,c=this._url+this._path_read_directory;this._sendRequest(c,"GET",{directory:a}).done(function(c,d,e){b._eventHandler.trigger("filemanager:api:add_data",{contents:c.data.contents,directory:a})}).fail(function(a){b._handleApiError(a)})},search:function(a,b){var c=this,d=this._url+this._path_search;this._sendRequest(d,"GET",{directory:a,q:b}).done(function(d,e,f){c._eventHandler.trigger("filemanager:api:search_data",{contents:d.data.contents,directory:a,query:b})}).fail(function(a){c._handleApiError(a)})},move:function(a,b,c){var d=this,e=this._url+this._path_move,f=a+b;this._sendRequest(e,"POST",{filemanager_filepath:f,filemanager_newdirectory:c}).done(function(b,e,f){var g=[];if("object"==typeof b.data.changes)for(var h in b.data.changes)g.push(b.data.changes[h]);else g=b.data.changes;a!==c&&d._eventHandler.trigger("filemanager:api:refresh"),d._eventHandler.trigger("filemanager:api:update_data",{contents:g,directory:c})}).fail(function(a){d._handleApiError(a)})},rename:function(a,b,c){var d=this,e=this._url+this._path_rename;this._sendRequest(e,"POST",{filemanager_directory:a,filemanager_filename:b,filemanager_newfilename:c}).done(function(b,c,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;d._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){d._handleApiError(a)})},createDirectory:function(a,b){var c=this,d=this._url+this._path_create;this._sendRequest(d,"POST",{type:"directory",filemanager_directory:a,directory_name:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},"delete":function(a,b){var c=this,d=this._url+this._path_delete;this._sendRequest(d,"POST",{filemanager_directory:a,filemanager_filename:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},download:function(a){var b=this._url+this._path_download,c="?";b.indexOf(c)>-1&&(c="&"),window.location=b+c+"filemanager_path="+encodeURI(a)},uploadResponse:function(a,b){this._eventHandler.trigger("filemanager:api:done"),this._eventHandler.trigger("filemanager:api:update_data",{contents:b.data.changes,directory:a,selected:!0})},_handleApiError:function(a){var b=this,c=JSON.parse(a.responseText);b._eventHandler.trigger("filemanager:api:error",{message:c.data.message,status:c.status,statuscode:a.status})},debug:function(a){"string"==typeof a&&(a="FilemanagerAPI: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:view:open",function(b){0==b.isSynchronized&&a.read(b.directory)}),this._eventHandler.register("filemanager:view:search",function(b){a.search(b.directory,b.query)}),this._eventHandler.register("filemanager:view:create",function(b){a.createDirectory(b.directory,b.name)}),this._eventHandler.register("filemanager:view:rename",function(b){a.rename(b.file.directory,b.file.name,b.newname)}),this._eventHandler.register("filemanager:view:move",function(b){a.move(b.file.directory,b.file.name,b.newlocation)}),this._eventHandler.register("filemanager:view:delete",function(b){a["delete"](b.file.directory,b.file.name)}),this._eventHandler.register("filemanager:view:ajax_upload",function(b){a.uploadResponse(b.directory,b.response)}),this._eventHandler.register("filemanager:view:download",function(b){a.download(b.file.path)})}};var FilemanagerEventHandler=function(a){var b={debug:!1};a=$.extend(!0,b,a),this.init(a)};FilemanagerEventHandler.prototype={_events:{},_debug:!1,init:function(a){null!==a&&"object"==typeof a&&"undefined"!=typeof a.debug&&(this._debug=a.debug)},hasEvent:function(a,b){if(this._events.hasOwnProperty(a))return!0;if(b)throw'No event registered for "'+a+'"';return!1},register:function(a,b){this.debug("Registering "+a),this._create(a),this._events[a].push(b)},unRegister:function(a){this.hasEvent(a,!0)&&delete this._events[a]},_create:function(a){this.hasEvent(a,!1)||(this._events[a]=[])},trigger:function(a){if(this.debug("Triggering "+a),this.hasEvent(a,!1)){var b=Array.prototype.slice.call(arguments,1);$.each(this._events[a],function(a,c){c.apply(c,b)}.bind(this))}},debug:function(a){this._debug&&console.log(a)}},function(){$.fn.filemanager=function(a){if("undefined"==typeof a&&(a={}),a.eventHandler=new FilemanagerEventHandler(a),null!==a.api&&"object"==typeof a.api)if("undefined"!=typeof a.api.url&&""!=a.api.url){this.data("event",a.eventHandler),this.data("view",new FileTreeView(a)),this.data("api",new FilemanagerAPI(a)),this.data("tree",new FileTree(a));var b=this,c={refresh:function(){return b.data("tree").refresh(),b},moveUpDirectory:function(){b.data("tree").moveUpDirectory()},createDirectory:function(){var a=b.data("tree").getCurrentPath();return b.data("view")._createDirectory(a),b},search:function(a){return b.data("tree").search(a),b},on:function(a,c){return b.data("event").register(a,c),b}};this.data("filemanager",c)}else console.error("Filemanager: NO APILINK FOUND - Aborting creation");else console.error("Filemanager: NO APILINK FOUND - Aborting creation");return this}}(jQuery);var FileTree=function(a){var b={debug:!1};this.options=$.extend(!0,b,a),this.init(this.options)};FileTree.prototype={_debug:!1,_root:{children:{}},_currentPath:"",_currentFiles:[],_currentContentSort:null,_reverse:!1,_walk_itteration:0,_eventHandler:null,init:function(a){return null!==a&&"object"==typeof a&&(this._debug=a.debug,this._eventHandler=a.eventHandler,this._registerEvents()),this._currentContentSort=this._naturalFilemanagerSort,this.debug("Initializing"),this.debug(a),this},addFiles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];this._setFile(e)}this.debug("Tree structure after updating"),this.debug(this._root),1==b&&this._updateViews(!0,!1,!1)},setContents:function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.path=this._formatPath(e.path,!0),e.directory=this._formatPath(e.directory),b.push(e)}this._currentFiles=b},_setFile:function(a){0==a.hasOwnProperty("path")&&(a.path=this._formatPath(a.directory)+a.name),a.path=this._formatPath(a.path,!0),a.directory=this._formatPath(a.directory),0==a.hasOwnProperty("children")&&(a.children={});var b=this._findNode(a.directory);"undefined"==typeof b.children[a.name]?b.children[a.name]=a:b.children[a.name]=$.extend(!0,b.children[a.name],a)},_findNode:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];"undefined"==typeof c.children[f]&&(c.children[f]=this._generateNode(f,b)),c=c.children[f]}return"undefined"==typeof c.children&&(c.children={}),c},_generateNode:function(a,b){var c={};c.name=a;for(var d="",e=0;e<b.length&&(d+=b[e]+"/",b[e+1]!=a);e++);return c.directory=d,c.path=d+a,c.children={},c},_extractPathNodes:function(a){"string"!=typeof a&&(a="");for(var b=a.split("/"),c=[],d=0,e=b.length;e>d;d++)""!==b[d]&&c.push(b[d]);return c},addChanges:function(a,b){if("undefined"!=typeof a||!a)for(var c=0,d=a.length;d>c;c++)this._executeChange(a[c]);this.debug("Tree structure after updating"),this.debug(this._root),this.debug("Updating the current files"),this.openPath(this._currentPath,!1),this.debug(this._currentFiles),b&&this._updateViews(!0,!0,!0)},_executeChange:function(a){switch(a.type){case"delete":this._deleteNode(a.file);break;case"create":this._setFile(a.file);break;case"update":case"rename":case"move":this._updateNode(a.file,a.updatedfile)}},_updateNode:function(a,b){var c=this._findNodeIfExists(a.directory);if(c!==!1||"undefined"!=typeof c.children[a.name]){var d=c.children[a.name],e=this._formatPath(d.path);b.path=b.directory+b.name;var f=$.extend(!0,d,b),g=this._formatPath(b.path);e!=g&&(f=this._updateChildPaths(f),this._deleteNode(a)),this._setFile(f)}},_updateChildPaths:function(a){if("undefined"!=typeof a.children){var b=[];for(var c in a.children)b.push(c);for(var d=0,e=b.length;e>d;d++)if("undefined"!=typeof a.children[b[d]]){var f=a.children[b[d]];f.directory=this._formatPath(a.path),f.path=this._formatPath(a.path)+f.name,a.children[b[d]]=this._updateChildPaths(f)}}return a},_formatPath:function(a,b){return"undefined"==typeof a&&(a=""),0!==a.length&&"/"==a.substr(0,1)&&(a=a.substr(1,a.length-1)),b!==!0&&0!==a.length&&"/"!=a.substr(a,a.length-1)&&(a+="/"),a=a.replace(/\/\/+/g,"/")},_deleteNode:function(a){var b=this._findNodeIfExists(a.directory);b!==!1&&delete b.children[a.name]},_findNodeIfExists:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];if("undefined"==typeof c.children[f]){c=!1;break}c=c.children[f]}return c},flattenTree:function(a){var b=this.toJstreeData(this._root.children,a);return this._walk_itteration=0,this.debug("JsTree data updated"),this.debug(b),b},toJstreeData:function(a,b){"undefined"==typeof a&&(a=this._root.children);var c=[];for(var d in a){var e=a[d];if(!b||b===!0&&("undefined"==typeof e.type||"dir"===e.type)){this._walk_itteration++;var f={text:e.name};if(f.li_attr={id:"js_tree_file_"+this._walk_itteration,"data-path":e.path,"data-synchronized":"undefined"==typeof e._generated},f.state={opened:this._isOpenedDirectory(e),selected:!1,disabled:"undefined"!=typeof e.disabled&&1==e.disabled},"object"==typeof e.children&&null!==e.children){var g=[];for(var h in e.children)g.push(h);g.length>0&&(f.children=this.toJstreeData(e.children,b))}c.push(f)}}return c},openPath:function(a,b){this._currentPath=a;var c=this._findNodeIfExists(a);if(c===!1)this._currentPath=a,this._currentFiles=[];else if(""!==a&&c==this._root)this._currentFiles=[];else{var d=[];for(var e in c.children)d.push(c.children[e]);this.setContents(d)}b&&this._updateViews(!0,!0,!0)},_isOpenedDirectory:function(a){for(var b=this._extractPathNodes(this._currentPath),c=this._extractPathNodes(this._formatPath(a.path)),d=!1,e=0,f=c.length;f>e;e++)d=b[e]===c[e];
return d},_naturalFilemanagerSort:function(a,b){var c=a.type,d=b.type;return"dir"==c&&"dir"!=d?-1:"dir"!=c&&"dir"==d?1:String(a.name).toLowerCase()<String(b.name).toLowerCase()?-1:String(a.name).toLowerCase()>String(b.name).toLowerCase()?1:0},sortContent:function(a){"function"!=typeof a&&(a=this._naturalFilemanagerSort),String(this._currentContentSort)==String(a)?this._reverse=!this._reverse:this._reverse=!1,this._currentContentSort=a,this._updateViews(!1,!0,!1)},resetSort:function(){this.sortContent(this._naturalFilemanagerSort)},_updateViews:function(a,b,c){1==a&&this._eventHandler.trigger("filemanager:model:directories_changed",this.flattenTree(!0)),1==b&&(this._currentFiles.sort(this._currentContentSort),this._reverse&&this._currentFiles.reverse(),this._eventHandler.trigger("filemanager:model:content_changed",this._currentFiles)),1==c&&this._eventHandler.trigger("filemanager:model:path_changed",this._currentPath)},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},debug:function(a){"string"==typeof a&&(a="FileTree: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:add_data",function(b){a.addFiles(b.contents),a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:api:update_data",function(b){a.addChanges(b.contents,!0),1==b.selected&&a._eventHandler.trigger("filemanager:model:select",{file:b.contents[0].file})}),this._eventHandler.register("filemanager:api:search_data",function(b){a.setContents(b.contents),a._updateViews(!1,!0,!1)}),this._eventHandler.register("filemanager:view:directory_up",function(b){a.moveUpDirectory()}),this._eventHandler.register("filemanager:view:sort",function(b){void 0!==b&&"function"==typeof b.sortfunction?a.sortContent(b.sortfunction):a.sortContent()}),this._eventHandler.register("filemanager:view:open",function(b){b.isSynchronized&&a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:view:refresh",function(b){a.refresh()}),this._eventHandler.register("filemanager:api:refresh",function(b){a.refresh()})},refresh:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._currentPath,isSynchronized:!1})},moveUpDirectory:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._getHigherDirectory(a._currentPath),isSynchronized:!1})},search:function(a){var b=this;this._eventHandler.trigger("filemanager:view:search",{directory:b._currentPath,query:a})},getCurrentPath:function(){return this._currentPath}};var FileTreeView=function(a,b){var c={debug:!1,i18n:{rename:"Rename",cut:"Cut",paste:"Paste",download:"Download","delete":"Delete"}};this.options=$.extend(!0,c,a),this.init(this.options,b)};FileTreeView.prototype={_debug:!1,_eventHandler:!1,_container:!1,_directoryElement:!1,_contentElement:!1,_uploadLink:!1,_uploadFunctionalityReference:null,_viewFormat:"list",_keepFocusOnDirectories:!1,_keepFocusOnContent:!1,_currentDirectory:"",_currentContent:[],_searching:!1,_searchQuery:"",_apiCalled:!1,_isMultiple:!1,_selectedFiles:[],_editContext:{mode:"none",selector:!1,file:!1},_i18n:{},init:function(a,b){this._debug=a.debug,this._container=$(b),this._directoryElement=$("[data-fm-value=directories]"),this._eventHandler=a.eventHandler,"function"==typeof a.filerowFormat&&(this._formatFilerow=a.filerowFormat),"function"==typeof a.fileCellFormat&&(this._formatFilecell=a.fileCellFormat),"function"==typeof a.renamerowFormat&&(this._formatRenamerow=a.renamerowFormat),"function"==typeof a.renamecellFormat&&(this._formatRenamecell=a.renamecellFormat),"function"==typeof a.uploadFormat&&(this._formatUpload=a.uploadFormat),"object"==typeof a.i18n&&(this._i18n=a.i18n),this._setOverviewLayout("list"),this._addFunctionality(),this._registerEvents()},_formatFilerow:function(a){return'<p class="filemanagerrow"><span>'+a.path+"</span></p>"},_formatFilecell:function(a){return'<p class="filemanagercell"><span>'+a.path+"</span></p>"},_formatRenamerow:function(a){return'<p class="filemanagerrow"><span>'+a.name+"</span></p>"},_formatRenamecell:function(a){return'<p class="filemanagercell"><span>'+a.name+"</span></p>"},refreshTitlebar:function(a){this.debug("Refreshing directory string to "+a),this._currentDirectory=a,$("[data-fm-value=current_directory]").text("/"+a),this._addUploadFunctionality()},refreshDirectories:function(a){var b=this;this._directoryElement.length>0&&"function"==typeof this._directoryElement.jstree&&this._directoryElement.jstree("destroy").jstree({core:{data:a,multiple:!1},plugins:[]}).on("dblclick.jstree",function(a){b._jstreeOpenEvent(a)}).on("keyup.jstree",function(a){13==a.keyCode&&b._jstreeOpenEvent(a)})},_createDirectory:function(a){var b,c='<input type="text" name="directory_name"/>',d={name:c,type:"dir",date_modified:"",size:"",children:{}};"list"==this._viewFormat?b=$(this._formatRenamerow(d)):"grid"==this._viewFormat&&(b=$(this._formatRenamecell(d)));var e=this,f=b.find("input[name=directory_name]");f.on("keydown",{directory:a},function(a){13==a.keyCode&&(""!=a.target.value&&e._eventHandler.trigger("filemanager:view:create",{directory:a.data.directory,name:a.target.value}),e._contentElement.children().eq(0).remove())}).on("blur",function(a){e._contentElement.children().eq(0).remove()}),this._contentElement.prepend(b),f.focus()},refreshContent:function(a){var b=this;if(void 0!==a&&(this._currentContent=a),this._contentElement.length>0){this._contentElement.empty(),$.contextMenu("destroy");for(var c=0,d=b._currentContent.length;d>c;c++){var e=$.extend({},b._currentContent[c]),f=$.extend({},b._currentContent[c]);1==b._searching&&(f.name=f.name.replace(this._searchQuery,'<span class="searchquery">'+this._searchQuery+"</span>")),f.size=this._filesizeFormat(f.size);var g="";g="list"==b._viewFormat?this._formatFilerow(f):this._formatFilecell(f);for(var h=this._generateFileSelector(e),i=$(g).attr("data-fm-functionality","file-"+e.directory+e.name).appendTo(this._contentElement).on("click",{file:e,selector:h},function(a){$(window).width()<=768?b._openContentEvent(a):b._toggleSelection(a)}).on("keyup",{file:e,selector:h},function(a){13==a.keyCode&&(b._keepFocusOnContent=!0,b._openContentEvent(a))}).on("keydown",{file:e,selector:h},function(a){a.ctrlKey&&88==a.keyCode?b._setCutMode(a.data.selector,a.data.file):a.ctrlKey&&86==a.keyCode&&"none"!==b._editContext.mode&&b._pasteMode(a.data.selector,a.data.file)}).on("dblclick",{file:e,selector:h},function(a){b._openContentEvent(a)}),j=0,k=this._selectedFiles.length;k>j;j++)this._selectedFiles[j].selector==h&&i.addClass("selected");b._addContextmenuToElement(h,e),0==c&&1==b._keepFocusOnContent&&(i.focus(),b._keepFocusOnContent=!1)}}this._setEditStyling(),this._updateVisibility(),b._addContextmenuToElement("[data-fm-functionality=directory_up]",{type:"dir",name:"",directory:b._currentDirectory},!0),b._eventHandler.trigger("filemanager:view:rendered")},_addContextmenuToElement:function(a,b,c){var d=this;$.contextMenu({selector:a,build:function(){var a={rename:{name:d._i18n.rename,icon:"rename"},cut:{name:d._i18n.cut,icon:"cut"},paste:{name:d._i18n.paste,icon:"paste"}};return"dir"!==b.type&&(a.download={name:d._i18n.download,icon:"download"}),a.seperator="---------",a["delete"]={name:d._i18n["delete"],icon:"delete"},c===!0?(a={},"none"!==d._editContext.mode&&(a.paste={name:d._i18n.paste,icon:"paste"})):"none"!==d._editContext.mode?a.paste.disabled=!1:a.paste.disabled=!0,{file:b,callback:function(a,b){switch(a){case"rename":d.createRenamerow(b.selector,b.file);break;case"cut":d._setCutMode(b.selector,b.file);break;case"paste":d._pasteMode(b.selector,b.file);break;case"delete":d._eventHandler.trigger("filemanager:view:delete",{file:b.file});break;case"download":d._eventHandler.trigger("filemanager:view:download",{file:b.file})}},items:a}}})},_generateFileSelector:function(a){var b="file-"+a.directory+a.name;return'[data-fm-functionality="'+b+'"]'},createRenamerow:function(a,b){var c=this._contentElement.find(a),d=this,e=$.extend({},b);e.name='<input type="text" name="file_name" value="'+b.name+'"/>';var f;"list"==this._viewFormat?f=$(d._formatRenamerow(e)):"grid"==this._viewFormat&&(f=$(d._formatRenamecell(e)));var g=f.find("input");g.on("keydown",{file:b},function(a){13==a.keyCode&&(""!=a.target.value&&d._renameEvent(a),d._contentElement.find(f).remove(),d._contentElement.find(c).show())}).on("blur",function(a){d._contentElement.find(f).remove(),d._contentElement.find(c).show()}),d._contentElement.find(c).hide().after(f);var h=g.val();g.val("").focus().val(h)},_openContentEvent:function(a){var b=(a.data.file.directory,a.data.file.path);if(0==b&&(b=a.data.file.directory+a.data.file.name),"undefined"==typeof a.data.file.type||"dir"==a.data.file.type){var c=!1;this._eventHandler.trigger("filemanager:view:open",{directory:b,isSynchronized:c})}else this._toggleSelection(a)},_toggleSelection:function(a){this._isFileSelected(a.data.file)?this._deselectEvent(a):this._selectEvent(a)},_selectEvent:function(a){0==this._isMultiple&&this._clearSelection(),this._selectedFiles.push({selector:a.data.selector,file:a.data.file}),$(a.data.selector).addClass("selected"),this._eventHandler.trigger("filemanager:view:select",{path:a.data.file.path,file:a.data.file})},_isFileSelected:function(a){for(var b=0,c=this._selectedFiles.length;c>b;b++)if(a==this._selectedFiles[b].file)return!0;return!1},_deselectEvent:function(a){for(var b=[],c=0,d=this._selectedFiles.length;d>c;c++)a.data.file==this._selectedFiles[c].file?$(a.data.selector).removeClass("selected"):b=this._selectedFiles[c];this._selectedFiles=b,this._eventHandler.trigger("filemanager:view:deselect",{path:a.data.file.path,file:a.data.file})},_clearSelection:function(){for(var a=0,b=this._selectedFiles.length;b>a;a++)$(this._selectedFiles[a].selector).removeClass("selected");this._selectedFiles=[]},_jstreeOpenEvent:function(a){var b=$(a.target).closest("li");if(b.length>0){var c=b.attr("data-path"),d="false"!=b.attr("data-synchronized");"undefined"!=typeof c&&this._eventHandler.trigger("filemanager:view:open",{directory:c,isSynchronized:!d})}},_searchEvent:function(a){var b=a.target.value;""!=b?(this._eventHandler.trigger("filemanager:view:search",{directory:this._currentDirectory,query:b}),$("[data-fm-value=search_query]").text(b)):this._eventHandler.trigger("filemanager:view:open",{directory:this._currentDirectory,isSynchronized:!1})},_renameEvent:function(a){var b=a.target.value;""!=b&&this._eventHandler.trigger("filemanager:view:rename",{file:a.data.file,newname:b})},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},_filesizeFormat:function(a){var b=1024,c=1024*b,d=1024*c,e="";return 0==isNaN(a)&&(a=parseInt(a),e=b>a?a+" B":c>a?(a/b).toFixed(1)+" KB":d>a?(a/c).toFixed(1)+" MB":(a/d).toFixed(1)+" GB"),e},_setOverviewLayout:function(a){"list"==a||"grid"==a?(this._viewFormat=a,"list"==this._viewFormat?($("[data-fm-functionality=set_list]").addClass("selected"),$("[data-fm-functionality=set_grid]").removeClass("selected"),this._contentElement=$("[data-fm-value=list_content]")):"grid"==this._viewFormat&&($("[data-fm-functionality=set_grid]").addClass("selected"),$("[data-fm-functionality=set_list]").removeClass("selected"),this._contentElement=$("[data-fm-value=grid_content]")),this._updateVisibility()):this.errorLog("Overview layout can only be a list or a grid")},_resetEditStyles:function(){this._editMode="none",this._editContext.selector!==!1&&($(this._editContext.selector).removeClass("mode-cut").removeClass("mode-copy"),this._editContext.selector=!1),this._editContext.file=!1},_setEditStyling:function(){var a=this._editContext;if(a.file!==!1&&a.selector!==!1)switch(a.mode){case"cut":$(a.selector).addClass("mode-cut");break;case"copy":$(a.selector).addClass("mode-copy");break;case"none":this._resetEditStyles()}},_setCutMode:function(a,b){this._resetEditStyles(),this._editContext={mode:"cut",selector:a,file:b},this._setEditStyling()},_setCopyMode:function(a,b){this._resetEditStyles(),this._editContext=this._editContext={mode:"copy",selector:a,file:b},this._setEditStyling()},_pasteMode:function(a,b){if("none"!==this._editContext.mode&&this._editContext.file!==!1){var c=b.directory;"dir"==b.type&&(c+=b.name),this._eventHandler.trigger("filemanager:view:move",{file:this._editContext.file,newlocation:c})}this._resetEditStyles()},_updateVisibility:function(){var a=function(a){return"[data-fm-show="+a+"]"};"list"==this._viewFormat?($(a("list_view")).show(),$(a("grid_view")).hide()):"grid"==this._viewFormat&&($(a("list_view")).hide(),$(a("grid_view")).show()),$(a("no_content")).hide(),$(a("no_search_results")).hide(),0==this._currentContent.length?0==this._searching?this._apiCalled&&$(a("no_content")).show():$(a("no_search_results")).show():1==this._searching&&$(a("search_results")).show(),""!==this._currentDirectory?$(a("no_root")).show():$(a("no_root")).hide()},_addFunctionality:function(){var a=this,b=function(a){13==a.keyCode&&(a.preventDefault(),$(a.target).addClass("active").trigger("mousedown"))},c=function(a){13==a.keyCode&&$(a.currentTarget).removeClass("active").trigger("click")};$("[data-fm-functionality=directory_up]").on("click",function(b){a._eventHandler.trigger("filemanager:view:directory_up",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=refresh]").on("click",function(){a._eventHandler.trigger("filemanager:view:refresh",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=create_directory]").on("click",function(b){a._createDirectory(a._currentDirectory)}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_list]").on("click",function(b){a._setOverviewLayout("list"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_grid]").on("click",function(b){a._setOverviewLayout("grid"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality^='sort_']").on("click",function(b){var c=$(b.currentTarget).attr("data-fm-functionality"),d=c.substring(5);"filename"===d?a._eventHandler.trigger("filemanager:view:sort"):a._eventHandler.trigger("filemanager:view:sort",{sortfunction:function(a,b){return a[d]>b[d]?-1:a[d]<b[d]?1:0}})}).on("keydown",b).on("keyup",c),$("input[data-fm-functionality=search]").on("search",{directory:a._currentDirectory},function(b){a._searchEvent(b)}).on("keydown",function(a){13==a.keyCode&&a.preventDefault()}).on("keyup",{directory:a._currentDirectory},function(b){13==b.keyCode&&a._searchEvent(b)}),a._addUploadFunctionality()},_addUploadFunctionality:function(){var a=this;null!==this._uploadFunctionalityReference&&this._uploadFunctionalityReference.destroy();var b=$("[data-fm-functionality=upload_progress]"),c=new ss.SimpleUpload({url:"/admin/fileapi/create",name:"filemanager_upload",method:"POST",hoverClass:"focus",focusClass:"active",multipart:!0,data:{filemanager_directory:a._currentDirectory},responseType:"json",dropzone:"filemanager_view",debug:a._debug,startXHR:function(){b.length>0&&(b.css("width","0%"),this.setProgressBar(b)),a._eventHandler.trigger("filemanager:api:uploading")},onComplete:function(b,c){a._eventHandler.trigger("filemanager:api:upload_done"),a._eventHandler.trigger("filemanager:view:ajax_upload",{response:c,directory:a._currentDirectory})},onAbort:function(){a._eventHandler.trigger("filemanager:api:upload_done")},onError:function(b,c,d,e,f){a._eventHandler.trigger("filemanager:api:upload_done"),f=JSON.parse(f),0!=f&&a._eventHandler.trigger("filemanager:api:error",{message:f.data.message,status:e,statuscode:d})}});if(c.setAbortBtn($("[data-fm-functionality=abort_upload]")),null===this._uploadFunctionalityReference){var d=$("[data-fm-functionality=upload_button]");0!==d.length&&d.on("click",function(){$("input[name=filemanager_upload]").trigger("click")}).on("keydown",function(a){13==a.keyCode&&(d.addClass("active"),a.preventDefault())}).on("keyup",function(a){13==a.keyCode&&(d.removeClass("active"),$("input[name=filemanager_upload]").trigger("click"))})}this._uploadFunctionalityReference=c},debug:function(a){"string"==typeof a&&(a="FileTreeView: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:error",function(b){a._apiCalled=!0,alert(b.message)}),this._eventHandler.register("filemanager:model:directories_changed",function(b){a._apiCalled=!0,a._searching=!1,a._searchQuery="",a.refreshDirectories(b)}),this._eventHandler.register("filemanager:view:search",function(b){a._apiCalled=!0,a._searching=!0,a._searchQuery=b.query}),this._eventHandler.register("filemanager:model:content_changed",function(b){a._apiCalled=!0,a.refreshContent(b)}),this._eventHandler.register("filemanager:model:path_changed",function(b){a._apiCalled=!0,a.refreshTitlebar(b)}),this._eventHandler.register("filemanager:model:select",function(b){var c={data:{file:b.file,selector:a._generateFileSelector(b.file)}};a._selectEvent(c)})}};var FilemanagerAPI=function(a){var b={debug:!1,api:{url:window.location.href,paths:{create:"/create",read:"",search:"/search",move:"/move",rename:"/rename","delete":"/delete",download:"/download"}}};this.options=$.extend(!0,b,a),this.init(this.options)};FilemanagerAPI.prototype={_debug:!1,_url:"",_path_create:"",_path_move:"",_path_rename:"",_path_read_directory:"",_path_delete:"",_path_search:"",_path_download:"",_eventHandler:!1,_disableRequests:!1,init:function(a){return null!==a&&"object"==typeof a&&(this._eventHandler=a.eventHandler,"undefined"!=typeof a.debug&&(this._debug=a.debug),null!==a.api&&"object"==typeof a.api&&("undefined"!=typeof a.api.url&&""!=a.api.url?this._url=a.api.url:(this._disableRequests=!0,console.error("NO APILINK FOUND !!!")),null!==a.api.paths&&"object"==typeof a.api.paths&&("undefined"!=typeof a.api.paths.move&&(this._path_move=a.api.paths.move),"undefined"!=typeof a.api.paths.rename&&(this._path_rename=a.api.paths.rename),"undefined"!=typeof a.api.paths.create&&(this._path_create=a.api.paths.create),"undefined"!=typeof a.api.paths["delete"]&&(this._path_delete=a.api.paths["delete"]),"undefined"!=typeof a.api.paths.read&&(this._path_read_directory=a.api.paths.read),"undefined"!=typeof a.api.paths.search&&(this._path_search=a.api.paths.search),"undefined"!=typeof a.api.paths.download&&(this._path_download=a.api.paths.download))),"string"==typeof a.api.startingDirectory&&this.read(a.api.startingDirectory)),this._registerEvents(),this.debug("Initializing"),this.debug(a),this},_sendRequest:function(a,b,c){"undefined"==typeof b&&(b="GET"),"object"!=typeof c&&(c={});var d=this;this._eventHandler.trigger("filemanager:api:loading");var e="",f=new RegExp("^(?:[a-z]+:)?//","i");if(f.test(a))e=a;else{var g="";g=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),e=g+a}return $.ajax({url:e,data:c,dataType:"json",method:b,self:d,beforeSend:function(a){d.debug("Sending "+this.method+" request to "+this.url+"...")}}).done(function(a){d._eventHandler.trigger("filemanager:api:done"),d.debug(a)}).fail(function(a,b,c){d._eventHandler.trigger("filemanager:api:done"),d.errorLog({statuscode:a.status,statustext:a.statusText,response:a.responseText})})},read:function(a){var b=this,c=this._url+this._path_read_directory;this._sendRequest(c,"GET",{directory:a}).done(function(c,d,e){b._eventHandler.trigger("filemanager:api:add_data",{contents:c.data.contents,directory:a})}).fail(function(a){b._handleApiError(a)})},search:function(a,b){var c=this,d=this._url+this._path_search;this._sendRequest(d,"GET",{directory:a,q:b}).done(function(d,e,f){c._eventHandler.trigger("filemanager:api:search_data",{contents:d.data.contents,directory:a,query:b})}).fail(function(a){c._handleApiError(a)})},move:function(a,b,c){var d=this,e=this._url+this._path_move,f=a+b;this._sendRequest(e,"POST",{filemanager_filepath:f,filemanager_newdirectory:c}).done(function(b,e,f){var g=[];if("object"==typeof b.data.changes)for(var h in b.data.changes)g.push(b.data.changes[h]);else g=b.data.changes;a!==c&&d._eventHandler.trigger("filemanager:api:refresh"),d._eventHandler.trigger("filemanager:api:update_data",{contents:g,directory:c})}).fail(function(a){d._handleApiError(a)})},rename:function(a,b,c){var d=this,e=this._url+this._path_rename;this._sendRequest(e,"POST",{filemanager_directory:a,filemanager_filename:b,filemanager_newfilename:c}).done(function(b,c,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;d._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){d._handleApiError(a)})},createDirectory:function(a,b){var c=this,d=this._url+this._path_create;this._sendRequest(d,"POST",{type:"directory",filemanager_directory:a,directory_name:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},"delete":function(a,b){var c=this,d=this._url+this._path_delete;this._sendRequest(d,"POST",{filemanager_directory:a,filemanager_filename:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},download:function(a){var b=this._url+this._path_download,c="?";b.indexOf(c)>-1&&(c="&"),window.location=b+c+"filemanager_path="+encodeURI(a)},uploadResponse:function(a,b){this._eventHandler.trigger("filemanager:api:done"),this._eventHandler.trigger("filemanager:api:update_data",{contents:b.data.changes,directory:a,selected:!0})},_handleApiError:function(a){var b=this,c=JSON.parse(a.responseText);b._eventHandler.trigger("filemanager:api:error",{message:c.data.message,status:c.status,statuscode:a.status})},debug:function(a){"string"==typeof a&&(a="FilemanagerAPI: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:view:open",function(b){0==b.isSynchronized&&a.read(b.directory)}),this._eventHandler.register("filemanager:view:search",function(b){a.search(b.directory,b.query)}),this._eventHandler.register("filemanager:view:create",function(b){a.createDirectory(b.directory,b.name)}),this._eventHandler.register("filemanager:view:rename",function(b){a.rename(b.file.directory,b.file.name,b.newname)}),this._eventHandler.register("filemanager:view:move",function(b){a.move(b.file.directory,b.file.name,b.newlocation)}),this._eventHandler.register("filemanager:view:delete",function(b){a["delete"](b.file.directory,b.file.name)}),this._eventHandler.register("filemanager:view:ajax_upload",function(b){a.uploadResponse(b.directory,b.response)}),this._eventHandler.register("filemanager:view:download",function(b){a.download(b.file.path)})}};var FilemanagerEventHandler=function(a){var b={debug:!1};a=$.extend(!0,b,a),this.init(a)};FilemanagerEventHandler.prototype={_events:{},_debug:!1,init:function(a){null!==a&&"object"==typeof a&&"undefined"!=typeof a.debug&&(this._debug=a.debug)},hasEvent:function(a,b){if(this._events.hasOwnProperty(a))return!0;if(b)throw'No event registered for "'+a+'"';return!1},register:function(a,b){this.debug("Registering "+a),this._create(a),this._events[a].push(b)},unRegister:function(a){this.hasEvent(a,!0)&&delete this._events[a]},_create:function(a){this.hasEvent(a,!1)||(this._events[a]=[])},trigger:function(a){if(this.debug("Triggering "+a),this.hasEvent(a,!1)){var b=Array.prototype.slice.call(arguments,1);$.each(this._events[a],function(a,c){c.apply(c,b)}.bind(this))}},debug:function(a){this._debug&&console.log(a)}},function(){$.fn.filemanager=function(a){if("undefined"==typeof a&&(a={}),a.eventHandler=new FilemanagerEventHandler(a),null!==a.api&&"object"==typeof a.api)if("undefined"!=typeof a.api.url&&""!=a.api.url){this.data("event",a.eventHandler),this.data("view",new FileTreeView(a)),this.data("api",new FilemanagerAPI(a)),this.data("tree",new FileTree(a));var b=this,c={refresh:function(){return b.data("tree").refresh(),b},moveUpDirectory:function(){b.data("tree").moveUpDirectory()},createDirectory:function(){var a=b.data("tree").getCurrentPath();return b.data("view")._createDirectory(a),b},search:function(a){return b.data("tree").search(a),b},on:function(a,c){return b.data("event").register(a,c),b}};this.data("filemanager",c)}else console.error("Filemanager: NO APILINK FOUND - Aborting creation");else console.error("Filemanager: NO APILINK FOUND - Aborting creation");return this}}(jQuery);var FileTree=function(a){var b={debug:!1};this.options=$.extend(!0,b,a),this.init(this.options)};FileTree.prototype={_debug:!1,_root:{children:{}},_currentPath:"",_currentFiles:[],_currentContentSort:null,_reverse:!1,_walk_itteration:0,_eventHandler:null,init:function(a){return null!==a&&"object"==typeof a&&(this._debug=a.debug,this._eventHandler=a.eventHandler,this._registerEvents()),this._currentContentSort=this._naturalFilemanagerSort,this.debug("Initializing"),this.debug(a),this},addFiles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];this._setFile(e)}this.debug("Tree structure after updating"),this.debug(this._root),1==b&&this._updateViews(!0,!1,!1)},setContents:function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.path=this._formatPath(e.path,!0),e.directory=this._formatPath(e.directory),b.push(e)}this._currentFiles=b},_setFile:function(a){0==a.hasOwnProperty("path")&&(a.path=this._formatPath(a.directory)+a.name),a.path=this._formatPath(a.path,!0),a.directory=this._formatPath(a.directory),0==a.hasOwnProperty("children")&&(a.children={});var b=this._findNode(a.directory);"undefined"==typeof b.children[a.name]?b.children[a.name]=a:b.children[a.name]=$.extend(!0,b.children[a.name],a)},_findNode:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];"undefined"==typeof c.children[f]&&(c.children[f]=this._generateNode(f,b)),c=c.children[f]}return"undefined"==typeof c.children&&(c.children={}),c},_generateNode:function(a,b){var c={};c.name=a;for(var d="",e=0;e<b.length&&(d+=b[e]+"/",b[e+1]!=a);e++);return c.directory=d,c.path=d+a,c.children={},c},_extractPathNodes:function(a){"string"!=typeof a&&(a="");for(var b=a.split("/"),c=[],d=0,e=b.length;e>d;d++)""!==b[d]&&c.push(b[d]);return c},addChanges:function(a,b){if("undefined"!=typeof a||!a)for(var c=0,d=a.length;d>c;c++)this._executeChange(a[c]);this.debug("Tree structure after updating"),this.debug(this._root),this.debug("Updating the current files"),this.openPath(this._currentPath,!1),this.debug(this._currentFiles),b&&this._updateViews(!0,!0,!0)},_executeChange:function(a){switch(a.type){case"delete":this._deleteNode(a.file);break;case"create":this._setFile(a.file);break;case"update":case"rename":case"move":this._updateNode(a.file,a.updatedfile)}},_updateNode:function(a,b){var c=this._findNodeIfExists(a.directory);if(c!==!1||"undefined"!=typeof c.children[a.name]){var d=c.children[a.name],e=this._formatPath(d.path);b.path=b.directory+b.name;var f=$.extend(!0,d,b),g=this._formatPath(b.path);e!=g&&(f=this._updateChildPaths(f),this._deleteNode(a)),this._setFile(f)}},_updateChildPaths:function(a){if("undefined"!=typeof a.children){var b=[];for(var c in a.children)b.push(c);for(var d=0,e=b.length;e>d;d++)if("undefined"!=typeof a.children[b[d]]){var f=a.children[b[d]];f.directory=this._formatPath(a.path),f.path=this._formatPath(a.path)+f.name,a.children[b[d]]=this._updateChildPaths(f)}}return a},_formatPath:function(a,b){return"undefined"==typeof a&&(a=""),0!==a.length&&"/"==a.substr(0,1)&&(a=a.substr(1,a.length-1)),b!==!0&&0!==a.length&&"/"!=a.substr(a,a.length-1)&&(a+="/"),a=a.replace(/\/\/+/g,"/")},_deleteNode:function(a){var b=this._findNodeIfExists(a.directory);b!==!1&&delete b.children[a.name]},_findNodeIfExists:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];if("undefined"==typeof c.children[f]){c=!1;break}c=c.children[f]}return c},flattenTree:function(a){var b=this.toJstreeData(this._root.children,a);return this._walk_itteration=0,this.debug("JsTree data updated"),this.debug(b),b},toJstreeData:function(a,b){"undefined"==typeof a&&(a=this._root.children);var c=[];for(var d in a){var e=a[d];if(!b||b===!0&&("undefined"==typeof e.type||"dir"===e.type)){this._walk_itteration++;var f={text:e.name};if(f.li_attr={id:"js_tree_file_"+this._walk_itteration,"data-path":e.path,"data-synchronized":"undefined"==typeof e._generated},f.state={opened:this._isOpenedDirectory(e),selected:!1,disabled:"undefined"!=typeof e.disabled&&1==e.disabled},"object"==typeof e.children&&null!==e.children){var g=[];for(var h in e.children)g.push(h);g.length>0&&(f.children=this.toJstreeData(e.children,b))}c.push(f)}}return c},openPath:function(a,b){this._currentPath=a;var c=this._findNodeIfExists(a);if(c===!1)this._currentPath=a,this._currentFiles=[];else if(""!==a&&c==this._root)this._currentFiles=[];else{var d=[];for(var e in c.children)d.push(c.children[e]);this.setContents(d)}b&&this._updateViews(!0,!0,!0)},_isOpenedDirectory:function(a){for(var b=this._extractPathNodes(this._currentPath),c=this._extractPathNodes(this._formatPath(a.path)),d=!1,e=0,f=c.length;f>e;e++)d=b[e]===c[e];return d},_naturalFilemanagerSort:function(a,b){var c=a.type,d=b.type;return"dir"==c&&"dir"!=d?-1:"dir"!=c&&"dir"==d?1:String(a.name).toLowerCase()<String(b.name).toLowerCase()?-1:String(a.name).toLowerCase()>String(b.name).toLowerCase()?1:0},sortContent:function(a){"function"!=typeof a&&(a=this._naturalFilemanagerSort),String(this._currentContentSort)==String(a)?this._reverse=!this._reverse:this._reverse=!1,this._currentContentSort=a,this._updateViews(!1,!0,!1)},resetSort:function(){this.sortContent(this._naturalFilemanagerSort)},_updateViews:function(a,b,c){1==a&&this._eventHandler.trigger("filemanager:model:directories_changed",this.flattenTree(!0)),1==b&&(this._currentFiles.sort(this._currentContentSort),this._reverse&&this._currentFiles.reverse(),this._eventHandler.trigger("filemanager:model:content_changed",this._currentFiles)),1==c&&this._eventHandler.trigger("filemanager:model:path_changed",this._currentPath)},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},debug:function(a){"string"==typeof a&&(a="FileTree: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:add_data",function(b){a.addFiles(b.contents),a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:api:update_data",function(b){a.addChanges(b.contents,!0),1==b.selected&&a._eventHandler.trigger("filemanager:model:select",{file:b.contents[0].file})}),this._eventHandler.register("filemanager:api:search_data",function(b){a.setContents(b.contents),a._updateViews(!1,!0,!1)}),this._eventHandler.register("filemanager:view:directory_up",function(b){a.moveUpDirectory()}),this._eventHandler.register("filemanager:view:sort",function(b){void 0!==b&&"function"==typeof b.sortfunction?a.sortContent(b.sortfunction):a.sortContent()}),this._eventHandler.register("filemanager:view:open",function(b){b.isSynchronized&&a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:view:refresh",function(b){a.refresh()}),this._eventHandler.register("filemanager:api:refresh",function(b){a.refresh()})},refresh:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._currentPath,isSynchronized:!1
})},moveUpDirectory:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._getHigherDirectory(a._currentPath),isSynchronized:!1})},search:function(a){var b=this;this._eventHandler.trigger("filemanager:view:search",{directory:b._currentPath,query:a})},getCurrentPath:function(){return this._currentPath}};var FileTreeView=function(a,b){var c={debug:!1,i18n:{rename:"Rename",cut:"Cut",paste:"Paste",download:"Download","delete":"Delete"}};this.options=$.extend(!0,c,a),this.init(this.options,b)};FileTreeView.prototype={_debug:!1,_eventHandler:!1,_container:!1,_directoryElement:!1,_contentElement:!1,_uploadLink:!1,_uploadFunctionalityReference:null,_viewFormat:"list",_keepFocusOnDirectories:!1,_keepFocusOnContent:!1,_currentDirectory:"",_currentContent:[],_searching:!1,_searchQuery:"",_apiCalled:!1,_isMultiple:!1,_selectedFiles:[],_editContext:{mode:"none",selector:!1,file:!1},_i18n:{},init:function(a,b){this._debug=a.debug,this._container=$(b),this._directoryElement=$("[data-fm-value=directories]"),this._eventHandler=a.eventHandler,"function"==typeof a.filerowFormat&&(this._formatFilerow=a.filerowFormat),"function"==typeof a.fileCellFormat&&(this._formatFilecell=a.fileCellFormat),"function"==typeof a.renamerowFormat&&(this._formatRenamerow=a.renamerowFormat),"function"==typeof a.renamecellFormat&&(this._formatRenamecell=a.renamecellFormat),"function"==typeof a.uploadFormat&&(this._formatUpload=a.uploadFormat),"object"==typeof a.i18n&&(this._i18n=a.i18n),this._setOverviewLayout("list"),this._addFunctionality(),this._registerEvents()},_formatFilerow:function(a){return'<p class="filemanagerrow"><span>'+a.path+"</span></p>"},_formatFilecell:function(a){return'<p class="filemanagercell"><span>'+a.path+"</span></p>"},_formatRenamerow:function(a){return'<p class="filemanagerrow"><span>'+a.name+"</span></p>"},_formatRenamecell:function(a){return'<p class="filemanagercell"><span>'+a.name+"</span></p>"},refreshTitlebar:function(a){this.debug("Refreshing directory string to "+a),this._currentDirectory=a,$("[data-fm-value=current_directory]").text("/"+a),this._addUploadFunctionality()},refreshDirectories:function(a){var b=this;this._directoryElement.length>0&&"function"==typeof this._directoryElement.jstree&&this._directoryElement.jstree("destroy").jstree({core:{data:a,multiple:!1},plugins:[]}).on("dblclick.jstree",function(a){b._jstreeOpenEvent(a)}).on("keyup.jstree",function(a){13==a.keyCode&&b._jstreeOpenEvent(a)})},_createDirectory:function(a){var b,c='<input type="text" name="directory_name"/>',d={name:c,type:"dir",date_modified:"",size:"",children:{}};"list"==this._viewFormat?b=$(this._formatRenamerow(d)):"grid"==this._viewFormat&&(b=$(this._formatRenamecell(d)));var e=this,f=b.find("input[name=directory_name]");f.on("keydown",{directory:a},function(a){13==a.keyCode&&(""!=a.target.value&&e._eventHandler.trigger("filemanager:view:create",{directory:a.data.directory,name:a.target.value}),e._contentElement.children().eq(0).remove())}).on("blur",function(a){e._contentElement.children().eq(0).remove()}),this._contentElement.prepend(b),f.focus()},refreshContent:function(a){var b=this;if(void 0!==a&&(this._currentContent=a),this._contentElement.length>0){this._contentElement.empty(),$.contextMenu("destroy");for(var c=0,d=b._currentContent.length;d>c;c++){var e=$.extend({},b._currentContent[c]),f=$.extend({},b._currentContent[c]);1==b._searching&&(f.name=f.name.replace(this._searchQuery,'<span class="searchquery">'+this._searchQuery+"</span>")),f.size=this._filesizeFormat(f.size);var g="";g="list"==b._viewFormat?this._formatFilerow(f):this._formatFilecell(f);for(var h=this._generateFileSelector(e),i=$(g).attr("data-fm-functionality","file-"+e.directory+e.name).appendTo(this._contentElement).on("click",{file:e,selector:h},function(a){$(window).width()<=768?b._openContentEvent(a):b._toggleSelection(a)}).on("keyup",{file:e,selector:h},function(a){13==a.keyCode&&(b._keepFocusOnContent=!0,b._openContentEvent(a))}).on("keydown",{file:e,selector:h},function(a){a.ctrlKey&&88==a.keyCode?b._setCutMode(a.data.selector,a.data.file):a.ctrlKey&&86==a.keyCode&&"none"!==b._editContext.mode&&b._pasteMode(a.data.selector,a.data.file)}).on("dblclick",{file:e,selector:h},function(a){b._openContentEvent(a)}),j=0,k=this._selectedFiles.length;k>j;j++)this._selectedFiles[j].selector==h&&i.addClass("selected");b._addContextmenuToElement(h,e),0==c&&1==b._keepFocusOnContent&&(i.focus(),b._keepFocusOnContent=!1)}}this._setEditStyling(),this._updateVisibility(),b._addContextmenuToElement("[data-fm-functionality=directory_up]",{type:"dir",name:"",directory:b._currentDirectory},!0),b._eventHandler.trigger("filemanager:view:rendered")},_addContextmenuToElement:function(a,b,c){var d=this;$.contextMenu({selector:a,build:function(){var a={rename:{name:d._i18n.rename,icon:"rename"},cut:{name:d._i18n.cut,icon:"cut"},paste:{name:d._i18n.paste,icon:"paste"}};return"dir"!==b.type&&(a.download={name:d._i18n.download,icon:"download"}),a.seperator="---------",a["delete"]={name:d._i18n["delete"],icon:"delete"},c===!0?(a={},"none"!==d._editContext.mode&&(a.paste={name:d._i18n.paste,icon:"paste"})):"none"!==d._editContext.mode?a.paste.disabled=!1:a.paste.disabled=!0,{file:b,callback:function(a,b){switch(a){case"rename":d.createRenamerow(b.selector,b.file);break;case"cut":d._setCutMode(b.selector,b.file);break;case"paste":d._pasteMode(b.selector,b.file);break;case"delete":d._eventHandler.trigger("filemanager:view:delete",{file:b.file});break;case"download":d._eventHandler.trigger("filemanager:view:download",{file:b.file})}},items:a}}})},_generateFileSelector:function(a){var b="file-"+a.directory+a.name;return'[data-fm-functionality="'+b+'"]'},createRenamerow:function(a,b){var c=this._contentElement.find(a),d=this,e=$.extend({},b);e.name='<input type="text" name="file_name" value="'+b.name+'"/>';var f;"list"==this._viewFormat?f=$(d._formatRenamerow(e)):"grid"==this._viewFormat&&(f=$(d._formatRenamecell(e)));var g=f.find("input");g.on("keydown",{file:b},function(a){13==a.keyCode&&(""!=a.target.value&&d._renameEvent(a),d._contentElement.find(f).remove(),d._contentElement.find(c).show())}).on("blur",function(a){d._contentElement.find(f).remove(),d._contentElement.find(c).show()}),d._contentElement.find(c).hide().after(f);var h=g.val();g.val("").focus().val(h)},_openContentEvent:function(a){var b=(a.data.file.directory,a.data.file.path);if(0==b&&(b=a.data.file.directory+a.data.file.name),"undefined"==typeof a.data.file.type||"dir"==a.data.file.type){var c=!1;this._eventHandler.trigger("filemanager:view:open",{directory:b,isSynchronized:c})}else this._toggleSelection(a)},_toggleSelection:function(a){this._isFileSelected(a.data.file)?this._deselectEvent(a):this._selectEvent(a)},_selectEvent:function(a){0==this._isMultiple&&this._clearSelection(),this._selectedFiles.push({selector:a.data.selector,file:a.data.file}),$(a.data.selector).addClass("selected"),this._eventHandler.trigger("filemanager:view:select",{path:a.data.file.path,file:a.data.file})},_isFileSelected:function(a){for(var b=0,c=this._selectedFiles.length;c>b;b++)if(a==this._selectedFiles[b].file)return!0;return!1},_deselectEvent:function(a){for(var b=[],c=0,d=this._selectedFiles.length;d>c;c++)a.data.file==this._selectedFiles[c].file?$(a.data.selector).removeClass("selected"):b=this._selectedFiles[c];this._selectedFiles=b,this._eventHandler.trigger("filemanager:view:deselect",{path:a.data.file.path,file:a.data.file})},_clearSelection:function(){for(var a=0,b=this._selectedFiles.length;b>a;a++)$(this._selectedFiles[a].selector).removeClass("selected");this._selectedFiles=[]},_jstreeOpenEvent:function(a){var b=$(a.target).closest("li");if(b.length>0){var c=b.attr("data-path"),d="false"!=b.attr("data-synchronized");"undefined"!=typeof c&&this._eventHandler.trigger("filemanager:view:open",{directory:c,isSynchronized:!d})}},_searchEvent:function(a){var b=a.target.value;""!=b?(this._eventHandler.trigger("filemanager:view:search",{directory:this._currentDirectory,query:b}),$("[data-fm-value=search_query]").text(b)):this._eventHandler.trigger("filemanager:view:open",{directory:this._currentDirectory,isSynchronized:!1})},_renameEvent:function(a){var b=a.target.value;""!=b&&this._eventHandler.trigger("filemanager:view:rename",{file:a.data.file,newname:b})},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},_filesizeFormat:function(a){var b=1024,c=1024*b,d=1024*c,e="";return 0==isNaN(a)&&(a=parseInt(a),e=b>a?a+" B":c>a?(a/b).toFixed(1)+" KB":d>a?(a/c).toFixed(1)+" MB":(a/d).toFixed(1)+" GB"),e},_setOverviewLayout:function(a){"list"==a||"grid"==a?(this._viewFormat=a,"list"==this._viewFormat?($("[data-fm-functionality=set_list]").addClass("selected"),$("[data-fm-functionality=set_grid]").removeClass("selected"),this._contentElement=$("[data-fm-value=list_content]")):"grid"==this._viewFormat&&($("[data-fm-functionality=set_grid]").addClass("selected"),$("[data-fm-functionality=set_list]").removeClass("selected"),this._contentElement=$("[data-fm-value=grid_content]")),this._updateVisibility()):this.errorLog("Overview layout can only be a list or a grid")},_resetEditStyles:function(){this._editMode="none",this._editContext.selector!==!1&&($(this._editContext.selector).removeClass("mode-cut").removeClass("mode-copy"),this._editContext.selector=!1),this._editContext.file=!1},_setEditStyling:function(){var a=this._editContext;if(a.file!==!1&&a.selector!==!1)switch(a.mode){case"cut":$(a.selector).addClass("mode-cut");break;case"copy":$(a.selector).addClass("mode-copy");break;case"none":this._resetEditStyles()}},_setCutMode:function(a,b){this._resetEditStyles(),this._editContext={mode:"cut",selector:a,file:b},this._setEditStyling()},_setCopyMode:function(a,b){this._resetEditStyles(),this._editContext=this._editContext={mode:"copy",selector:a,file:b},this._setEditStyling()},_pasteMode:function(a,b){if("none"!==this._editContext.mode&&this._editContext.file!==!1){var c=b.directory;"dir"==b.type&&(c+=b.name),this._eventHandler.trigger("filemanager:view:move",{file:this._editContext.file,newlocation:c})}this._resetEditStyles()},_updateVisibility:function(){var a=function(a){return"[data-fm-show="+a+"]"};"list"==this._viewFormat?($(a("list_view")).show(),$(a("grid_view")).hide()):"grid"==this._viewFormat&&($(a("list_view")).hide(),$(a("grid_view")).show()),$(a("no_content")).hide(),$(a("no_search_results")).hide(),0==this._currentContent.length?0==this._searching?this._apiCalled&&$(a("no_content")).show():$(a("no_search_results")).show():1==this._searching&&$(a("search_results")).show(),""!==this._currentDirectory?$(a("no_root")).show():$(a("no_root")).hide()},_addFunctionality:function(){var a=this,b=function(a){13==a.keyCode&&(a.preventDefault(),$(a.target).addClass("active").trigger("mousedown"))},c=function(a){13==a.keyCode&&$(a.currentTarget).removeClass("active").trigger("click")};$("[data-fm-functionality=directory_up]").on("click",function(b){a._eventHandler.trigger("filemanager:view:directory_up",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=refresh]").on("click",function(){a._eventHandler.trigger("filemanager:view:refresh",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=create_directory]").on("click",function(b){a._createDirectory(a._currentDirectory)}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_list]").on("click",function(b){a._setOverviewLayout("list"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_grid]").on("click",function(b){a._setOverviewLayout("grid"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality^='sort_']").on("click",function(b){var c=$(b.currentTarget).attr("data-fm-functionality"),d=c.substring(5);"filename"===d?a._eventHandler.trigger("filemanager:view:sort"):a._eventHandler.trigger("filemanager:view:sort",{sortfunction:function(a,b){return a[d]>b[d]?-1:a[d]<b[d]?1:0}})}).on("keydown",b).on("keyup",c),$("input[data-fm-functionality=search]").on("search",{directory:a._currentDirectory},function(b){a._searchEvent(b)}).on("keydown",function(a){13==a.keyCode&&a.preventDefault()}).on("keyup",{directory:a._currentDirectory},function(b){13==b.keyCode&&a._searchEvent(b)}),a._addUploadFunctionality()},_addUploadFunctionality:function(){var a=this;null!==this._uploadFunctionalityReference&&this._uploadFunctionalityReference.destroy();var b=$("[data-fm-functionality=upload_progress]"),c=new ss.SimpleUpload({url:"/admin/fileapi/create",name:"filemanager_upload",method:"POST",hoverClass:"focus",focusClass:"active",multipart:!0,data:{filemanager_directory:a._currentDirectory},responseType:"json",dropzone:"filemanager_view",debug:a._debug,startXHR:function(){b.length>0&&(b.css("width","0%"),this.setProgressBar(b)),a._eventHandler.trigger("filemanager:api:uploading")},onComplete:function(b,c){a._eventHandler.trigger("filemanager:api:upload_done"),a._eventHandler.trigger("filemanager:view:ajax_upload",{response:c,directory:a._currentDirectory})},onAbort:function(){a._eventHandler.trigger("filemanager:api:upload_done")},onError:function(b,c,d,e,f){a._eventHandler.trigger("filemanager:api:upload_done"),f=JSON.parse(f),0!=f&&a._eventHandler.trigger("filemanager:api:error",{message:f.data.message,status:e,statuscode:d})}});if(c.setAbortBtn($("[data-fm-functionality=abort_upload]")),null===this._uploadFunctionalityReference){var d=$("[data-fm-functionality=upload_button]");0!==d.length&&d.on("click",function(){$("input[name=filemanager_upload]").trigger("click")}).on("keydown",function(a){13==a.keyCode&&(d.addClass("active"),a.preventDefault())}).on("keyup",function(a){13==a.keyCode&&(d.removeClass("active"),$("input[name=filemanager_upload]").trigger("click"))})}this._uploadFunctionalityReference=c},debug:function(a){"string"==typeof a&&(a="FileTreeView: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:error",function(b){a._apiCalled=!0,alert(b.message)}),this._eventHandler.register("filemanager:model:directories_changed",function(b){a._apiCalled=!0,a._searching=!1,a._searchQuery="",a.refreshDirectories(b)}),this._eventHandler.register("filemanager:view:search",function(b){a._apiCalled=!0,a._searching=!0,a._searchQuery=b.query}),this._eventHandler.register("filemanager:model:content_changed",function(b){a._apiCalled=!0,a.refreshContent(b)}),this._eventHandler.register("filemanager:model:path_changed",function(b){a._apiCalled=!0,a.refreshTitlebar(b)}),this._eventHandler.register("filemanager:model:select",function(b){var c={data:{file:b.file,selector:a._generateFileSelector(b.file)}};a._selectEvent(c)})}};var FilemanagerAPI=function(a){var b={debug:!1,api:{url:window.location.href,paths:{create:"/create",read:"",search:"/search",move:"/move",rename:"/rename","delete":"/delete",download:"/download"}}};this.options=$.extend(!0,b,a),this.init(this.options)};FilemanagerAPI.prototype={_debug:!1,_url:"",_path_create:"",_path_move:"",_path_rename:"",_path_read_directory:"",_path_delete:"",_path_search:"",_path_download:"",_eventHandler:!1,_disableRequests:!1,init:function(a){return null!==a&&"object"==typeof a&&(this._eventHandler=a.eventHandler,"undefined"!=typeof a.debug&&(this._debug=a.debug),null!==a.api&&"object"==typeof a.api&&("undefined"!=typeof a.api.url&&""!=a.api.url?this._url=a.api.url:(this._disableRequests=!0,console.error("NO APILINK FOUND !!!")),null!==a.api.paths&&"object"==typeof a.api.paths&&("undefined"!=typeof a.api.paths.move&&(this._path_move=a.api.paths.move),"undefined"!=typeof a.api.paths.rename&&(this._path_rename=a.api.paths.rename),"undefined"!=typeof a.api.paths.create&&(this._path_create=a.api.paths.create),"undefined"!=typeof a.api.paths["delete"]&&(this._path_delete=a.api.paths["delete"]),"undefined"!=typeof a.api.paths.read&&(this._path_read_directory=a.api.paths.read),"undefined"!=typeof a.api.paths.search&&(this._path_search=a.api.paths.search),"undefined"!=typeof a.api.paths.download&&(this._path_download=a.api.paths.download))),"string"==typeof a.api.startingDirectory&&this.read(a.api.startingDirectory)),this._registerEvents(),this.debug("Initializing"),this.debug(a),this},_sendRequest:function(a,b,c){"undefined"==typeof b&&(b="GET"),"object"!=typeof c&&(c={});var d=this;this._eventHandler.trigger("filemanager:api:loading");var e="",f=new RegExp("^(?:[a-z]+:)?//","i");if(f.test(a))e=a;else{var g="";g=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),e=g+a}return $.ajax({url:e,data:c,dataType:"json",method:b,self:d,beforeSend:function(a){d.debug("Sending "+this.method+" request to "+this.url+"...")}}).done(function(a){d._eventHandler.trigger("filemanager:api:done"),d.debug(a)}).fail(function(a,b,c){d._eventHandler.trigger("filemanager:api:done"),d.errorLog({statuscode:a.status,statustext:a.statusText,response:a.responseText})})},read:function(a){var b=this,c=this._url+this._path_read_directory;this._sendRequest(c,"GET",{directory:a}).done(function(c,d,e){b._eventHandler.trigger("filemanager:api:add_data",{contents:c.data.contents,directory:a})}).fail(function(a){b._handleApiError(a)})},search:function(a,b){var c=this,d=this._url+this._path_search;this._sendRequest(d,"GET",{directory:a,q:b}).done(function(d,e,f){c._eventHandler.trigger("filemanager:api:search_data",{contents:d.data.contents,directory:a,query:b})}).fail(function(a){c._handleApiError(a)})},move:function(a,b,c){var d=this,e=this._url+this._path_move,f=a+b;this._sendRequest(e,"POST",{filemanager_filepath:f,filemanager_newdirectory:c}).done(function(b,e,f){var g=[];if("object"==typeof b.data.changes)for(var h in b.data.changes)g.push(b.data.changes[h]);else g=b.data.changes;a!==c&&d._eventHandler.trigger("filemanager:api:refresh"),d._eventHandler.trigger("filemanager:api:update_data",{contents:g,directory:c})}).fail(function(a){d._handleApiError(a)})},rename:function(a,b,c){var d=this,e=this._url+this._path_rename;this._sendRequest(e,"POST",{filemanager_directory:a,filemanager_filename:b,filemanager_newfilename:c}).done(function(b,c,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;d._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){d._handleApiError(a)})},createDirectory:function(a,b){var c=this,d=this._url+this._path_create;this._sendRequest(d,"POST",{type:"directory",filemanager_directory:a,directory_name:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},"delete":function(a,b){var c=this,d=this._url+this._path_delete;this._sendRequest(d,"POST",{filemanager_directory:a,filemanager_filename:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},download:function(a){var b=this._url+this._path_download,c="?";b.indexOf(c)>-1&&(c="&"),window.location=b+c+"filemanager_path="+encodeURI(a)},uploadResponse:function(a,b){this._eventHandler.trigger("filemanager:api:done"),this._eventHandler.trigger("filemanager:api:update_data",{contents:b.data.changes,directory:a,selected:!0})},_handleApiError:function(a){var b=this,c=JSON.parse(a.responseText);b._eventHandler.trigger("filemanager:api:error",{message:c.data.message,status:c.status,statuscode:a.status})},debug:function(a){"string"==typeof a&&(a="FilemanagerAPI: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:view:open",function(b){0==b.isSynchronized&&a.read(b.directory)}),this._eventHandler.register("filemanager:view:search",function(b){a.search(b.directory,b.query)}),this._eventHandler.register("filemanager:view:create",function(b){a.createDirectory(b.directory,b.name)}),this._eventHandler.register("filemanager:view:rename",function(b){a.rename(b.file.directory,b.file.name,b.newname)}),this._eventHandler.register("filemanager:view:move",function(b){a.move(b.file.directory,b.file.name,b.newlocation)}),this._eventHandler.register("filemanager:view:delete",function(b){a["delete"](b.file.directory,b.file.name)}),this._eventHandler.register("filemanager:view:ajax_upload",function(b){a.uploadResponse(b.directory,b.response)}),this._eventHandler.register("filemanager:view:download",function(b){a.download(b.file.path)})}};var FilemanagerEventHandler=function(a){var b={debug:!1};a=$.extend(!0,b,a),this.init(a)};FilemanagerEventHandler.prototype={_events:{},_debug:!1,init:function(a){null!==a&&"object"==typeof a&&"undefined"!=typeof a.debug&&(this._debug=a.debug)},hasEvent:function(a,b){if(this._events.hasOwnProperty(a))return!0;if(b)throw'No event registered for "'+a+'"';return!1},register:function(a,b){this.debug("Registering "+a),this._create(a),this._events[a].push(b)},unRegister:function(a){this.hasEvent(a,!0)&&delete this._events[a]},_create:function(a){this.hasEvent(a,!1)||(this._events[a]=[])},trigger:function(a){if(this.debug("Triggering "+a),this.hasEvent(a,!1)){var b=Array.prototype.slice.call(arguments,1);$.each(this._events[a],function(a,c){c.apply(c,b)}.bind(this))}},debug:function(a){this._debug&&console.log(a)}},function(){$.fn.filemanager=function(a){if("undefined"==typeof a&&(a={}),a.eventHandler=new FilemanagerEventHandler(a),null!==a.api&&"object"==typeof a.api)if("undefined"!=typeof a.api.url&&""!=a.api.url){this.data("event",a.eventHandler),this.data("view",new FileTreeView(a)),this.data("api",new FilemanagerAPI(a)),this.data("tree",new FileTree(a));var b=this,c={refresh:function(){return b.data("tree").refresh(),b},moveUpDirectory:function(){b.data("tree").moveUpDirectory()},createDirectory:function(){var a=b.data("tree").getCurrentPath();return b.data("view")._createDirectory(a),b},search:function(a){return b.data("tree").search(a),b},on:function(a,c){return b.data("event").register(a,c),b}};this.data("filemanager",c)}else console.error("Filemanager: NO APILINK FOUND - Aborting creation");else console.error("Filemanager: NO APILINK FOUND - Aborting creation");return this}}(jQuery);var FileTree=function(a){var b={debug:!1};this.options=$.extend(!0,b,a),this.init(this.options)};FileTree.prototype={_debug:!1,_root:{children:{}},_currentPath:"",_currentFiles:[],_currentContentSort:null,_reverse:!1,_walk_itteration:0,_eventHandler:null,init:function(a){return null!==a&&"object"==typeof a&&(this._debug=a.debug,this._eventHandler=a.eventHandler,this._registerEvents()),this._currentContentSort=this._naturalFilemanagerSort,this.debug("Initializing"),this.debug(a),this},addFiles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];this._setFile(e)}this.debug("Tree structure after updating"),this.debug(this._root),1==b&&this._updateViews(!0,!1,!1)},setContents:function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.path=this._formatPath(e.path,!0),e.directory=this._formatPath(e.directory),b.push(e)}this._currentFiles=b},_setFile:function(a){0==a.hasOwnProperty("path")&&(a.path=this._formatPath(a.directory)+a.name),a.path=this._formatPath(a.path,!0),a.directory=this._formatPath(a.directory),0==a.hasOwnProperty("children")&&(a.children={});var b=this._findNode(a.directory);"undefined"==typeof b.children[a.name]?b.children[a.name]=a:b.children[a.name]=$.extend(!0,b.children[a.name],a)},_findNode:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];"undefined"==typeof c.children[f]&&(c.children[f]=this._generateNode(f,b)),c=c.children[f]}return"undefined"==typeof c.children&&(c.children={}),c},_generateNode:function(a,b){var c={};c.name=a;for(var d="",e=0;e<b.length&&(d+=b[e]+"/",b[e+1]!=a);e++);return c.directory=d,c.path=d+a,c.children={},c},_extractPathNodes:function(a){"string"!=typeof a&&(a="");for(var b=a.split("/"),c=[],d=0,e=b.length;e>d;d++)""!==b[d]&&c.push(b[d]);return c},addChanges:function(a,b){if("undefined"!=typeof a||!a)for(var c=0,d=a.length;d>c;c++)this._executeChange(a[c]);this.debug("Tree structure after updating"),this.debug(this._root),this.debug("Updating the current files"),this.openPath(this._currentPath,!1),this.debug(this._currentFiles),b&&this._updateViews(!0,!0,!0)},_executeChange:function(a){switch(a.type){case"delete":this._deleteNode(a.file);break;case"create":this._setFile(a.file);break;case"update":case"rename":case"move":this._updateNode(a.file,a.updatedfile)}},_updateNode:function(a,b){var c=this._findNodeIfExists(a.directory);if(c!==!1||"undefined"!=typeof c.children[a.name]){var d=c.children[a.name],e=this._formatPath(d.path);b.path=b.directory+b.name;var f=$.extend(!0,d,b),g=this._formatPath(b.path);e!=g&&(f=this._updateChildPaths(f),this._deleteNode(a)),this._setFile(f)}},_updateChildPaths:function(a){if("undefined"!=typeof a.children){var b=[];for(var c in a.children)b.push(c);for(var d=0,e=b.length;e>d;d++)if("undefined"!=typeof a.children[b[d]]){var f=a.children[b[d]];f.directory=this._formatPath(a.path),f.path=this._formatPath(a.path)+f.name,a.children[b[d]]=this._updateChildPaths(f)}}return a},_formatPath:function(a,b){return"undefined"==typeof a&&(a=""),0!==a.length&&"/"==a.substr(0,1)&&(a=a.substr(1,a.length-1)),b!==!0&&0!==a.length&&"/"!=a.substr(a,a.length-1)&&(a+="/"),a=a.replace(/\/\/+/g,"/")},_deleteNode:function(a){var b=this._findNodeIfExists(a.directory);b!==!1&&delete b.children[a.name]},_findNodeIfExists:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];if("undefined"==typeof c.children[f]){c=!1;break}c=c.children[f]}return c},flattenTree:function(a){var b=this.toJstreeData(this._root.children,a);return this._walk_itteration=0,this.debug("JsTree data updated"),this.debug(b),b},toJstreeData:function(a,b){"undefined"==typeof a&&(a=this._root.children);var c=[];for(var d in a){var e=a[d];if(!b||b===!0&&("undefined"==typeof e.type||"dir"===e.type)){this._walk_itteration++;var f={text:e.name};if(f.li_attr={id:"js_tree_file_"+this._walk_itteration,"data-path":e.path,"data-synchronized":"undefined"==typeof e._generated},f.state={opened:this._isOpenedDirectory(e),selected:!1,disabled:"undefined"!=typeof e.disabled&&1==e.disabled},"object"==typeof e.children&&null!==e.children){var g=[];for(var h in e.children)g.push(h);g.length>0&&(f.children=this.toJstreeData(e.children,b))}c.push(f)}}return c},openPath:function(a,b){this._currentPath=a;var c=this._findNodeIfExists(a);if(c===!1)this._currentPath=a,this._currentFiles=[];else if(""!==a&&c==this._root)this._currentFiles=[];else{var d=[];for(var e in c.children)d.push(c.children[e]);this.setContents(d)}b&&this._updateViews(!0,!0,!0)},_isOpenedDirectory:function(a){for(var b=this._extractPathNodes(this._currentPath),c=this._extractPathNodes(this._formatPath(a.path)),d=!1,e=0,f=c.length;f>e;e++)d=b[e]===c[e];return d},_naturalFilemanagerSort:function(a,b){var c=a.type,d=b.type;return"dir"==c&&"dir"!=d?-1:"dir"!=c&&"dir"==d?1:String(a.name).toLowerCase()<String(b.name).toLowerCase()?-1:String(a.name).toLowerCase()>String(b.name).toLowerCase()?1:0},sortContent:function(a){"function"!=typeof a&&(a=this._naturalFilemanagerSort),String(this._currentContentSort)==String(a)?this._reverse=!this._reverse:this._reverse=!1,this._currentContentSort=a,this._updateViews(!1,!0,!1)},resetSort:function(){this.sortContent(this._naturalFilemanagerSort)},_updateViews:function(a,b,c){1==a&&this._eventHandler.trigger("filemanager:model:directories_changed",this.flattenTree(!0)),1==b&&(this._currentFiles.sort(this._currentContentSort),this._reverse&&this._currentFiles.reverse(),this._eventHandler.trigger("filemanager:model:content_changed",this._currentFiles)),1==c&&this._eventHandler.trigger("filemanager:model:path_changed",this._currentPath)},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},debug:function(a){"string"==typeof a&&(a="FileTree: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:add_data",function(b){a.addFiles(b.contents),a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:api:update_data",function(b){a.addChanges(b.contents,!0),1==b.selected&&a._eventHandler.trigger("filemanager:model:select",{file:b.contents[0].file})}),this._eventHandler.register("filemanager:api:search_data",function(b){a.setContents(b.contents),a._updateViews(!1,!0,!1)}),this._eventHandler.register("filemanager:view:directory_up",function(b){a.moveUpDirectory()}),this._eventHandler.register("filemanager:view:sort",function(b){void 0!==b&&"function"==typeof b.sortfunction?a.sortContent(b.sortfunction):a.sortContent()}),this._eventHandler.register("filemanager:view:open",function(b){b.isSynchronized&&a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:view:refresh",function(b){a.refresh()}),this._eventHandler.register("filemanager:api:refresh",function(b){a.refresh()})},refresh:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._currentPath,isSynchronized:!1})},moveUpDirectory:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._getHigherDirectory(a._currentPath),isSynchronized:!1})},search:function(a){var b=this;this._eventHandler.trigger("filemanager:view:search",{directory:b._currentPath,query:a})},getCurrentPath:function(){return this._currentPath}};var FileTreeView=function(a,b){var c={debug:!1,i18n:{rename:"Rename",cut:"Cut",paste:"Paste",download:"Download","delete":"Delete"}};this.options=$.extend(!0,c,a),this.init(this.options,b)};FileTreeView.prototype={_debug:!1,_eventHandler:!1,_container:!1,_directoryElement:!1,_contentElement:!1,_uploadLink:!1,_uploadFunctionalityReference:null,_viewFormat:"list",_keepFocusOnDirectories:!1,_keepFocusOnContent:!1,_currentDirectory:"",_currentContent:[],_searching:!1,_searchQuery:"",_apiCalled:!1,_isMultiple:!1,_selectedFiles:[],_editContext:{mode:"none",selector:!1,file:!1},_i18n:{},init:function(a,b){this._debug=a.debug,this._container=$(b),this._directoryElement=$("[data-fm-value=directories]"),this._eventHandler=a.eventHandler,"function"==typeof a.filerowFormat&&(this._formatFilerow=a.filerowFormat),"function"==typeof a.fileCellFormat&&(this._formatFilecell=a.fileCellFormat),"function"==typeof a.renamerowFormat&&(this._formatRenamerow=a.renamerowFormat),"function"==typeof a.renamecellFormat&&(this._formatRenamecell=a.renamecellFormat),"function"==typeof a.uploadFormat&&(this._formatUpload=a.uploadFormat),"object"==typeof a.i18n&&(this._i18n=a.i18n),this._setOverviewLayout("list"),this._addFunctionality(),this._registerEvents()},_formatFilerow:function(a){return'<p class="filemanagerrow"><span>'+a.path+"</span></p>"},_formatFilecell:function(a){return'<p class="filemanagercell"><span>'+a.path+"</span></p>"},_formatRenamerow:function(a){return'<p class="filemanagerrow"><span>'+a.name+"</span></p>"},_formatRenamecell:function(a){return'<p class="filemanagercell"><span>'+a.name+"</span></p>"},refreshTitlebar:function(a){this.debug("Refreshing directory string to "+a),this._currentDirectory=a,$("[data-fm-value=current_directory]").text("/"+a),this._addUploadFunctionality()},refreshDirectories:function(a){var b=this;this._directoryElement.length>0&&"function"==typeof this._directoryElement.jstree&&this._directoryElement.jstree("destroy").jstree({core:{data:a,multiple:!1},plugins:[]
}).on("dblclick.jstree",function(a){b._jstreeOpenEvent(a)}).on("keyup.jstree",function(a){13==a.keyCode&&b._jstreeOpenEvent(a)})},_createDirectory:function(a){var b,c='<input type="text" name="directory_name"/>',d={name:c,type:"dir",date_modified:"",size:"",children:{}};"list"==this._viewFormat?b=$(this._formatRenamerow(d)):"grid"==this._viewFormat&&(b=$(this._formatRenamecell(d)));var e=this,f=b.find("input[name=directory_name]");f.on("keydown",{directory:a},function(a){13==a.keyCode&&(""!=a.target.value&&e._eventHandler.trigger("filemanager:view:create",{directory:a.data.directory,name:a.target.value}),e._contentElement.children().eq(0).remove())}).on("blur",function(a){e._contentElement.children().eq(0).remove()}),this._contentElement.prepend(b),f.focus()},refreshContent:function(a){var b=this;if(void 0!==a&&(this._currentContent=a),this._contentElement.length>0){this._contentElement.empty(),$.contextMenu("destroy");for(var c=0,d=b._currentContent.length;d>c;c++){var e=$.extend({},b._currentContent[c]),f=$.extend({},b._currentContent[c]);1==b._searching&&(f.name=f.name.replace(this._searchQuery,'<span class="searchquery">'+this._searchQuery+"</span>")),f.size=this._filesizeFormat(f.size);var g="";g="list"==b._viewFormat?this._formatFilerow(f):this._formatFilecell(f);for(var h=this._generateFileSelector(e),i=$(g).attr("data-fm-functionality","file-"+e.directory+e.name).appendTo(this._contentElement).on("click",{file:e,selector:h},function(a){$(window).width()<=768?b._openContentEvent(a):b._toggleSelection(a)}).on("keyup",{file:e,selector:h},function(a){13==a.keyCode&&(b._keepFocusOnContent=!0,b._openContentEvent(a))}).on("keydown",{file:e,selector:h},function(a){a.ctrlKey&&88==a.keyCode?b._setCutMode(a.data.selector,a.data.file):a.ctrlKey&&86==a.keyCode&&"none"!==b._editContext.mode&&b._pasteMode(a.data.selector,a.data.file)}).on("dblclick",{file:e,selector:h},function(a){b._openContentEvent(a)}),j=0,k=this._selectedFiles.length;k>j;j++)this._selectedFiles[j].selector==h&&i.addClass("selected");b._addContextmenuToElement(h,e),0==c&&1==b._keepFocusOnContent&&(i.focus(),b._keepFocusOnContent=!1)}}this._setEditStyling(),this._updateVisibility(),b._addContextmenuToElement("[data-fm-functionality=directory_up]",{type:"dir",name:"",directory:b._currentDirectory},!0),b._eventHandler.trigger("filemanager:view:rendered")},_addContextmenuToElement:function(a,b,c){var d=this;$.contextMenu({selector:a,build:function(){var a={rename:{name:d._i18n.rename,icon:"rename"},cut:{name:d._i18n.cut,icon:"cut"},paste:{name:d._i18n.paste,icon:"paste"}};return"dir"!==b.type&&(a.download={name:d._i18n.download,icon:"download"}),a.seperator="---------",a["delete"]={name:d._i18n["delete"],icon:"delete"},c===!0?(a={},"none"!==d._editContext.mode&&(a.paste={name:d._i18n.paste,icon:"paste"})):"none"!==d._editContext.mode?a.paste.disabled=!1:a.paste.disabled=!0,{file:b,callback:function(a,b){switch(a){case"rename":d.createRenamerow(b.selector,b.file);break;case"cut":d._setCutMode(b.selector,b.file);break;case"paste":d._pasteMode(b.selector,b.file);break;case"delete":d._eventHandler.trigger("filemanager:view:delete",{file:b.file});break;case"download":d._eventHandler.trigger("filemanager:view:download",{file:b.file})}},items:a}}})},_generateFileSelector:function(a){var b="file-"+a.directory+a.name;return'[data-fm-functionality="'+b+'"]'},createRenamerow:function(a,b){var c=this._contentElement.find(a),d=this,e=$.extend({},b);e.name='<input type="text" name="file_name" value="'+b.name+'"/>';var f;"list"==this._viewFormat?f=$(d._formatRenamerow(e)):"grid"==this._viewFormat&&(f=$(d._formatRenamecell(e)));var g=f.find("input");g.on("keydown",{file:b},function(a){13==a.keyCode&&(""!=a.target.value&&d._renameEvent(a),d._contentElement.find(f).remove(),d._contentElement.find(c).show())}).on("blur",function(a){d._contentElement.find(f).remove(),d._contentElement.find(c).show()}),d._contentElement.find(c).hide().after(f);var h=g.val();g.val("").focus().val(h)},_openContentEvent:function(a){var b=(a.data.file.directory,a.data.file.path);if(0==b&&(b=a.data.file.directory+a.data.file.name),"undefined"==typeof a.data.file.type||"dir"==a.data.file.type){var c=!1;this._eventHandler.trigger("filemanager:view:open",{directory:b,isSynchronized:c})}else this._toggleSelection(a)},_toggleSelection:function(a){this._isFileSelected(a.data.file)?this._deselectEvent(a):this._selectEvent(a)},_selectEvent:function(a){0==this._isMultiple&&this._clearSelection(),this._selectedFiles.push({selector:a.data.selector,file:a.data.file}),$(a.data.selector).addClass("selected"),this._eventHandler.trigger("filemanager:view:select",{path:a.data.file.path,file:a.data.file})},_isFileSelected:function(a){for(var b=0,c=this._selectedFiles.length;c>b;b++)if(a==this._selectedFiles[b].file)return!0;return!1},_deselectEvent:function(a){for(var b=[],c=0,d=this._selectedFiles.length;d>c;c++)a.data.file==this._selectedFiles[c].file?$(a.data.selector).removeClass("selected"):b=this._selectedFiles[c];this._selectedFiles=b,this._eventHandler.trigger("filemanager:view:deselect",{path:a.data.file.path,file:a.data.file})},_clearSelection:function(){for(var a=0,b=this._selectedFiles.length;b>a;a++)$(this._selectedFiles[a].selector).removeClass("selected");this._selectedFiles=[]},_jstreeOpenEvent:function(a){var b=$(a.target).closest("li");if(b.length>0){var c=b.attr("data-path"),d="false"!=b.attr("data-synchronized");"undefined"!=typeof c&&this._eventHandler.trigger("filemanager:view:open",{directory:c,isSynchronized:!d})}},_searchEvent:function(a){var b=a.target.value;""!=b?(this._eventHandler.trigger("filemanager:view:search",{directory:this._currentDirectory,query:b}),$("[data-fm-value=search_query]").text(b)):this._eventHandler.trigger("filemanager:view:open",{directory:this._currentDirectory,isSynchronized:!1})},_renameEvent:function(a){var b=a.target.value;""!=b&&this._eventHandler.trigger("filemanager:view:rename",{file:a.data.file,newname:b})},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},_filesizeFormat:function(a){var b=1024,c=1024*b,d=1024*c,e="";return 0==isNaN(a)&&(a=parseInt(a),e=b>a?a+" B":c>a?(a/b).toFixed(1)+" KB":d>a?(a/c).toFixed(1)+" MB":(a/d).toFixed(1)+" GB"),e},_setOverviewLayout:function(a){"list"==a||"grid"==a?(this._viewFormat=a,"list"==this._viewFormat?($("[data-fm-functionality=set_list]").addClass("selected"),$("[data-fm-functionality=set_grid]").removeClass("selected"),this._contentElement=$("[data-fm-value=list_content]")):"grid"==this._viewFormat&&($("[data-fm-functionality=set_grid]").addClass("selected"),$("[data-fm-functionality=set_list]").removeClass("selected"),this._contentElement=$("[data-fm-value=grid_content]")),this._updateVisibility()):this.errorLog("Overview layout can only be a list or a grid")},_resetEditStyles:function(){this._editMode="none",this._editContext.selector!==!1&&($(this._editContext.selector).removeClass("mode-cut").removeClass("mode-copy"),this._editContext.selector=!1),this._editContext.file=!1},_setEditStyling:function(){var a=this._editContext;if(a.file!==!1&&a.selector!==!1)switch(a.mode){case"cut":$(a.selector).addClass("mode-cut");break;case"copy":$(a.selector).addClass("mode-copy");break;case"none":this._resetEditStyles()}},_setCutMode:function(a,b){this._resetEditStyles(),this._editContext={mode:"cut",selector:a,file:b},this._setEditStyling()},_setCopyMode:function(a,b){this._resetEditStyles(),this._editContext=this._editContext={mode:"copy",selector:a,file:b},this._setEditStyling()},_pasteMode:function(a,b){if("none"!==this._editContext.mode&&this._editContext.file!==!1){var c=b.directory;"dir"==b.type&&(c+=b.name),this._eventHandler.trigger("filemanager:view:move",{file:this._editContext.file,newlocation:c})}this._resetEditStyles()},_updateVisibility:function(){var a=function(a){return"[data-fm-show="+a+"]"};"list"==this._viewFormat?($(a("list_view")).show(),$(a("grid_view")).hide()):"grid"==this._viewFormat&&($(a("list_view")).hide(),$(a("grid_view")).show()),$(a("no_content")).hide(),$(a("no_search_results")).hide(),0==this._currentContent.length?0==this._searching?this._apiCalled&&$(a("no_content")).show():$(a("no_search_results")).show():1==this._searching&&$(a("search_results")).show(),""!==this._currentDirectory?$(a("no_root")).show():$(a("no_root")).hide()},_addFunctionality:function(){var a=this,b=function(a){13==a.keyCode&&(a.preventDefault(),$(a.target).addClass("active").trigger("mousedown"))},c=function(a){13==a.keyCode&&$(a.currentTarget).removeClass("active").trigger("click")};$("[data-fm-functionality=directory_up]").on("click",function(b){a._eventHandler.trigger("filemanager:view:directory_up",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=refresh]").on("click",function(){a._eventHandler.trigger("filemanager:view:refresh",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=create_directory]").on("click",function(b){a._createDirectory(a._currentDirectory)}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_list]").on("click",function(b){a._setOverviewLayout("list"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_grid]").on("click",function(b){a._setOverviewLayout("grid"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality^='sort_']").on("click",function(b){var c=$(b.currentTarget).attr("data-fm-functionality"),d=c.substring(5);"filename"===d?a._eventHandler.trigger("filemanager:view:sort"):a._eventHandler.trigger("filemanager:view:sort",{sortfunction:function(a,b){return a[d]>b[d]?-1:a[d]<b[d]?1:0}})}).on("keydown",b).on("keyup",c),$("input[data-fm-functionality=search]").on("search",{directory:a._currentDirectory},function(b){a._searchEvent(b)}).on("keydown",function(a){13==a.keyCode&&a.preventDefault()}).on("keyup",{directory:a._currentDirectory},function(b){13==b.keyCode&&a._searchEvent(b)}),a._addUploadFunctionality()},_addUploadFunctionality:function(){var a=this;null!==this._uploadFunctionalityReference&&this._uploadFunctionalityReference.destroy();var b=$("[data-fm-functionality=upload_progress]"),c=new ss.SimpleUpload({url:"/admin/fileapi/create",name:"filemanager_upload",method:"POST",hoverClass:"focus",focusClass:"active",multipart:!0,data:{filemanager_directory:a._currentDirectory},responseType:"json",dropzone:"filemanager_view",debug:a._debug,startXHR:function(){b.length>0&&(b.css("width","0%"),this.setProgressBar(b)),a._eventHandler.trigger("filemanager:api:uploading")},onComplete:function(b,c){a._eventHandler.trigger("filemanager:api:upload_done"),a._eventHandler.trigger("filemanager:view:ajax_upload",{response:c,directory:a._currentDirectory})},onAbort:function(){a._eventHandler.trigger("filemanager:api:upload_done")},onError:function(b,c,d,e,f){a._eventHandler.trigger("filemanager:api:upload_done"),f=JSON.parse(f),0!=f&&a._eventHandler.trigger("filemanager:api:error",{message:f.data.message,status:e,statuscode:d})}});if(c.setAbortBtn($("[data-fm-functionality=abort_upload]")),null===this._uploadFunctionalityReference){var d=$("[data-fm-functionality=upload_button]");0!==d.length&&d.on("click",function(){$("input[name=filemanager_upload]").trigger("click")}).on("keydown",function(a){13==a.keyCode&&(d.addClass("active"),a.preventDefault())}).on("keyup",function(a){13==a.keyCode&&(d.removeClass("active"),$("input[name=filemanager_upload]").trigger("click"))})}this._uploadFunctionalityReference=c},debug:function(a){"string"==typeof a&&(a="FileTreeView: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:error",function(b){a._apiCalled=!0,alert(b.message)}),this._eventHandler.register("filemanager:model:directories_changed",function(b){a._apiCalled=!0,a._searching=!1,a._searchQuery="",a.refreshDirectories(b)}),this._eventHandler.register("filemanager:view:search",function(b){a._apiCalled=!0,a._searching=!0,a._searchQuery=b.query}),this._eventHandler.register("filemanager:model:content_changed",function(b){a._apiCalled=!0,a.refreshContent(b)}),this._eventHandler.register("filemanager:model:path_changed",function(b){a._apiCalled=!0,a.refreshTitlebar(b)}),this._eventHandler.register("filemanager:model:select",function(b){var c={data:{file:b.file,selector:a._generateFileSelector(b.file)}};a._selectEvent(c)})}};var FilemanagerAPI=function(a){var b={debug:!1,api:{url:window.location.href,paths:{create:"/create",read:"",search:"/search",move:"/move",rename:"/rename","delete":"/delete",download:"/download"}}};this.options=$.extend(!0,b,a),this.init(this.options)};FilemanagerAPI.prototype={_debug:!1,_url:"",_path_create:"",_path_move:"",_path_rename:"",_path_read_directory:"",_path_delete:"",_path_search:"",_path_download:"",_eventHandler:!1,_disableRequests:!1,init:function(a){return null!==a&&"object"==typeof a&&(this._eventHandler=a.eventHandler,"undefined"!=typeof a.debug&&(this._debug=a.debug),null!==a.api&&"object"==typeof a.api&&("undefined"!=typeof a.api.url&&""!=a.api.url?this._url=a.api.url:(this._disableRequests=!0,console.error("NO APILINK FOUND !!!")),null!==a.api.paths&&"object"==typeof a.api.paths&&("undefined"!=typeof a.api.paths.move&&(this._path_move=a.api.paths.move),"undefined"!=typeof a.api.paths.rename&&(this._path_rename=a.api.paths.rename),"undefined"!=typeof a.api.paths.create&&(this._path_create=a.api.paths.create),"undefined"!=typeof a.api.paths["delete"]&&(this._path_delete=a.api.paths["delete"]),"undefined"!=typeof a.api.paths.read&&(this._path_read_directory=a.api.paths.read),"undefined"!=typeof a.api.paths.search&&(this._path_search=a.api.paths.search),"undefined"!=typeof a.api.paths.download&&(this._path_download=a.api.paths.download))),"string"==typeof a.api.startingDirectory&&this.read(a.api.startingDirectory)),this._registerEvents(),this.debug("Initializing"),this.debug(a),this},_sendRequest:function(a,b,c){"undefined"==typeof b&&(b="GET"),"object"!=typeof c&&(c={});var d=this;this._eventHandler.trigger("filemanager:api:loading");var e="",f=new RegExp("^(?:[a-z]+:)?//","i");if(f.test(a))e=a;else{var g="";g=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),e=g+a}return $.ajax({url:e,data:c,dataType:"json",method:b,self:d,beforeSend:function(a){d.debug("Sending "+this.method+" request to "+this.url+"...")}}).done(function(a){d._eventHandler.trigger("filemanager:api:done"),d.debug(a)}).fail(function(a,b,c){d._eventHandler.trigger("filemanager:api:done"),d.errorLog({statuscode:a.status,statustext:a.statusText,response:a.responseText})})},read:function(a){var b=this,c=this._url+this._path_read_directory;this._sendRequest(c,"GET",{directory:a}).done(function(c,d,e){b._eventHandler.trigger("filemanager:api:add_data",{contents:c.data.contents,directory:a})}).fail(function(a){b._handleApiError(a)})},search:function(a,b){var c=this,d=this._url+this._path_search;this._sendRequest(d,"GET",{directory:a,q:b}).done(function(d,e,f){c._eventHandler.trigger("filemanager:api:search_data",{contents:d.data.contents,directory:a,query:b})}).fail(function(a){c._handleApiError(a)})},move:function(a,b,c){var d=this,e=this._url+this._path_move,f=a+b;this._sendRequest(e,"POST",{filemanager_filepath:f,filemanager_newdirectory:c}).done(function(b,e,f){var g=[];if("object"==typeof b.data.changes)for(var h in b.data.changes)g.push(b.data.changes[h]);else g=b.data.changes;a!==c&&d._eventHandler.trigger("filemanager:api:refresh"),d._eventHandler.trigger("filemanager:api:update_data",{contents:g,directory:c})}).fail(function(a){d._handleApiError(a)})},rename:function(a,b,c){var d=this,e=this._url+this._path_rename;this._sendRequest(e,"POST",{filemanager_directory:a,filemanager_filename:b,filemanager_newfilename:c}).done(function(b,c,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;d._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){d._handleApiError(a)})},createDirectory:function(a,b){var c=this,d=this._url+this._path_create;this._sendRequest(d,"POST",{type:"directory",filemanager_directory:a,directory_name:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},"delete":function(a,b){var c=this,d=this._url+this._path_delete;this._sendRequest(d,"POST",{filemanager_directory:a,filemanager_filename:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},download:function(a){var b=this._url+this._path_download,c="?";b.indexOf(c)>-1&&(c="&"),window.location=b+c+"filemanager_path="+encodeURI(a)},uploadResponse:function(a,b){this._eventHandler.trigger("filemanager:api:done"),this._eventHandler.trigger("filemanager:api:update_data",{contents:b.data.changes,directory:a,selected:!0})},_handleApiError:function(a){var b=this,c=JSON.parse(a.responseText);b._eventHandler.trigger("filemanager:api:error",{message:c.data.message,status:c.status,statuscode:a.status})},debug:function(a){"string"==typeof a&&(a="FilemanagerAPI: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:view:open",function(b){0==b.isSynchronized&&a.read(b.directory)}),this._eventHandler.register("filemanager:view:search",function(b){a.search(b.directory,b.query)}),this._eventHandler.register("filemanager:view:create",function(b){a.createDirectory(b.directory,b.name)}),this._eventHandler.register("filemanager:view:rename",function(b){a.rename(b.file.directory,b.file.name,b.newname)}),this._eventHandler.register("filemanager:view:move",function(b){a.move(b.file.directory,b.file.name,b.newlocation)}),this._eventHandler.register("filemanager:view:delete",function(b){a["delete"](b.file.directory,b.file.name)}),this._eventHandler.register("filemanager:view:ajax_upload",function(b){a.uploadResponse(b.directory,b.response)}),this._eventHandler.register("filemanager:view:download",function(b){a.download(b.file.path)})}};var FilemanagerEventHandler=function(a){var b={debug:!1};a=$.extend(!0,b,a),this.init(a)};FilemanagerEventHandler.prototype={_events:{},_debug:!1,init:function(a){null!==a&&"object"==typeof a&&"undefined"!=typeof a.debug&&(this._debug=a.debug)},hasEvent:function(a,b){if(this._events.hasOwnProperty(a))return!0;if(b)throw'No event registered for "'+a+'"';return!1},register:function(a,b){this.debug("Registering "+a),this._create(a),this._events[a].push(b)},unRegister:function(a){this.hasEvent(a,!0)&&delete this._events[a]},_create:function(a){this.hasEvent(a,!1)||(this._events[a]=[])},trigger:function(a){if(this.debug("Triggering "+a),this.hasEvent(a,!1)){var b=Array.prototype.slice.call(arguments,1);$.each(this._events[a],function(a,c){c.apply(c,b)}.bind(this))}},debug:function(a){this._debug&&console.log(a)}},function(){$.fn.filemanager=function(a){if("undefined"==typeof a&&(a={}),a.eventHandler=new FilemanagerEventHandler(a),null!==a.api&&"object"==typeof a.api)if("undefined"!=typeof a.api.url&&""!=a.api.url){this.data("event",a.eventHandler),this.data("view",new FileTreeView(a)),this.data("api",new FilemanagerAPI(a)),this.data("tree",new FileTree(a));var b=this,c={refresh:function(){return b.data("tree").refresh(),b},moveUpDirectory:function(){b.data("tree").moveUpDirectory()},createDirectory:function(){var a=b.data("tree").getCurrentPath();return b.data("view")._createDirectory(a),b},search:function(a){return b.data("tree").search(a),b},on:function(a,c){return b.data("event").register(a,c),b}};this.data("filemanager",c)}else console.error("Filemanager: NO APILINK FOUND - Aborting creation");else console.error("Filemanager: NO APILINK FOUND - Aborting creation");return this}}(jQuery);var FileTree=function(a){var b={debug:!1};this.options=$.extend(!0,b,a),this.init(this.options)};FileTree.prototype={_debug:!1,_root:{children:{}},_currentPath:"",_currentFiles:[],_currentContentSort:null,_reverse:!1,_walk_itteration:0,_eventHandler:null,init:function(a){return null!==a&&"object"==typeof a&&(this._debug=a.debug,this._eventHandler=a.eventHandler,this._registerEvents()),this._currentContentSort=this._naturalFilemanagerSort,this.debug("Initializing"),this.debug(a),this},addFiles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];this._setFile(e)}this.debug("Tree structure after updating"),this.debug(this._root),1==b&&this._updateViews(!0,!1,!1)},setContents:function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.path=this._formatPath(e.path,!0),e.directory=this._formatPath(e.directory),b.push(e)}this._currentFiles=b},_setFile:function(a){0==a.hasOwnProperty("path")&&(a.path=this._formatPath(a.directory)+a.name),a.path=this._formatPath(a.path,!0),a.directory=this._formatPath(a.directory),0==a.hasOwnProperty("children")&&(a.children={});var b=this._findNode(a.directory);"undefined"==typeof b.children[a.name]?b.children[a.name]=a:b.children[a.name]=$.extend(!0,b.children[a.name],a)},_findNode:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];"undefined"==typeof c.children[f]&&(c.children[f]=this._generateNode(f,b)),c=c.children[f]}return"undefined"==typeof c.children&&(c.children={}),c},_generateNode:function(a,b){var c={};c.name=a;for(var d="",e=0;e<b.length&&(d+=b[e]+"/",b[e+1]!=a);e++);return c.directory=d,c.path=d+a,c.children={},c},_extractPathNodes:function(a){"string"!=typeof a&&(a="");for(var b=a.split("/"),c=[],d=0,e=b.length;e>d;d++)""!==b[d]&&c.push(b[d]);return c},addChanges:function(a,b){if("undefined"!=typeof a||!a)for(var c=0,d=a.length;d>c;c++)this._executeChange(a[c]);this.debug("Tree structure after updating"),this.debug(this._root),this.debug("Updating the current files"),this.openPath(this._currentPath,!1),this.debug(this._currentFiles),b&&this._updateViews(!0,!0,!0)},_executeChange:function(a){switch(a.type){case"delete":this._deleteNode(a.file);break;case"create":this._setFile(a.file);break;case"update":case"rename":case"move":this._updateNode(a.file,a.updatedfile)}},_updateNode:function(a,b){var c=this._findNodeIfExists(a.directory);if(c!==!1||"undefined"!=typeof c.children[a.name]){var d=c.children[a.name],e=this._formatPath(d.path);b.path=b.directory+b.name;var f=$.extend(!0,d,b),g=this._formatPath(b.path);e!=g&&(f=this._updateChildPaths(f),this._deleteNode(a)),this._setFile(f)}},_updateChildPaths:function(a){if("undefined"!=typeof a.children){var b=[];for(var c in a.children)b.push(c);for(var d=0,e=b.length;e>d;d++)if("undefined"!=typeof a.children[b[d]]){var f=a.children[b[d]];f.directory=this._formatPath(a.path),f.path=this._formatPath(a.path)+f.name,a.children[b[d]]=this._updateChildPaths(f)}}return a},_formatPath:function(a,b){return"undefined"==typeof a&&(a=""),0!==a.length&&"/"==a.substr(0,1)&&(a=a.substr(1,a.length-1)),b!==!0&&0!==a.length&&"/"!=a.substr(a,a.length-1)&&(a+="/"),a=a.replace(/\/\/+/g,"/")},_deleteNode:function(a){var b=this._findNodeIfExists(a.directory);b!==!1&&delete b.children[a.name]},_findNodeIfExists:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];if("undefined"==typeof c.children[f]){c=!1;break}c=c.children[f]}return c},flattenTree:function(a){var b=this.toJstreeData(this._root.children,a);return this._walk_itteration=0,this.debug("JsTree data updated"),this.debug(b),b},toJstreeData:function(a,b){"undefined"==typeof a&&(a=this._root.children);var c=[];for(var d in a){var e=a[d];if(!b||b===!0&&("undefined"==typeof e.type||"dir"===e.type)){this._walk_itteration++;var f={text:e.name};if(f.li_attr={id:"js_tree_file_"+this._walk_itteration,"data-path":e.path,"data-synchronized":"undefined"==typeof e._generated},f.state={opened:this._isOpenedDirectory(e),selected:!1,disabled:"undefined"!=typeof e.disabled&&1==e.disabled},"object"==typeof e.children&&null!==e.children){var g=[];for(var h in e.children)g.push(h);g.length>0&&(f.children=this.toJstreeData(e.children,b))}c.push(f)}}return c},openPath:function(a,b){this._currentPath=a;var c=this._findNodeIfExists(a);if(c===!1)this._currentPath=a,this._currentFiles=[];else if(""!==a&&c==this._root)this._currentFiles=[];else{var d=[];for(var e in c.children)d.push(c.children[e]);this.setContents(d)}b&&this._updateViews(!0,!0,!0)},_isOpenedDirectory:function(a){for(var b=this._extractPathNodes(this._currentPath),c=this._extractPathNodes(this._formatPath(a.path)),d=!1,e=0,f=c.length;f>e;e++)d=b[e]===c[e];return d},_naturalFilemanagerSort:function(a,b){var c=a.type,d=b.type;return"dir"==c&&"dir"!=d?-1:"dir"!=c&&"dir"==d?1:String(a.name).toLowerCase()<String(b.name).toLowerCase()?-1:String(a.name).toLowerCase()>String(b.name).toLowerCase()?1:0},sortContent:function(a){"function"!=typeof a&&(a=this._naturalFilemanagerSort),String(this._currentContentSort)==String(a)?this._reverse=!this._reverse:this._reverse=!1,this._currentContentSort=a,this._updateViews(!1,!0,!1)},resetSort:function(){this.sortContent(this._naturalFilemanagerSort)},_updateViews:function(a,b,c){1==a&&this._eventHandler.trigger("filemanager:model:directories_changed",this.flattenTree(!0)),1==b&&(this._currentFiles.sort(this._currentContentSort),this._reverse&&this._currentFiles.reverse(),this._eventHandler.trigger("filemanager:model:content_changed",this._currentFiles)),1==c&&this._eventHandler.trigger("filemanager:model:path_changed",this._currentPath)},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},debug:function(a){"string"==typeof a&&(a="FileTree: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:add_data",function(b){a.addFiles(b.contents),a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:api:update_data",function(b){a.addChanges(b.contents,!0),1==b.selected&&a._eventHandler.trigger("filemanager:model:select",{file:b.contents[0].file})}),this._eventHandler.register("filemanager:api:search_data",function(b){a.setContents(b.contents),a._updateViews(!1,!0,!1)}),this._eventHandler.register("filemanager:view:directory_up",function(b){a.moveUpDirectory()}),this._eventHandler.register("filemanager:view:sort",function(b){void 0!==b&&"function"==typeof b.sortfunction?a.sortContent(b.sortfunction):a.sortContent()}),this._eventHandler.register("filemanager:view:open",function(b){b.isSynchronized&&a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:view:refresh",function(b){a.refresh()}),this._eventHandler.register("filemanager:api:refresh",function(b){a.refresh()})},refresh:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._currentPath,isSynchronized:!1})},moveUpDirectory:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._getHigherDirectory(a._currentPath),isSynchronized:!1})},search:function(a){var b=this;this._eventHandler.trigger("filemanager:view:search",{directory:b._currentPath,query:a})},getCurrentPath:function(){return this._currentPath}};var FileTreeView=function(a,b){var c={debug:!1,i18n:{rename:"Rename",cut:"Cut",paste:"Paste",download:"Download","delete":"Delete"}};this.options=$.extend(!0,c,a),this.init(this.options,b)};FileTreeView.prototype={_debug:!1,_eventHandler:!1,_container:!1,_directoryElement:!1,_contentElement:!1,_uploadLink:!1,_uploadFunctionalityReference:null,_viewFormat:"list",_keepFocusOnDirectories:!1,_keepFocusOnContent:!1,_currentDirectory:"",_currentContent:[],_searching:!1,_searchQuery:"",_apiCalled:!1,_isMultiple:!1,_selectedFiles:[],_editContext:{mode:"none",selector:!1,file:!1},_i18n:{},init:function(a,b){this._debug=a.debug,this._container=$(b),this._directoryElement=$("[data-fm-value=directories]"),this._eventHandler=a.eventHandler,"function"==typeof a.filerowFormat&&(this._formatFilerow=a.filerowFormat),"function"==typeof a.fileCellFormat&&(this._formatFilecell=a.fileCellFormat),"function"==typeof a.renamerowFormat&&(this._formatRenamerow=a.renamerowFormat),"function"==typeof a.renamecellFormat&&(this._formatRenamecell=a.renamecellFormat),"function"==typeof a.uploadFormat&&(this._formatUpload=a.uploadFormat),"object"==typeof a.i18n&&(this._i18n=a.i18n),this._setOverviewLayout("list"),this._addFunctionality(),this._registerEvents()},_formatFilerow:function(a){return'<p class="filemanagerrow"><span>'+a.path+"</span></p>"},_formatFilecell:function(a){return'<p class="filemanagercell"><span>'+a.path+"</span></p>"},_formatRenamerow:function(a){return'<p class="filemanagerrow"><span>'+a.name+"</span></p>"},_formatRenamecell:function(a){return'<p class="filemanagercell"><span>'+a.name+"</span></p>"},refreshTitlebar:function(a){this.debug("Refreshing directory string to "+a),this._currentDirectory=a,$("[data-fm-value=current_directory]").text("/"+a),this._addUploadFunctionality()},refreshDirectories:function(a){var b=this;this._directoryElement.length>0&&"function"==typeof this._directoryElement.jstree&&this._directoryElement.jstree("destroy").jstree({core:{data:a,multiple:!1},plugins:[]}).on("dblclick.jstree",function(a){b._jstreeOpenEvent(a)}).on("keyup.jstree",function(a){13==a.keyCode&&b._jstreeOpenEvent(a)})},_createDirectory:function(a){var b,c='<input type="text" name="directory_name"/>',d={name:c,type:"dir",date_modified:"",size:"",children:{}};"list"==this._viewFormat?b=$(this._formatRenamerow(d)):"grid"==this._viewFormat&&(b=$(this._formatRenamecell(d)));var e=this,f=b.find("input[name=directory_name]");f.on("keydown",{directory:a},function(a){13==a.keyCode&&(""!=a.target.value&&e._eventHandler.trigger("filemanager:view:create",{directory:a.data.directory,name:a.target.value}),e._contentElement.children().eq(0).remove())}).on("blur",function(a){e._contentElement.children().eq(0).remove()}),this._contentElement.prepend(b),f.focus()},refreshContent:function(a){var b=this;if(void 0!==a&&(this._currentContent=a),this._contentElement.length>0){this._contentElement.empty(),$.contextMenu("destroy");for(var c=0,d=b._currentContent.length;d>c;c++){var e=$.extend({},b._currentContent[c]),f=$.extend({},b._currentContent[c]);1==b._searching&&(f.name=f.name.replace(this._searchQuery,'<span class="searchquery">'+this._searchQuery+"</span>")),f.size=this._filesizeFormat(f.size);var g="";g="list"==b._viewFormat?this._formatFilerow(f):this._formatFilecell(f);for(var h=this._generateFileSelector(e),i=$(g).attr("data-fm-functionality","file-"+e.directory+e.name).appendTo(this._contentElement).on("click",{file:e,selector:h},function(a){$(window).width()<=768?b._openContentEvent(a):b._toggleSelection(a)}).on("keyup",{file:e,selector:h},function(a){13==a.keyCode&&(b._keepFocusOnContent=!0,b._openContentEvent(a))}).on("keydown",{file:e,selector:h},function(a){a.ctrlKey&&88==a.keyCode?b._setCutMode(a.data.selector,a.data.file):a.ctrlKey&&86==a.keyCode&&"none"!==b._editContext.mode&&b._pasteMode(a.data.selector,a.data.file)}).on("dblclick",{file:e,selector:h},function(a){b._openContentEvent(a)}),j=0,k=this._selectedFiles.length;k>j;j++)this._selectedFiles[j].selector==h&&i.addClass("selected");b._addContextmenuToElement(h,e),0==c&&1==b._keepFocusOnContent&&(i.focus(),b._keepFocusOnContent=!1)}}this._setEditStyling(),this._updateVisibility(),b._addContextmenuToElement("[data-fm-functionality=directory_up]",{type:"dir",name:"",directory:b._currentDirectory},!0),b._eventHandler.trigger("filemanager:view:rendered");
},_addContextmenuToElement:function(a,b,c){var d=this;$.contextMenu({selector:a,build:function(){var a={rename:{name:d._i18n.rename,icon:"rename"},cut:{name:d._i18n.cut,icon:"cut"},paste:{name:d._i18n.paste,icon:"paste"}};return"dir"!==b.type&&(a.download={name:d._i18n.download,icon:"download"}),a.seperator="---------",a["delete"]={name:d._i18n["delete"],icon:"delete"},c===!0?(a={},"none"!==d._editContext.mode&&(a.paste={name:d._i18n.paste,icon:"paste"})):"none"!==d._editContext.mode?a.paste.disabled=!1:a.paste.disabled=!0,{file:b,callback:function(a,b){switch(a){case"rename":d.createRenamerow(b.selector,b.file);break;case"cut":d._setCutMode(b.selector,b.file);break;case"paste":d._pasteMode(b.selector,b.file);break;case"delete":d._eventHandler.trigger("filemanager:view:delete",{file:b.file});break;case"download":d._eventHandler.trigger("filemanager:view:download",{file:b.file})}},items:a}}})},_generateFileSelector:function(a){var b="file-"+a.directory+a.name;return'[data-fm-functionality="'+b+'"]'},createRenamerow:function(a,b){var c=this._contentElement.find(a),d=this,e=$.extend({},b);e.name='<input type="text" name="file_name" value="'+b.name+'"/>';var f;"list"==this._viewFormat?f=$(d._formatRenamerow(e)):"grid"==this._viewFormat&&(f=$(d._formatRenamecell(e)));var g=f.find("input");g.on("keydown",{file:b},function(a){13==a.keyCode&&(""!=a.target.value&&d._renameEvent(a),d._contentElement.find(f).remove(),d._contentElement.find(c).show())}).on("blur",function(a){d._contentElement.find(f).remove(),d._contentElement.find(c).show()}),d._contentElement.find(c).hide().after(f);var h=g.val();g.val("").focus().val(h)},_openContentEvent:function(a){var b=(a.data.file.directory,a.data.file.path);if(0==b&&(b=a.data.file.directory+a.data.file.name),"undefined"==typeof a.data.file.type||"dir"==a.data.file.type){var c=!1;this._eventHandler.trigger("filemanager:view:open",{directory:b,isSynchronized:c})}else this._toggleSelection(a)},_toggleSelection:function(a){this._isFileSelected(a.data.file)?this._deselectEvent(a):this._selectEvent(a)},_selectEvent:function(a){0==this._isMultiple&&this._clearSelection(),this._selectedFiles.push({selector:a.data.selector,file:a.data.file}),$(a.data.selector).addClass("selected"),this._eventHandler.trigger("filemanager:view:select",{path:a.data.file.path,file:a.data.file})},_isFileSelected:function(a){for(var b=0,c=this._selectedFiles.length;c>b;b++)if(a==this._selectedFiles[b].file)return!0;return!1},_deselectEvent:function(a){for(var b=[],c=0,d=this._selectedFiles.length;d>c;c++)a.data.file==this._selectedFiles[c].file?$(a.data.selector).removeClass("selected"):b=this._selectedFiles[c];this._selectedFiles=b,this._eventHandler.trigger("filemanager:view:deselect",{path:a.data.file.path,file:a.data.file})},_clearSelection:function(){for(var a=0,b=this._selectedFiles.length;b>a;a++)$(this._selectedFiles[a].selector).removeClass("selected");this._selectedFiles=[]},_jstreeOpenEvent:function(a){var b=$(a.target).closest("li");if(b.length>0){var c=b.attr("data-path"),d="false"!=b.attr("data-synchronized");"undefined"!=typeof c&&this._eventHandler.trigger("filemanager:view:open",{directory:c,isSynchronized:!d})}},_searchEvent:function(a){var b=a.target.value;""!=b?(this._eventHandler.trigger("filemanager:view:search",{directory:this._currentDirectory,query:b}),$("[data-fm-value=search_query]").text(b)):this._eventHandler.trigger("filemanager:view:open",{directory:this._currentDirectory,isSynchronized:!1})},_renameEvent:function(a){var b=a.target.value;""!=b&&this._eventHandler.trigger("filemanager:view:rename",{file:a.data.file,newname:b})},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},_filesizeFormat:function(a){var b=1024,c=1024*b,d=1024*c,e="";return 0==isNaN(a)&&(a=parseInt(a),e=b>a?a+" B":c>a?(a/b).toFixed(1)+" KB":d>a?(a/c).toFixed(1)+" MB":(a/d).toFixed(1)+" GB"),e},_setOverviewLayout:function(a){"list"==a||"grid"==a?(this._viewFormat=a,"list"==this._viewFormat?($("[data-fm-functionality=set_list]").addClass("selected"),$("[data-fm-functionality=set_grid]").removeClass("selected"),this._contentElement=$("[data-fm-value=list_content]")):"grid"==this._viewFormat&&($("[data-fm-functionality=set_grid]").addClass("selected"),$("[data-fm-functionality=set_list]").removeClass("selected"),this._contentElement=$("[data-fm-value=grid_content]")),this._updateVisibility()):this.errorLog("Overview layout can only be a list or a grid")},_resetEditStyles:function(){this._editMode="none",this._editContext.selector!==!1&&($(this._editContext.selector).removeClass("mode-cut").removeClass("mode-copy"),this._editContext.selector=!1),this._editContext.file=!1},_setEditStyling:function(){var a=this._editContext;if(a.file!==!1&&a.selector!==!1)switch(a.mode){case"cut":$(a.selector).addClass("mode-cut");break;case"copy":$(a.selector).addClass("mode-copy");break;case"none":this._resetEditStyles()}},_setCutMode:function(a,b){this._resetEditStyles(),this._editContext={mode:"cut",selector:a,file:b},this._setEditStyling()},_setCopyMode:function(a,b){this._resetEditStyles(),this._editContext=this._editContext={mode:"copy",selector:a,file:b},this._setEditStyling()},_pasteMode:function(a,b){if("none"!==this._editContext.mode&&this._editContext.file!==!1){var c=b.directory;"dir"==b.type&&(c+=b.name),this._eventHandler.trigger("filemanager:view:move",{file:this._editContext.file,newlocation:c})}this._resetEditStyles()},_updateVisibility:function(){var a=function(a){return"[data-fm-show="+a+"]"};"list"==this._viewFormat?($(a("list_view")).show(),$(a("grid_view")).hide()):"grid"==this._viewFormat&&($(a("list_view")).hide(),$(a("grid_view")).show()),$(a("no_content")).hide(),$(a("no_search_results")).hide(),0==this._currentContent.length?0==this._searching?this._apiCalled&&$(a("no_content")).show():$(a("no_search_results")).show():1==this._searching&&$(a("search_results")).show(),""!==this._currentDirectory?$(a("no_root")).show():$(a("no_root")).hide()},_addFunctionality:function(){var a=this,b=function(a){13==a.keyCode&&(a.preventDefault(),$(a.target).addClass("active").trigger("mousedown"))},c=function(a){13==a.keyCode&&$(a.currentTarget).removeClass("active").trigger("click")};$("[data-fm-functionality=directory_up]").on("click",function(b){a._eventHandler.trigger("filemanager:view:directory_up",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=refresh]").on("click",function(){a._eventHandler.trigger("filemanager:view:refresh",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=create_directory]").on("click",function(b){a._createDirectory(a._currentDirectory)}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_list]").on("click",function(b){a._setOverviewLayout("list"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_grid]").on("click",function(b){a._setOverviewLayout("grid"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality^='sort_']").on("click",function(b){var c=$(b.currentTarget).attr("data-fm-functionality"),d=c.substring(5);"filename"===d?a._eventHandler.trigger("filemanager:view:sort"):a._eventHandler.trigger("filemanager:view:sort",{sortfunction:function(a,b){return a[d]>b[d]?-1:a[d]<b[d]?1:0}})}).on("keydown",b).on("keyup",c),$("input[data-fm-functionality=search]").on("search",{directory:a._currentDirectory},function(b){a._searchEvent(b)}).on("keydown",function(a){13==a.keyCode&&a.preventDefault()}).on("keyup",{directory:a._currentDirectory},function(b){13==b.keyCode&&a._searchEvent(b)}),a._addUploadFunctionality()},_addUploadFunctionality:function(){var a=this;null!==this._uploadFunctionalityReference&&this._uploadFunctionalityReference.destroy();var b=$("[data-fm-functionality=upload_progress]"),c=new ss.SimpleUpload({url:"/admin/fileapi/create",name:"filemanager_upload",method:"POST",hoverClass:"focus",focusClass:"active",multipart:!0,data:{filemanager_directory:a._currentDirectory},responseType:"json",dropzone:"filemanager_view",debug:a._debug,startXHR:function(){b.length>0&&(b.css("width","0%"),this.setProgressBar(b)),a._eventHandler.trigger("filemanager:api:uploading")},onComplete:function(b,c){a._eventHandler.trigger("filemanager:api:upload_done"),a._eventHandler.trigger("filemanager:view:ajax_upload",{response:c,directory:a._currentDirectory})},onAbort:function(){a._eventHandler.trigger("filemanager:api:upload_done")},onError:function(b,c,d,e,f){a._eventHandler.trigger("filemanager:api:upload_done"),f=JSON.parse(f),0!=f&&a._eventHandler.trigger("filemanager:api:error",{message:f.data.message,status:e,statuscode:d})}});if(c.setAbortBtn($("[data-fm-functionality=abort_upload]")),null===this._uploadFunctionalityReference){var d=$("[data-fm-functionality=upload_button]");0!==d.length&&d.on("click",function(){$("input[name=filemanager_upload]").trigger("click")}).on("keydown",function(a){13==a.keyCode&&(d.addClass("active"),a.preventDefault())}).on("keyup",function(a){13==a.keyCode&&(d.removeClass("active"),$("input[name=filemanager_upload]").trigger("click"))})}this._uploadFunctionalityReference=c},debug:function(a){"string"==typeof a&&(a="FileTreeView: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:error",function(b){a._apiCalled=!0,alert(b.message)}),this._eventHandler.register("filemanager:model:directories_changed",function(b){a._apiCalled=!0,a._searching=!1,a._searchQuery="",a.refreshDirectories(b)}),this._eventHandler.register("filemanager:view:search",function(b){a._apiCalled=!0,a._searching=!0,a._searchQuery=b.query}),this._eventHandler.register("filemanager:model:content_changed",function(b){a._apiCalled=!0,a.refreshContent(b)}),this._eventHandler.register("filemanager:model:path_changed",function(b){a._apiCalled=!0,a.refreshTitlebar(b)}),this._eventHandler.register("filemanager:model:select",function(b){var c={data:{file:b.file,selector:a._generateFileSelector(b.file)}};a._selectEvent(c)})}};var FilemanagerAPI=function(a){var b={debug:!1,api:{url:window.location.href,paths:{create:"/create",read:"",search:"/search",move:"/move",rename:"/rename","delete":"/delete",download:"/download"}}};this.options=$.extend(!0,b,a),this.init(this.options)};FilemanagerAPI.prototype={_debug:!1,_url:"",_path_create:"",_path_move:"",_path_rename:"",_path_read_directory:"",_path_delete:"",_path_search:"",_path_download:"",_eventHandler:!1,_disableRequests:!1,init:function(a){return null!==a&&"object"==typeof a&&(this._eventHandler=a.eventHandler,"undefined"!=typeof a.debug&&(this._debug=a.debug),null!==a.api&&"object"==typeof a.api&&("undefined"!=typeof a.api.url&&""!=a.api.url?this._url=a.api.url:(this._disableRequests=!0,console.error("NO APILINK FOUND !!!")),null!==a.api.paths&&"object"==typeof a.api.paths&&("undefined"!=typeof a.api.paths.move&&(this._path_move=a.api.paths.move),"undefined"!=typeof a.api.paths.rename&&(this._path_rename=a.api.paths.rename),"undefined"!=typeof a.api.paths.create&&(this._path_create=a.api.paths.create),"undefined"!=typeof a.api.paths["delete"]&&(this._path_delete=a.api.paths["delete"]),"undefined"!=typeof a.api.paths.read&&(this._path_read_directory=a.api.paths.read),"undefined"!=typeof a.api.paths.search&&(this._path_search=a.api.paths.search),"undefined"!=typeof a.api.paths.download&&(this._path_download=a.api.paths.download))),"string"==typeof a.api.startingDirectory&&this.read(a.api.startingDirectory)),this._registerEvents(),this.debug("Initializing"),this.debug(a),this},_sendRequest:function(a,b,c){"undefined"==typeof b&&(b="GET"),"object"!=typeof c&&(c={});var d=this;this._eventHandler.trigger("filemanager:api:loading");var e="",f=new RegExp("^(?:[a-z]+:)?//","i");if(f.test(a))e=a;else{var g="";g=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),e=g+a}return $.ajax({url:e,data:c,dataType:"json",method:b,self:d,beforeSend:function(a){d.debug("Sending "+this.method+" request to "+this.url+"...")}}).done(function(a){d._eventHandler.trigger("filemanager:api:done"),d.debug(a)}).fail(function(a,b,c){d._eventHandler.trigger("filemanager:api:done"),d.errorLog({statuscode:a.status,statustext:a.statusText,response:a.responseText})})},read:function(a){var b=this,c=this._url+this._path_read_directory;this._sendRequest(c,"GET",{directory:a}).done(function(c,d,e){b._eventHandler.trigger("filemanager:api:add_data",{contents:c.data.contents,directory:a})}).fail(function(a){b._handleApiError(a)})},search:function(a,b){var c=this,d=this._url+this._path_search;this._sendRequest(d,"GET",{directory:a,q:b}).done(function(d,e,f){c._eventHandler.trigger("filemanager:api:search_data",{contents:d.data.contents,directory:a,query:b})}).fail(function(a){c._handleApiError(a)})},move:function(a,b,c){var d=this,e=this._url+this._path_move,f=a+b;this._sendRequest(e,"POST",{filemanager_filepath:f,filemanager_newdirectory:c}).done(function(b,e,f){var g=[];if("object"==typeof b.data.changes)for(var h in b.data.changes)g.push(b.data.changes[h]);else g=b.data.changes;a!==c&&d._eventHandler.trigger("filemanager:api:refresh"),d._eventHandler.trigger("filemanager:api:update_data",{contents:g,directory:c})}).fail(function(a){d._handleApiError(a)})},rename:function(a,b,c){var d=this,e=this._url+this._path_rename;this._sendRequest(e,"POST",{filemanager_directory:a,filemanager_filename:b,filemanager_newfilename:c}).done(function(b,c,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;d._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){d._handleApiError(a)})},createDirectory:function(a,b){var c=this,d=this._url+this._path_create;this._sendRequest(d,"POST",{type:"directory",filemanager_directory:a,directory_name:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},"delete":function(a,b){var c=this,d=this._url+this._path_delete;this._sendRequest(d,"POST",{filemanager_directory:a,filemanager_filename:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},download:function(a){var b=this._url+this._path_download,c="?";b.indexOf(c)>-1&&(c="&"),window.location=b+c+"filemanager_path="+encodeURI(a)},uploadResponse:function(a,b){this._eventHandler.trigger("filemanager:api:done"),this._eventHandler.trigger("filemanager:api:update_data",{contents:b.data.changes,directory:a,selected:!0})},_handleApiError:function(a){var b=this,c=JSON.parse(a.responseText);b._eventHandler.trigger("filemanager:api:error",{message:c.data.message,status:c.status,statuscode:a.status})},debug:function(a){"string"==typeof a&&(a="FilemanagerAPI: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:view:open",function(b){0==b.isSynchronized&&a.read(b.directory)}),this._eventHandler.register("filemanager:view:search",function(b){a.search(b.directory,b.query)}),this._eventHandler.register("filemanager:view:create",function(b){a.createDirectory(b.directory,b.name)}),this._eventHandler.register("filemanager:view:rename",function(b){a.rename(b.file.directory,b.file.name,b.newname)}),this._eventHandler.register("filemanager:view:move",function(b){a.move(b.file.directory,b.file.name,b.newlocation)}),this._eventHandler.register("filemanager:view:delete",function(b){a["delete"](b.file.directory,b.file.name)}),this._eventHandler.register("filemanager:view:ajax_upload",function(b){a.uploadResponse(b.directory,b.response)}),this._eventHandler.register("filemanager:view:download",function(b){a.download(b.file.path)})}};var FilemanagerEventHandler=function(a){var b={debug:!1};a=$.extend(!0,b,a),this.init(a)};FilemanagerEventHandler.prototype={_events:{},_debug:!1,init:function(a){null!==a&&"object"==typeof a&&"undefined"!=typeof a.debug&&(this._debug=a.debug)},hasEvent:function(a,b){if(this._events.hasOwnProperty(a))return!0;if(b)throw'No event registered for "'+a+'"';return!1},register:function(a,b){this.debug("Registering "+a),this._create(a),this._events[a].push(b)},unRegister:function(a){this.hasEvent(a,!0)&&delete this._events[a]},_create:function(a){this.hasEvent(a,!1)||(this._events[a]=[])},trigger:function(a){if(this.debug("Triggering "+a),this.hasEvent(a,!1)){var b=Array.prototype.slice.call(arguments,1);$.each(this._events[a],function(a,c){c.apply(c,b)}.bind(this))}},debug:function(a){this._debug&&console.log(a)}},function(){$.fn.filemanager=function(a){if("undefined"==typeof a&&(a={}),a.eventHandler=new FilemanagerEventHandler(a),null!==a.api&&"object"==typeof a.api)if("undefined"!=typeof a.api.url&&""!=a.api.url){this.data("event",a.eventHandler),this.data("view",new FileTreeView(a)),this.data("api",new FilemanagerAPI(a)),this.data("tree",new FileTree(a));var b=this,c={refresh:function(){return b.data("tree").refresh(),b},moveUpDirectory:function(){b.data("tree").moveUpDirectory()},createDirectory:function(){var a=b.data("tree").getCurrentPath();return b.data("view")._createDirectory(a),b},search:function(a){return b.data("tree").search(a),b},on:function(a,c){return b.data("event").register(a,c),b}};this.data("filemanager",c)}else console.error("Filemanager: NO APILINK FOUND - Aborting creation");else console.error("Filemanager: NO APILINK FOUND - Aborting creation");return this}}(jQuery);var FileTree=function(a){var b={debug:!1};this.options=$.extend(!0,b,a),this.init(this.options)};FileTree.prototype={_debug:!1,_root:{children:{}},_currentPath:"",_currentFiles:[],_currentContentSort:null,_reverse:!1,_walk_itteration:0,_eventHandler:null,init:function(a){return null!==a&&"object"==typeof a&&(this._debug=a.debug,this._eventHandler=a.eventHandler,this._registerEvents()),this._currentContentSort=this._naturalFilemanagerSort,this.debug("Initializing"),this.debug(a),this},addFiles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];this._setFile(e)}this.debug("Tree structure after updating"),this.debug(this._root),1==b&&this._updateViews(!0,!1,!1)},setContents:function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];e.path=this._formatPath(e.path,!0),e.directory=this._formatPath(e.directory),b.push(e)}this._currentFiles=b},_setFile:function(a){0==a.hasOwnProperty("path")&&(a.path=this._formatPath(a.directory)+a.name),a.path=this._formatPath(a.path,!0),a.directory=this._formatPath(a.directory),0==a.hasOwnProperty("children")&&(a.children={});var b=this._findNode(a.directory);"undefined"==typeof b.children[a.name]?b.children[a.name]=a:b.children[a.name]=$.extend(!0,b.children[a.name],a)},_findNode:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];"undefined"==typeof c.children[f]&&(c.children[f]=this._generateNode(f,b)),c=c.children[f]}return"undefined"==typeof c.children&&(c.children={}),c},_generateNode:function(a,b){var c={};c.name=a;for(var d="",e=0;e<b.length&&(d+=b[e]+"/",b[e+1]!=a);e++);return c.directory=d,c.path=d+a,c.children={},c},_extractPathNodes:function(a){"string"!=typeof a&&(a="");for(var b=a.split("/"),c=[],d=0,e=b.length;e>d;d++)""!==b[d]&&c.push(b[d]);return c},addChanges:function(a,b){if("undefined"!=typeof a||!a)for(var c=0,d=a.length;d>c;c++)this._executeChange(a[c]);this.debug("Tree structure after updating"),this.debug(this._root),this.debug("Updating the current files"),this.openPath(this._currentPath,!1),this.debug(this._currentFiles),b&&this._updateViews(!0,!0,!0)},_executeChange:function(a){switch(a.type){case"delete":this._deleteNode(a.file);break;case"create":this._setFile(a.file);break;case"update":case"rename":case"move":this._updateNode(a.file,a.updatedfile)}},_updateNode:function(a,b){var c=this._findNodeIfExists(a.directory);if(c!==!1||"undefined"!=typeof c.children[a.name]){var d=c.children[a.name],e=this._formatPath(d.path);b.path=b.directory+b.name;var f=$.extend(!0,d,b),g=this._formatPath(b.path);e!=g&&(f=this._updateChildPaths(f),this._deleteNode(a)),this._setFile(f)}},_updateChildPaths:function(a){if("undefined"!=typeof a.children){var b=[];for(var c in a.children)b.push(c);for(var d=0,e=b.length;e>d;d++)if("undefined"!=typeof a.children[b[d]]){var f=a.children[b[d]];f.directory=this._formatPath(a.path),f.path=this._formatPath(a.path)+f.name,a.children[b[d]]=this._updateChildPaths(f)}}return a},_formatPath:function(a,b){return"undefined"==typeof a&&(a=""),0!==a.length&&"/"==a.substr(0,1)&&(a=a.substr(1,a.length-1)),b!==!0&&0!==a.length&&"/"!=a.substr(a,a.length-1)&&(a+="/"),a=a.replace(/\/\/+/g,"/")},_deleteNode:function(a){var b=this._findNodeIfExists(a.directory);b!==!1&&delete b.children[a.name]},_findNodeIfExists:function(a){for(var b=this._extractPathNodes(a),c=this._root,d=0,e=b.length;e>d;d++){var f=b[d];if("undefined"==typeof c.children[f]){c=!1;break}c=c.children[f]}return c},flattenTree:function(a){var b=this.toJstreeData(this._root.children,a);return this._walk_itteration=0,this.debug("JsTree data updated"),this.debug(b),b},toJstreeData:function(a,b){"undefined"==typeof a&&(a=this._root.children);var c=[];for(var d in a){var e=a[d];if(!b||b===!0&&("undefined"==typeof e.type||"dir"===e.type)){this._walk_itteration++;var f={text:e.name};if(f.li_attr={id:"js_tree_file_"+this._walk_itteration,"data-path":e.path,"data-synchronized":"undefined"==typeof e._generated},f.state={opened:this._isOpenedDirectory(e),selected:!1,disabled:"undefined"!=typeof e.disabled&&1==e.disabled},"object"==typeof e.children&&null!==e.children){var g=[];for(var h in e.children)g.push(h);g.length>0&&(f.children=this.toJstreeData(e.children,b))}c.push(f)}}return c},openPath:function(a,b){this._currentPath=a;var c=this._findNodeIfExists(a);if(c===!1)this._currentPath=a,this._currentFiles=[];else if(""!==a&&c==this._root)this._currentFiles=[];else{var d=[];for(var e in c.children)d.push(c.children[e]);this.setContents(d)}b&&this._updateViews(!0,!0,!0)},_isOpenedDirectory:function(a){for(var b=this._extractPathNodes(this._currentPath),c=this._extractPathNodes(this._formatPath(a.path)),d=!1,e=0,f=c.length;f>e;e++)d=b[e]===c[e];return d},_naturalFilemanagerSort:function(a,b){var c=a.type,d=b.type;return"dir"==c&&"dir"!=d?-1:"dir"!=c&&"dir"==d?1:String(a.name).toLowerCase()<String(b.name).toLowerCase()?-1:String(a.name).toLowerCase()>String(b.name).toLowerCase()?1:0},sortContent:function(a){"function"!=typeof a&&(a=this._naturalFilemanagerSort),String(this._currentContentSort)==String(a)?this._reverse=!this._reverse:this._reverse=!1,this._currentContentSort=a,this._updateViews(!1,!0,!1)},resetSort:function(){this.sortContent(this._naturalFilemanagerSort)},_updateViews:function(a,b,c){1==a&&this._eventHandler.trigger("filemanager:model:directories_changed",this.flattenTree(!0)),1==b&&(this._currentFiles.sort(this._currentContentSort),this._reverse&&this._currentFiles.reverse(),this._eventHandler.trigger("filemanager:model:content_changed",this._currentFiles)),1==c&&this._eventHandler.trigger("filemanager:model:path_changed",this._currentPath)},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},debug:function(a){"string"==typeof a&&(a="FileTree: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:add_data",function(b){a.addFiles(b.contents),a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:api:update_data",function(b){a.addChanges(b.contents,!0),1==b.selected&&a._eventHandler.trigger("filemanager:model:select",{file:b.contents[0].file})}),this._eventHandler.register("filemanager:api:search_data",function(b){a.setContents(b.contents),a._updateViews(!1,!0,!1)}),this._eventHandler.register("filemanager:view:directory_up",function(b){a.moveUpDirectory()}),this._eventHandler.register("filemanager:view:sort",function(b){void 0!==b&&"function"==typeof b.sortfunction?a.sortContent(b.sortfunction):a.sortContent()}),this._eventHandler.register("filemanager:view:open",function(b){b.isSynchronized&&a.openPath(b.directory,!0)}),this._eventHandler.register("filemanager:view:refresh",function(b){a.refresh()}),this._eventHandler.register("filemanager:api:refresh",function(b){a.refresh()})},refresh:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._currentPath,isSynchronized:!1})},moveUpDirectory:function(){var a=this;this._eventHandler.trigger("filemanager:view:open",{directory:a._getHigherDirectory(a._currentPath),isSynchronized:!1})},search:function(a){var b=this;this._eventHandler.trigger("filemanager:view:search",{directory:b._currentPath,query:a})},getCurrentPath:function(){return this._currentPath}};var FileTreeView=function(a,b){var c={debug:!1,i18n:{rename:"Rename",cut:"Cut",paste:"Paste",download:"Download","delete":"Delete"}};this.options=$.extend(!0,c,a),this.init(this.options,b)};FileTreeView.prototype={_debug:!1,_eventHandler:!1,_container:!1,_directoryElement:!1,_contentElement:!1,_uploadLink:!1,_uploadFunctionalityReference:null,_viewFormat:"list",_keepFocusOnDirectories:!1,_keepFocusOnContent:!1,_currentDirectory:"",_currentContent:[],_searching:!1,_searchQuery:"",_apiCalled:!1,_isMultiple:!1,_selectedFiles:[],_editContext:{mode:"none",selector:!1,file:!1},_i18n:{},init:function(a,b){this._debug=a.debug,this._container=$(b),this._directoryElement=$("[data-fm-value=directories]"),this._eventHandler=a.eventHandler,"function"==typeof a.filerowFormat&&(this._formatFilerow=a.filerowFormat),"function"==typeof a.fileCellFormat&&(this._formatFilecell=a.fileCellFormat),"function"==typeof a.renamerowFormat&&(this._formatRenamerow=a.renamerowFormat),"function"==typeof a.renamecellFormat&&(this._formatRenamecell=a.renamecellFormat),"function"==typeof a.uploadFormat&&(this._formatUpload=a.uploadFormat),"object"==typeof a.i18n&&(this._i18n=a.i18n),this._setOverviewLayout("list"),this._addFunctionality(),this._registerEvents()},_formatFilerow:function(a){return'<p class="filemanagerrow"><span>'+a.path+"</span></p>"},_formatFilecell:function(a){return'<p class="filemanagercell"><span>'+a.path+"</span></p>"},_formatRenamerow:function(a){return'<p class="filemanagerrow"><span>'+a.name+"</span></p>"},_formatRenamecell:function(a){return'<p class="filemanagercell"><span>'+a.name+"</span></p>"},refreshTitlebar:function(a){this.debug("Refreshing directory string to "+a),this._currentDirectory=a,$("[data-fm-value=current_directory]").text("/"+a),this._addUploadFunctionality()},refreshDirectories:function(a){var b=this;this._directoryElement.length>0&&"function"==typeof this._directoryElement.jstree&&this._directoryElement.jstree("destroy").jstree({core:{data:a,multiple:!1},plugins:[]}).on("dblclick.jstree",function(a){b._jstreeOpenEvent(a)}).on("keyup.jstree",function(a){13==a.keyCode&&b._jstreeOpenEvent(a)})},_createDirectory:function(a){var b,c='<input type="text" name="directory_name"/>',d={name:c,type:"dir",date_modified:"",size:"",children:{}};"list"==this._viewFormat?b=$(this._formatRenamerow(d)):"grid"==this._viewFormat&&(b=$(this._formatRenamecell(d)));var e=this,f=b.find("input[name=directory_name]");f.on("keydown",{directory:a},function(a){13==a.keyCode&&(""!=a.target.value&&e._eventHandler.trigger("filemanager:view:create",{directory:a.data.directory,name:a.target.value}),e._contentElement.children().eq(0).remove())}).on("blur",function(a){e._contentElement.children().eq(0).remove()}),this._contentElement.prepend(b),f.focus()},refreshContent:function(a){var b=this;if(void 0!==a&&(this._currentContent=a),this._contentElement.length>0){this._contentElement.empty(),$.contextMenu("destroy");for(var c=0,d=b._currentContent.length;d>c;c++){var e=$.extend({},b._currentContent[c]),f=$.extend({},b._currentContent[c]);1==b._searching&&(f.name=f.name.replace(this._searchQuery,'<span class="searchquery">'+this._searchQuery+"</span>")),f.size=this._filesizeFormat(f.size);var g="";g="list"==b._viewFormat?this._formatFilerow(f):this._formatFilecell(f);for(var h=this._generateFileSelector(e),i=$(g).attr("data-fm-functionality","file-"+e.directory+e.name).appendTo(this._contentElement).on("click",{file:e,selector:h},function(a){$(window).width()<=768?b._openContentEvent(a):b._toggleSelection(a)}).on("keyup",{file:e,selector:h},function(a){13==a.keyCode&&(b._keepFocusOnContent=!0,b._openContentEvent(a))}).on("keydown",{file:e,selector:h},function(a){a.ctrlKey&&88==a.keyCode?b._setCutMode(a.data.selector,a.data.file):a.ctrlKey&&86==a.keyCode&&"none"!==b._editContext.mode&&b._pasteMode(a.data.selector,a.data.file)}).on("dblclick",{file:e,selector:h},function(a){b._openContentEvent(a)}),j=0,k=this._selectedFiles.length;k>j;j++)this._selectedFiles[j].selector==h&&i.addClass("selected");b._addContextmenuToElement(h,e),0==c&&1==b._keepFocusOnContent&&(i.focus(),b._keepFocusOnContent=!1)}}this._setEditStyling(),this._updateVisibility(),b._addContextmenuToElement("[data-fm-functionality=directory_up]",{type:"dir",name:"",directory:b._currentDirectory},!0),b._eventHandler.trigger("filemanager:view:rendered")},_addContextmenuToElement:function(a,b,c){var d=this;$.contextMenu({selector:a,build:function(){var a={rename:{name:d._i18n.rename,icon:"rename"},cut:{name:d._i18n.cut,icon:"cut"},paste:{name:d._i18n.paste,icon:"paste"}};return"dir"!==b.type&&(a.download={name:d._i18n.download,icon:"download"}),a.seperator="---------",a["delete"]={name:d._i18n["delete"],icon:"delete"},c===!0?(a={},"none"!==d._editContext.mode&&(a.paste={name:d._i18n.paste,icon:"paste"})):"none"!==d._editContext.mode?a.paste.disabled=!1:a.paste.disabled=!0,{file:b,callback:function(a,b){switch(a){case"rename":d.createRenamerow(b.selector,b.file);break;case"cut":d._setCutMode(b.selector,b.file);break;case"paste":d._pasteMode(b.selector,b.file);break;case"delete":d._eventHandler.trigger("filemanager:view:delete",{file:b.file});break;case"download":d._eventHandler.trigger("filemanager:view:download",{file:b.file})}},items:a}}})},_generateFileSelector:function(a){var b="file-"+a.directory+a.name;return'[data-fm-functionality="'+b+'"]'},createRenamerow:function(a,b){var c=this._contentElement.find(a),d=this,e=$.extend({},b);e.name='<input type="text" name="file_name" value="'+b.name+'"/>';var f;"list"==this._viewFormat?f=$(d._formatRenamerow(e)):"grid"==this._viewFormat&&(f=$(d._formatRenamecell(e)));var g=f.find("input");g.on("keydown",{file:b},function(a){13==a.keyCode&&(""!=a.target.value&&d._renameEvent(a),d._contentElement.find(f).remove(),d._contentElement.find(c).show())}).on("blur",function(a){d._contentElement.find(f).remove(),d._contentElement.find(c).show()}),d._contentElement.find(c).hide().after(f);var h=g.val();g.val("").focus().val(h)},_openContentEvent:function(a){var b=(a.data.file.directory,a.data.file.path);if(0==b&&(b=a.data.file.directory+a.data.file.name),"undefined"==typeof a.data.file.type||"dir"==a.data.file.type){var c=!1;this._eventHandler.trigger("filemanager:view:open",{directory:b,isSynchronized:c})}else this._toggleSelection(a)},_toggleSelection:function(a){this._isFileSelected(a.data.file)?this._deselectEvent(a):this._selectEvent(a)},_selectEvent:function(a){0==this._isMultiple&&this._clearSelection(),this._selectedFiles.push({selector:a.data.selector,file:a.data.file}),$(a.data.selector).addClass("selected"),this._eventHandler.trigger("filemanager:view:select",{path:a.data.file.path,file:a.data.file})},
_isFileSelected:function(a){for(var b=0,c=this._selectedFiles.length;c>b;b++)if(a==this._selectedFiles[b].file)return!0;return!1},_deselectEvent:function(a){for(var b=[],c=0,d=this._selectedFiles.length;d>c;c++)a.data.file==this._selectedFiles[c].file?$(a.data.selector).removeClass("selected"):b=this._selectedFiles[c];this._selectedFiles=b,this._eventHandler.trigger("filemanager:view:deselect",{path:a.data.file.path,file:a.data.file})},_clearSelection:function(){for(var a=0,b=this._selectedFiles.length;b>a;a++)$(this._selectedFiles[a].selector).removeClass("selected");this._selectedFiles=[]},_jstreeOpenEvent:function(a){var b=$(a.target).closest("li");if(b.length>0){var c=b.attr("data-path"),d="false"!=b.attr("data-synchronized");"undefined"!=typeof c&&this._eventHandler.trigger("filemanager:view:open",{directory:c,isSynchronized:!d})}},_searchEvent:function(a){var b=a.target.value;""!=b?(this._eventHandler.trigger("filemanager:view:search",{directory:this._currentDirectory,query:b}),$("[data-fm-value=search_query]").text(b)):this._eventHandler.trigger("filemanager:view:open",{directory:this._currentDirectory,isSynchronized:!1})},_renameEvent:function(a){var b=a.target.value;""!=b&&this._eventHandler.trigger("filemanager:view:rename",{file:a.data.file,newname:b})},_getHigherDirectory:function(a){var b=a.split("/");b=b.filter(function(a){return""!=a});for(var c="",d=0,e=b.length-1;e>d;d++)c+=b[d],d!==e-1&&(c+="/");return c},_filesizeFormat:function(a){var b=1024,c=1024*b,d=1024*c,e="";return 0==isNaN(a)&&(a=parseInt(a),e=b>a?a+" B":c>a?(a/b).toFixed(1)+" KB":d>a?(a/c).toFixed(1)+" MB":(a/d).toFixed(1)+" GB"),e},_setOverviewLayout:function(a){"list"==a||"grid"==a?(this._viewFormat=a,"list"==this._viewFormat?($("[data-fm-functionality=set_list]").addClass("selected"),$("[data-fm-functionality=set_grid]").removeClass("selected"),this._contentElement=$("[data-fm-value=list_content]")):"grid"==this._viewFormat&&($("[data-fm-functionality=set_grid]").addClass("selected"),$("[data-fm-functionality=set_list]").removeClass("selected"),this._contentElement=$("[data-fm-value=grid_content]")),this._updateVisibility()):this.errorLog("Overview layout can only be a list or a grid")},_resetEditStyles:function(){this._editMode="none",this._editContext.selector!==!1&&($(this._editContext.selector).removeClass("mode-cut").removeClass("mode-copy"),this._editContext.selector=!1),this._editContext.file=!1},_setEditStyling:function(){var a=this._editContext;if(a.file!==!1&&a.selector!==!1)switch(a.mode){case"cut":$(a.selector).addClass("mode-cut");break;case"copy":$(a.selector).addClass("mode-copy");break;case"none":this._resetEditStyles()}},_setCutMode:function(a,b){this._resetEditStyles(),this._editContext={mode:"cut",selector:a,file:b},this._setEditStyling()},_setCopyMode:function(a,b){this._resetEditStyles(),this._editContext=this._editContext={mode:"copy",selector:a,file:b},this._setEditStyling()},_pasteMode:function(a,b){if("none"!==this._editContext.mode&&this._editContext.file!==!1){var c=b.directory;"dir"==b.type&&(c+=b.name),this._eventHandler.trigger("filemanager:view:move",{file:this._editContext.file,newlocation:c})}this._resetEditStyles()},_updateVisibility:function(){var a=function(a){return"[data-fm-show="+a+"]"};"list"==this._viewFormat?($(a("list_view")).show(),$(a("grid_view")).hide()):"grid"==this._viewFormat&&($(a("list_view")).hide(),$(a("grid_view")).show()),$(a("no_content")).hide(),$(a("no_search_results")).hide(),0==this._currentContent.length?0==this._searching?this._apiCalled&&$(a("no_content")).show():$(a("no_search_results")).show():1==this._searching&&$(a("search_results")).show(),""!==this._currentDirectory?$(a("no_root")).show():$(a("no_root")).hide()},_addFunctionality:function(){var a=this,b=function(a){13==a.keyCode&&(a.preventDefault(),$(a.target).addClass("active").trigger("mousedown"))},c=function(a){13==a.keyCode&&$(a.currentTarget).removeClass("active").trigger("click")};$("[data-fm-functionality=directory_up]").on("click",function(b){a._eventHandler.trigger("filemanager:view:directory_up",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=refresh]").on("click",function(){a._eventHandler.trigger("filemanager:view:refresh",{})}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=create_directory]").on("click",function(b){a._createDirectory(a._currentDirectory)}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_list]").on("click",function(b){a._setOverviewLayout("list"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality=set_grid]").on("click",function(b){a._setOverviewLayout("grid"),a.refreshContent()}).on("keydown",b).on("keyup",c),$("[data-fm-functionality^='sort_']").on("click",function(b){var c=$(b.currentTarget).attr("data-fm-functionality"),d=c.substring(5);"filename"===d?a._eventHandler.trigger("filemanager:view:sort"):a._eventHandler.trigger("filemanager:view:sort",{sortfunction:function(a,b){return a[d]>b[d]?-1:a[d]<b[d]?1:0}})}).on("keydown",b).on("keyup",c),$("input[data-fm-functionality=search]").on("search",{directory:a._currentDirectory},function(b){a._searchEvent(b)}).on("keydown",function(a){13==a.keyCode&&a.preventDefault()}).on("keyup",{directory:a._currentDirectory},function(b){13==b.keyCode&&a._searchEvent(b)}),a._addUploadFunctionality()},_addUploadFunctionality:function(){var a=this;null!==this._uploadFunctionalityReference&&this._uploadFunctionalityReference.destroy();var b=$("[data-fm-functionality=upload_progress]"),c=new ss.SimpleUpload({url:"/admin/fileapi/create",name:"filemanager_upload",method:"POST",hoverClass:"focus",focusClass:"active",multipart:!0,data:{filemanager_directory:a._currentDirectory},responseType:"json",dropzone:"filemanager_view",debug:a._debug,startXHR:function(){b.length>0&&(b.css("width","0%"),this.setProgressBar(b)),a._eventHandler.trigger("filemanager:api:uploading")},onComplete:function(b,c){a._eventHandler.trigger("filemanager:api:upload_done"),a._eventHandler.trigger("filemanager:view:ajax_upload",{response:c,directory:a._currentDirectory})},onAbort:function(){a._eventHandler.trigger("filemanager:api:upload_done")},onError:function(b,c,d,e,f){a._eventHandler.trigger("filemanager:api:upload_done"),f=JSON.parse(f),0!=f&&a._eventHandler.trigger("filemanager:api:error",{message:f.data.message,status:e,statuscode:d})}});if(c.setAbortBtn($("[data-fm-functionality=abort_upload]")),null===this._uploadFunctionalityReference){var d=$("[data-fm-functionality=upload_button]");0!==d.length&&d.on("click",function(){$("input[name=filemanager_upload]").trigger("click")}).on("keydown",function(a){13==a.keyCode&&(d.addClass("active"),a.preventDefault())}).on("keyup",function(a){13==a.keyCode&&(d.removeClass("active"),$("input[name=filemanager_upload]").trigger("click"))})}this._uploadFunctionalityReference=c},debug:function(a){"string"==typeof a&&(a="FileTreeView: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:api:error",function(b){a._apiCalled=!0,alert(b.message)}),this._eventHandler.register("filemanager:model:directories_changed",function(b){a._apiCalled=!0,a._searching=!1,a._searchQuery="",a.refreshDirectories(b)}),this._eventHandler.register("filemanager:view:search",function(b){a._apiCalled=!0,a._searching=!0,a._searchQuery=b.query}),this._eventHandler.register("filemanager:model:content_changed",function(b){a._apiCalled=!0,a.refreshContent(b)}),this._eventHandler.register("filemanager:model:path_changed",function(b){a._apiCalled=!0,a.refreshTitlebar(b)}),this._eventHandler.register("filemanager:model:select",function(b){var c={data:{file:b.file,selector:a._generateFileSelector(b.file)}};a._selectEvent(c)})}};var FilemanagerAPI=function(a){var b={debug:!1,api:{url:window.location.href,paths:{create:"/create",read:"",search:"/search",move:"/move",rename:"/rename","delete":"/delete",download:"/download"}}};this.options=$.extend(!0,b,a),this.init(this.options)};FilemanagerAPI.prototype={_debug:!1,_url:"",_path_create:"",_path_move:"",_path_rename:"",_path_read_directory:"",_path_delete:"",_path_search:"",_path_download:"",_eventHandler:!1,_disableRequests:!1,init:function(a){return null!==a&&"object"==typeof a&&(this._eventHandler=a.eventHandler,"undefined"!=typeof a.debug&&(this._debug=a.debug),null!==a.api&&"object"==typeof a.api&&("undefined"!=typeof a.api.url&&""!=a.api.url?this._url=a.api.url:(this._disableRequests=!0,console.error("NO APILINK FOUND !!!")),null!==a.api.paths&&"object"==typeof a.api.paths&&("undefined"!=typeof a.api.paths.move&&(this._path_move=a.api.paths.move),"undefined"!=typeof a.api.paths.rename&&(this._path_rename=a.api.paths.rename),"undefined"!=typeof a.api.paths.create&&(this._path_create=a.api.paths.create),"undefined"!=typeof a.api.paths["delete"]&&(this._path_delete=a.api.paths["delete"]),"undefined"!=typeof a.api.paths.read&&(this._path_read_directory=a.api.paths.read),"undefined"!=typeof a.api.paths.search&&(this._path_search=a.api.paths.search),"undefined"!=typeof a.api.paths.download&&(this._path_download=a.api.paths.download))),"string"==typeof a.api.startingDirectory&&this.read(a.api.startingDirectory)),this._registerEvents(),this.debug("Initializing"),this.debug(a),this},_sendRequest:function(a,b,c){"undefined"==typeof b&&(b="GET"),"object"!=typeof c&&(c={});var d=this;this._eventHandler.trigger("filemanager:api:loading");var e="",f=new RegExp("^(?:[a-z]+:)?//","i");if(f.test(a))e=a;else{var g="";g=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),e=g+a}return $.ajax({url:e,data:c,dataType:"json",method:b,self:d,beforeSend:function(a){d.debug("Sending "+this.method+" request to "+this.url+"...")}}).done(function(a){d._eventHandler.trigger("filemanager:api:done"),d.debug(a)}).fail(function(a,b,c){d._eventHandler.trigger("filemanager:api:done"),d.errorLog({statuscode:a.status,statustext:a.statusText,response:a.responseText})})},read:function(a){var b=this,c=this._url+this._path_read_directory;this._sendRequest(c,"GET",{directory:a}).done(function(c,d,e){b._eventHandler.trigger("filemanager:api:add_data",{contents:c.data.contents,directory:a})}).fail(function(a){b._handleApiError(a)})},search:function(a,b){var c=this,d=this._url+this._path_search;this._sendRequest(d,"GET",{directory:a,q:b}).done(function(d,e,f){c._eventHandler.trigger("filemanager:api:search_data",{contents:d.data.contents,directory:a,query:b})}).fail(function(a){c._handleApiError(a)})},move:function(a,b,c){var d=this,e=this._url+this._path_move,f=a+b;this._sendRequest(e,"POST",{filemanager_filepath:f,filemanager_newdirectory:c}).done(function(b,e,f){var g=[];if("object"==typeof b.data.changes)for(var h in b.data.changes)g.push(b.data.changes[h]);else g=b.data.changes;a!==c&&d._eventHandler.trigger("filemanager:api:refresh"),d._eventHandler.trigger("filemanager:api:update_data",{contents:g,directory:c})}).fail(function(a){d._handleApiError(a)})},rename:function(a,b,c){var d=this,e=this._url+this._path_rename;this._sendRequest(e,"POST",{filemanager_directory:a,filemanager_filename:b,filemanager_newfilename:c}).done(function(b,c,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;d._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){d._handleApiError(a)})},createDirectory:function(a,b){var c=this,d=this._url+this._path_create;this._sendRequest(d,"POST",{type:"directory",filemanager_directory:a,directory_name:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},"delete":function(a,b){var c=this,d=this._url+this._path_delete;this._sendRequest(d,"POST",{filemanager_directory:a,filemanager_filename:b}).done(function(b,d,e){var f=[];if("object"==typeof b.data.changes)for(var g in b.data.changes)f.push(b.data.changes[g]);else f=b.data.changes;c._eventHandler.trigger("filemanager:api:update_data",{contents:f,directory:a})}).fail(function(a){c._handleApiError(a)})},download:function(a){var b=this._url+this._path_download,c="?";b.indexOf(c)>-1&&(c="&"),window.location=b+c+"filemanager_path="+encodeURI(a)},uploadResponse:function(a,b){this._eventHandler.trigger("filemanager:api:done"),this._eventHandler.trigger("filemanager:api:update_data",{contents:b.data.changes,directory:a,selected:!0})},_handleApiError:function(a){var b=this,c=JSON.parse(a.responseText);b._eventHandler.trigger("filemanager:api:error",{message:c.data.message,status:c.status,statuscode:a.status})},debug:function(a){"string"==typeof a&&(a="FilemanagerAPI: "+a),this._debug&&console.log(a)},errorLog:function(a){console.error(a)},_registerEvents:function(){var a=this;this._eventHandler.register("filemanager:view:open",function(b){0==b.isSynchronized&&a.read(b.directory)}),this._eventHandler.register("filemanager:view:search",function(b){a.search(b.directory,b.query)}),this._eventHandler.register("filemanager:view:create",function(b){a.createDirectory(b.directory,b.name)}),this._eventHandler.register("filemanager:view:rename",function(b){a.rename(b.file.directory,b.file.name,b.newname)}),this._eventHandler.register("filemanager:view:move",function(b){a.move(b.file.directory,b.file.name,b.newlocation)}),this._eventHandler.register("filemanager:view:delete",function(b){a["delete"](b.file.directory,b.file.name)}),this._eventHandler.register("filemanager:view:ajax_upload",function(b){a.uploadResponse(b.directory,b.response)}),this._eventHandler.register("filemanager:view:download",function(b){a.download(b.file.path)})}};var FilemanagerEventHandler=function(a){var b={debug:!1};a=$.extend(!0,b,a),this.init(a)};FilemanagerEventHandler.prototype={_events:{},_debug:!1,init:function(a){null!==a&&"object"==typeof a&&"undefined"!=typeof a.debug&&(this._debug=a.debug)},hasEvent:function(a,b){if(this._events.hasOwnProperty(a))return!0;if(b)throw'No event registered for "'+a+'"';return!1},register:function(a,b){this.debug("Registering "+a),this._create(a),this._events[a].push(b)},unRegister:function(a){this.hasEvent(a,!0)&&delete this._events[a]},_create:function(a){this.hasEvent(a,!1)||(this._events[a]=[])},trigger:function(a){if(this.debug("Triggering "+a),this.hasEvent(a,!1)){var b=Array.prototype.slice.call(arguments,1);$.each(this._events[a],function(a,c){c.apply(c,b)}.bind(this))}},debug:function(a){this._debug&&console.log(a)}},function(){$.fn.filemanager=function(a){if("undefined"==typeof a&&(a={}),a.eventHandler=new FilemanagerEventHandler(a),null!==a.api&&"object"==typeof a.api)if("undefined"!=typeof a.api.url&&""!=a.api.url){this.data("event",a.eventHandler),this.data("view",new FileTreeView(a)),this.data("api",new FilemanagerAPI(a)),this.data("tree",new FileTree(a));var b=this,c={refresh:function(){return b.data("tree").refresh(),b},moveUpDirectory:function(){b.data("tree").moveUpDirectory()},createDirectory:function(){var a=b.data("tree").getCurrentPath();return b.data("view")._createDirectory(a),b},search:function(a){return b.data("tree").search(a),b},on:function(a,c){return b.data("event").register(a,c),b}};this.data("filemanager",c)}else console.error("Filemanager: NO APILINK FOUND - Aborting creation");else console.error("Filemanager: NO APILINK FOUND - Aborting creation");return this}}(jQuery);